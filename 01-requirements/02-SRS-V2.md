# üìã System Requirement Specification (SRS)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: System Analyst Team  
**D·ª±a tr√™n**: BRD v3.0, System Feature Tree v4.0, Access Control Tree v2.2  

---

## üìë M·ª•c l·ª•c t√†i li·ªáu

| Part       | T√™n ph·∫ßn                                                    | T√¨nh tr·∫°ng   | M√¥ t·∫£ ch·ª©c nƒÉng                                              |
| :--------- | :---------------------------------------------------------- | :----------- | :----------------------------------------------------------- |
| **Part00** | **M·ª•c l·ª•c t√†i li·ªáu**                                       | ‚úÖ Ho√†n th√†nh | Index v√† overview t·ªïng th·ªÉ v·ªÅ c·∫•u tr√∫c SRS                   |
| **Part01** | **Gi·ªõi thi·ªáu (Introduction)**                              | ‚è≥ S·∫Øp t·∫°o   | M·ª•c ti√™u SRS, ph·∫°m vi d·ª± √°n, ƒë·ªãnh nghƒ©a thu·∫≠t ng·ªØ, t√†i li·ªáu tham chi·∫øu |
| **Part02** | **T·ªïng quan h·ªá th·ªëng (Overall Description)**               | ‚è≥ S·∫Øp t·∫°o   | Stakeholders, system actors, use context, constraints v√† assumptions |
| **Part03** | **Ph·∫°m vi & M·ª•c ti√™u s·∫£n ph·∫©m (Scope and Objectives)**     | ‚è≥ S·∫Øp t·∫°o   | Business goals, success criteria, feature mapping theo MoSCoW |
| **Part04** | **Y√™u c·∫ßu ch·ª©c nƒÉng (Functional Requirements)**            | ‚è≥ S·∫Øp t·∫°o   | FR-001 ‚Üí FR-013: Campaign Management, Barcode, Landing Page, OTP, Redemption, Analytics, CRM, RBAC, User Portal, Ads Format |
| **Part05** | **Y√™u c·∫ßu phi ch·ª©c nƒÉng (Non-Functional Requirements)**    | ‚è≥ S·∫Øp t·∫°o   | Performance (100K RPM), scalability (10M users), security (ISO 27001), reliability (99.9% uptime), usability KPIs |
| **Part06** | **Ki·∫øn tr√∫c h·ªá th·ªëng (System Architecture & Components)**  | ‚è≥ S·∫Øp t·∫°o   | Microservices architecture, component diagram, technology stack, deployment architecture, CI/CD pipeline |
| **Part07** | **Thi·∫øt k·∫ø d·ªØ li·ªáu & CSDL (Data Design & Database Schema)** | ‚è≥ S·∫Øp t·∫°o   | ERD, collection design (MongoDB), relational schema (PostgreSQL), Redis caching strategy, data flow |
| **Part08** | **Thi·∫øt k·∫ø API & T√≠ch h·ª£p (API Design & Integration)**     | ‚è≥ S·∫Øp t·∫°o   | REST API endpoints, webhook specifications, error handling, rate limiting, third-party integrations |
| **Part09** | **Use Case chi ti·∫øt (Detailed Use Cases)**                 | ‚è≥ S·∫Øp t·∫°o   | 8 use cases ch√≠nh v·ªõi flow steps, alternative scenarios, exception handling |
| **Part10** | **Giao di·ªán & Wireframes (UI/UX Design)**                  | ‚è≥ S·∫Øp t·∫°o   | User experience flow, wireframes, UI components, accessibility standards, mobile responsiveness |
| **Part11** | **B·∫£o m·∫≠t & Tu√¢n th·ªß (System Security & Compliance)**      | ‚è≥ S·∫Øp t·∫°o   | Authentication (OAuth2), authorization (RBAC), data encryption, GDPR/PDPA compliance, disaster recovery |
| **Part12** | **Ki·ªÉm th·ª≠ hi·ªáu nƒÉng & t·∫£i (Performance & Load Testing)**  | ‚è≥ S·∫Øp t·∫°o   | Load testing scenarios (JMeter/K6), performance benchmarks, stress testing procedures |
| **Part13** | **K·∫ø ho·∫°ch ki·ªÉm th·ª≠ t·ªïng th·ªÉ (System & UAT Testing)**      | ‚è≥ S·∫Øp t·∫°o   | Test strategy, test cases design, UAT matrix, regression testing, quality gates |
| **Part14** | **Qu·∫£n l√Ω c·∫•u h√¨nh & tri·ªÉn khai (Configuration & Deployment)** | ‚è≥ S·∫Øp t·∫°o | Environment setup, version control strategy, CI/CD workflows, deployment procedures |
| **Part15** | **K·∫ø ho·∫°ch b·∫£o tr√¨ & v·∫≠n h√†nh (Maintenance & Monitoring)** | ‚è≥ S·∫Øp t·∫°o   | System monitoring, logging strategy, incident response procedures, maintenance schedules |
| **Part16** | **Ph·ª• l·ª•c & T√†i li·ªáu tham chi·∫øu (Appendices)**             | ‚è≥ Cu·ªëi c√πng | Glossary, technical diagrams, requirements traceability matrix, change log |

---

## üéØ M·ª•c ti√™u t√†i li·ªáu SRS

T√†i li·ªáu SRS n√†y ƒë∆∞·ª£c x√¢y d·ª±ng ƒë·ªÉ:

1. **Cung c·∫•p ƒë·∫∑c t·∫£ k·ªπ thu·∫≠t chi ti·∫øt** cho ƒë·ªôi ph√°t tri·ªÉn Product Sampling Platform
2. **ƒê·∫£m b·∫£o alignment** gi·ªØa business requirements (BRD) v√† technical implementation
3. **H∆∞·ªõng d·∫´n thi·∫øt k·∫ø v√† ph√°t tri·ªÉn** c√°c module h·ªá th·ªëng theo chu·∫©n
4. **ƒê·ªãnh nghƒ©a acceptance criteria** cho testing v√† quality assurance
5. **T·∫°o baseline** cho project management v√† change control

## üìê Ph∆∞∆°ng ph√°p ti·∫øp c·∫≠n

- **Chu·∫©n tham chi·∫øu**: IEEE 830-1998 Software Requirements Specification
- **Ph∆∞∆°ng ph√°p**: Agile-compatible, iterative refinement
- **Traceability**: Mapping t·ª´ BRD ‚Üí SRS ‚Üí Design ‚Üí Code ‚Üí Test
- **Validation**: Stakeholder review sau m·ªói Part

---

**T√¨nh tr·∫°ng**: Part00 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part01 - Introduction  
**Ng∆∞·ªùi review**: Product Manager, System Architect, Development Lead

# üìã SRS Part01 - Gi·ªõi thi·ªáu (Introduction)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: System Analyst Team  

---

## 1.1 M·ª•c ƒë√≠ch t√†i li·ªáu

### 1.1.1 T·ªïng quan
T√†i li·ªáu System Requirement Specification (SRS) n√†y m√¥ t·∫£ chi ti·∫øt c√°c y√™u c·∫ßu k·ªπ thu·∫≠t cho vi·ªác ph√°t tri·ªÉn **Product Sampling Platform (PSS)** - n·ªÅn t·∫£ng qu·∫£n l√Ω v√† ph√¢n ph·ªëi s·∫£n ph·∫©m d√πng th·ª≠ th√¥ng minh. 

SRS ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n Business Requirement Document (BRD) ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát, nh·∫±m chuy·ªÉn ƒë·ªïi c√°c y√™u c·∫ßu kinh doanh th√†nh ƒë·∫∑c t·∫£ k·ªπ thu·∫≠t chi ti·∫øt cho ƒë·ªôi ph√°t tri·ªÉn.

### 1.1.2 ƒê·ªëi t∆∞·ª£ng s·ª≠ d·ª•ng
- **System Architect**: Thi·∫øt k·∫ø ki·∫øn tr√∫c h·ªá th·ªëng
- **Development Team**: Backend, Frontend, DevOps engineers
- **QA Team**: Thi·∫øt k·∫ø test cases v√† quality assurance
- **Product Manager**: Validation v√† acceptance criteria
- **Business Stakeholders**: Review v√† sign-off requirements

### 1.1.3 M·ª•c ti√™u ch√≠nh
- ƒê·ªãnh nghƒ©a r√µ r√†ng functional v√† non-functional requirements
- Cung c·∫•p ƒë·∫∑c t·∫£ k·ªπ thu·∫≠t ƒë·ªÉ estimate effort v√† timeline
- T·∫°o baseline cho change management v√† version control
- ƒê·∫£m b·∫£o traceability t·ª´ business needs ƒë·∫øn technical implementation

---

## 1.2 Ph·∫°m vi d·ª± √°n

### 1.2.1 T√™n s·∫£n ph·∫©m
**Product Sampling Platform (PSS)** - N·ªÅn t·∫£ng qu·∫£n l√Ω ph√¢n ph·ªëi m·∫´u s·∫£n ph·∫©m th√¥ng minh

### 1.2.2 Ph·∫°m vi ch·ª©c nƒÉng (In-scope)
**MVP Phase (Q1-Q2 2025):**
- Qu·∫£n l√Ω Campaign v√† Barcode/Voucher  
- Landing Page v·ªõi form thu th·∫≠p d·ªØ li·ªáu kh√°ch h√†ng
- X√°c th·ª±c OTP (SMS/Email) ch·ªëng spam
- C·∫•p ph√°t barcode/voucher single-use
- Redemption t·∫°i POS v·ªõi offline sync
- Dashboard analytics v√† b√°o c√°o realtime
- T√≠ch h·ª£p CRM c∆° b·∫£n (webhook/API)
- Ph√¢n quy·ªÅn RBAC cho 6 roles
- User Portal (PWA) cho kh√°ch h√†ng cu·ªëi
- Qu·∫£n l√Ω Ads Format v·ªõi dynamic QR

**Advanced Phase (Q3 2025-Q4 2026):**
- Fraud detection v√† trust scoring  
- Inventory reconciliation
- A/B testing v√† dynamic offers
- Support ticketing system
- Multi-market localization

### 1.2.3 Ph·∫°m vi k·ªπ thu·∫≠t
- **Platform**: Web-based (PWA), microservices architecture
- **Geographic**: Vi·ªát Nam (pilot) ‚Üí Southeast Asia (expansion)
- **Scale**: H·ªó tr·ª£ 10K verified users (MVP) ‚Üí 10M users (long-term)
- **Integration**: CRM, POS, SMS/Email providers, Analytics tools

### 1.2.4 Ngo√†i ph·∫°m vi (Out-of-scope)
- Logistics th·ª±c t·∫ø (v·∫≠n chuy·ªÉn m·∫´u h√†ng)
- Mobile native apps (ch·ªâ PWA)
- Blockchain/tokenization (Phase 3)
- Payment processing cho mua h√†ng
- ERP qu·∫£n l√Ω kho h√†ng ph·ª©c t·∫°p

---

## 1.3 ƒê·ªãnh nghƒ©a v√† thu·∫≠t ng·ªØ

| Thu·∫≠t ng·ªØ | ƒê·ªãnh nghƒ©a |
|-----------|------------|
| **Product Sampling** | Vi·ªác ph√¢n ph·ªëi s·∫£n ph·∫©m d√πng th·ª≠ mi·ªÖn ph√≠ ƒë·ªÉ thu th·∫≠p d·ªØ li·ªáu kh√°ch h√†ng v√† tƒÉng brand awareness |
| **Campaign** | Chi·∫øn d·ªãch ph√¢n ph·ªëi m·∫´u s·∫£n ph·∫©m v·ªõi m·ª•c ti√™u, th·ªùi gian v√† ng√¢n s√°ch c·ª• th·ªÉ |
| **Barcode/Voucher** | M√£ ƒë·ªãnh danh duy nh·∫•t (QR code/barcode) cho ph√©p kh√°ch h√†ng ƒë·ªïi l·∫•y m·∫´u s·∫£n ph·∫©m |
| **Landing Page** | Trang web thu th·∫≠p th√¥ng tin kh√°ch h√†ng sau khi scan QR code |
| **OTP (One-Time Password)** | M√£ x√°c th·ª±c m·ªôt l·∫ßn g·ª≠i qua SMS/Email ƒë·ªÉ verify kh√°ch h√†ng |
| **Ads Format** | ƒê·ªãnh d·∫°ng qu·∫£ng c√°o (poster, flyer, banner) ch·ª©a QR code c·ªßa campaign |
| **Redemption** | Qu√° tr√¨nh ƒë·ªïi voucher l·∫•y m·∫´u s·∫£n ph·∫©m t·∫°i ƒëi·ªÉm b√°n |
| **POS (Point of Sale)** | ƒêi·ªÉm b√°n h√†ng/ƒë·ªïi qu√† (c·ª≠a h√†ng, booth s·ª± ki·ªán) |
| **Verified User** | Kh√°ch h√†ng ƒë√£ ho√†n th√†nh x√°c th·ª±c OTP v√† cung c·∫•p th√¥ng tin ch√≠nh x√°c |
| **Funnel** | Quy tr√¨nh t·ª´ scan QR ‚Üí ƒëi·ªÅn form ‚Üí verify OTP ‚Üí nh·∫≠n voucher ‚Üí redeem |
| **RBAC** | Role-Based Access Control - ph√¢n quy·ªÅn d·ª±a tr√™n vai tr√≤ |
| **PWA** | Progressive Web App - ·ª©ng d·ª•ng web c√≥ tr·∫£i nghi·ªám nh∆∞ mobile app |
| **CPL** | Cost Per Lead - chi ph√≠ ƒë·ªÉ thu th·∫≠p m·ªôt kh√°ch h√†ng ti·ªÅm nƒÉng |
| **ROI** | Return on Investment - t·ª∑ su·∫•t sinh l·ªùi c·ªßa chi·∫øn d·ªãch |

---

## 1.4 T√†i li·ªáu tham chi·∫øu

### 1.4.1 T√†i li·ªáu d·ª± √°n
| T√†i li·ªáu | Phi√™n b·∫£n | Ng√†y | M√¥ t·∫£ |
|----------|-----------|------|-------|
| **Problem.md** | 1.0 | 2025-10-16 | ƒê·ªãnh nghƒ©a b√†i to√°n v√† ph√¢n lo·∫°i requirements theo MoSCoW |
| **Product-Sampling-Vision-and-Strategy Document.md** | 1.0 | 2025-10-16 | T·∫ßm nh√¨n chi·∫øn l∆∞·ª£c, c∆° h·ªôi th·ªã tr∆∞·ªùng v√† go-to-market strategy |
| **01-BRD.md** | 3.0 | 2025-10-17 | Business Requirement Document v·ªõi financial model v√† stakeholder analysis |
| **System_Feature_Tree_Grok.md** | 4.0 | 2025-10-16 | C√¢y ch·ª©c nƒÉng h·ªá th·ªëng v·ªõi user stories chi ti·∫øt |
| **Access_Control_Tree_Grok.md** | 2.2 | 2025-10-16 | Ph√¢n quy·ªÅn RBAC v√† access control matrix |

### 1.4.2 Chu·∫©n k·ªπ thu·∫≠t tham chi·∫øu
- **IEEE 830-1998**: Software Requirements Specification standard
- **ISO/IEC 25010**: Systems and software Quality Requirements and Evaluation (SQuaRE)
- **OWASP Top 10**: Web application security standards
- **GDPR/PDPA**: Data protection and privacy regulations
- **ISO 27001**: Information security management standards
- **REST API Design Guidelines**: RESTful web services best practices

### 1.4.3 Technology Standards
- **OpenAPI 3.0**: API specification format
- **OAuth 2.0 / OpenID Connect**: Authentication and authorization
- **JWT (RFC 7519)**: JSON Web Token standard
- **SMS OTP (RFC 4226/6238)**: Time-based One-time Password
- **QR Code (ISO/IEC 18004)**: 2D barcode standard

---

## 1.5 T·ªïng quan c·∫•u tr√∫c t√†i li·ªáu

T√†i li·ªáu SRS ƒë∆∞·ª£c t·ªï ch·ª©c th√†nh 16 ph·∫ßn ch√≠nh:

**Ph·∫ßn Foundation (Part 01-03):**
- Introduction, Overall Description, Scope & Objectives

**Ph·∫ßn Core Requirements (Part 04-05):**
- Functional Requirements, Non-Functional Requirements  

**Ph·∫ßn Technical Design (Part 06-08):**
- System Architecture, Data Design, API Design

**Ph·∫ßn Implementation (Part 09-11):**
- Use Cases, UI/UX Design, Security & Compliance

**Ph·∫ßn Quality Assurance (Part 12-13):**
- Performance Testing, System Testing

**Ph·∫ßn Operations (Part 14-16):**
- Configuration & Deployment, Maintenance & Monitoring, Appendices

---

## 1.6 Quy tr√¨nh ph√™ duy·ªát v√† qu·∫£n l√Ω thay ƒë·ªïi

### 1.6.1 Review Process
1. **Technical Review**: System Architect + Lead Developer
2. **Business Review**: Product Manager + Key Stakeholders  
3. **Final Approval**: Project Steering Committee

### 1.6.2 Change Management
- M·ªçi thay ƒë·ªïi requirements ph·∫£i ƒë∆∞·ª£c document v√† approve
- Impact analysis cho technical v√† business implications
- Version control v·ªõi semantic versioning (Major.Minor.Patch)
- Traceability matrix c·∫≠p nh·∫≠t theo changes

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- Business Requirement Document (BRD v3.0)
- System Feature Tree (v4.0) 
- Access Control Tree (v2.2)
- Problem Definition Document (v1.0)
- Product Vision & Strategy Document (v1.0)

**T√¨nh tr·∫°ng**: Part01 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part02 - Overall Description  
**Ng∆∞·ªùi review**: Product Manager, System Architect

# üìã SRS Part02 - T·ªïng quan h·ªá th·ªëng (Overall Description)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: System Analyst Team  

---

## 2.1 B·ªëi c·∫£nh s·∫£n ph·∫©m

### 2.1.1 V·∫•n ƒë·ªÅ kinh doanh hi·ªán t·∫°i
D·ª±a tr√™n ph√¢n t√≠ch trong **Problem.md** v√† **01-BRD.md**, c√°c th∆∞∆°ng hi·ªáu FMCG ƒëang g·∫∑p ph·∫£i nh·ªØng th√°ch th·ª©c sau:

- **Chi ph√≠ ph√¢n ph·ªëi cao**: Logistics > gi√° tr·ªã qu√† t·∫∑ng (~1 USD)
- **Spam v√† gian l·∫≠n**: ƒêƒÉng k√Ω ·∫£o, bot l√†m sai l·ªách d·ªØ li·ªáu kh√°ch h√†ng
- **Thi·∫øu ƒëo l∆∞·ªùng**: Kh√≥ tracking ROI, funnel conversion, hi·ªáu qu·∫£ campaign
- **Qu·∫£n l√Ω ph·ª©c t·∫°p**: Thi·∫øu c√¥ng c·ª• t·ª± ƒë·ªông h√≥a quy tr√¨nh sampling

### 2.1.2 Gi·∫£i ph√°p t·ªïng th·ªÉ
Product Sampling Platform l√† n·ªÅn t·∫£ng **"Sampling Network-as-a-Service"** gi√∫p:
- T·ªëi ∆∞u ph√¢n ph·ªëi qua m·∫°ng l∆∞·ªõi retail nodes ƒë√£ verify
- Thu th·∫≠p d·ªØ li·ªáu verified v·ªõi OTP authentication
- Cung c·∫•p analytics realtime v√† CRM integration
- Gi·∫£m cost-per-verified-lead xu·ªëng <0.4 USD

### 2.1.3 V·ªã tr√≠ trong h·ªá sinh th√°i
```
Brand/Agency ‚Üí PSS Platform ‚Üí Retail Network ‚Üí End Users
     ‚Üë              ‚Üì              ‚Üì           ‚Üì
   CRM/ERP ‚Üê Analytics Dashboard ‚Üê POS System ‚Üê User Portal
```

---

## 2.2 Ch·ª©c nƒÉng s·∫£n ph·∫©m t·ªïng quan

### 2.2.1 Core Functions (d·ª±a tr√™n System_Feature_Tree_Grok.md v4.0)

**Qu·∫£n l√Ω Campaign & Content:**
- T·∫°o v√† qu·∫£n l√Ω campaign v·ªõi barcode pool, location targeting
- Upload v√† config ads format (13 lo·∫°i: poster, flyer, digital banner...)
- Dynamic QR code generation v·ªõi UTM tracking

**Thu th·∫≠p & X√°c th·ª±c d·ªØ li·ªáu:**
- Landing page v·ªõi form thu th·∫≠p (t√™n, email, SƒêT, preferences)
- OTP verification (SMS/Email) v·ªõi anti-fraud measures
- Consent management tu√¢n th·ªß GDPR/PDPA

**Ph√¢n ph·ªëi & Redemption:**
- C·∫•p ph√°t voucher/barcode single-use sau verification
- POS integration cho redemption t·∫°i stores/booths
- Offline sync cho retail nodes kh√¥ng c√≥ internet ·ªïn ƒë·ªãnh

**Analytics & Integration:**
- Funnel tracking realtime (scan ‚Üí submit ‚Üí verify ‚Üí redeem)
- CRM sync v·ªõi webhook/API (HubSpot, Salesforce)
- User portal cho customer experience

### 2.2.2 Advanced Functions (Phase 2)
- Fraud detection v·ªõi ML-based scoring
- Inventory reconciliation v√† settlement
- A/B testing cho campaign optimization
- Multi-market localization

---

## 2.3 Ng∆∞·ªùi d√πng v√† ƒë·∫∑c ƒëi·ªÉm

### 2.3.1 System Actors (d·ª±a tr√™n Access_Control_Tree_Grok.md v2.2)

| Actor | M√¥ t·∫£ | ƒê·∫∑c ƒëi·ªÉm s·ª≠ d·ª•ng | Quy·ªÅn truy c·∫≠p |
|-------|-------|------------------|----------------|
| **Admin** | Qu·∫£n tr·ªã h·ªá th·ªëng to√†n c·ª•c | - IT background<br>- To√†n quy·ªÅn config<br>- Troubleshooting | Full access to√†n b·ªô modules |
| **Group Admin** | Qu·∫£n l√Ω nh√≥m brands/agencies | - Marketing background<br>- Qu·∫£n l√Ω multi-brand<br>- Strategy planning | Group-scoped permissions |
| **Customer Account** | Brand manager/Agency account | - Campaign management<br>- ROI tracking<br>- Data analysis | Own campaigns only |
| **Serving Account** | Staff t·∫°i retail nodes | - Limited tech skills<br>- Mobile/tablet usage<br>- Quick scan operations | Redemption tool only |
| **Auditor** | Compliance v√† audit | - Legal/compliance background<br>- Read-only access<br>- Report generation | View logs v√† compliance reports |
| **User Role (End User)** | Kh√°ch h√†ng cu·ªëi | - Consumer behavior<br>- Mobile-first<br>- Instant gratification | User portal PWA |

### 2.3.2 User Environment
- **Retail Staff**: Android/iOS tablets, intermittent internet
- **Brand Managers**: Desktop/laptop, stable internet, multiple campaigns
- **End Users**: Smartphones, social media savvy, instant mobile experience
- **Admin/Auditors**: Desktop workstations, enterprise network

---

## 2.4 Constraints v√† r√†ng bu·ªôc

### 2.4.1 Technical Constraints
**Performance Requirements:**
- API gateway: 100,000 requests/ph√∫t (peak load)
- Response time: <3 gi√¢y cho dashboard
- Database: H·ªó tr·ª£ 10M users concurrent

**Technology Stack:**
- Backend: Node.js/Go microservices  
- Frontend: React PWA
- Database: MongoDB (documents), PostgreSQL (relational), Redis (cache)
- Cloud: AWS/GCP v·ªõi multi-region deployment

**Integration Constraints:**
- CRM: RESTful API v·ªõi rate limiting
- SMS Provider: Twilio/MessageBird v·ªõi delivery SLA
- POS: Scandit SDK ho·∫∑c generic barcode scanners

### 2.4.2 Business Constraints
**Budget v√† Timeline:**
- MVP development: 6 th√°ng, 500K USD
- Scale phase: 12 th√°ng b·ªï sung
- Team size: 8 developers + 2 QA

**Regulatory Compliance:**
- GDPR/PDPA cho data protection
- PCI-DSS n·∫øu c√≥ payment processing
- Local telco regulations cho SMS OTP

**Operational Constraints:**
- 99.9% uptime SLA
- Data retention: 7 nƒÉm cho audit
- Backup v√† disaster recovery: RTO < 4 hours, RPO < 1 hour

---

## 2.5 Assumptions v√† dependencies

### 2.5.1 Business Assumptions (t·ª´ 01-BRD.md v3.0)
- **Market Adoption**: Brands s·∫µn s√†ng chi 12-120 tri·ªáu VND/th√°ng cho SaaS
- **Retail Partnership**: Circle K, GS25 h·ª£p t√°c ph√¢n ph·ªëi
- **User Behavior**: 90%+ smartphone adoption, willingness ƒë·ªÉ share data v·ªõi incentives
- **Competition**: 18-24 th√°ng tr∆∞·ªõc khi competitor l·ªõn v√†o th·ªã tr∆∞·ªùng

### 2.5.2 Technical Assumptions
- **Internet Connectivity**: 3G/4G coverage ·ªïn ƒë·ªãnh t·∫°i urban areas
- **Device Compatibility**: Android 8+, iOS 12+ cho PWA
- **Third-party APIs**: Uptime 99.5%+ cho critical services (SMS, CRM)
- **Scaling**: Cloud auto-scaling hi·ªáu qu·∫£ cho traffic spikes

### 2.5.3 Dependencies
**External Dependencies:**
- Twilio/MessageBird cho SMS OTP
- HubSpot/Salesforce APIs cho CRM sync  
- Scandit SDK cho barcode scanning
- GA4/Meta Pixel cho tracking
- Zendesk cho customer support

**Internal Dependencies:**
- UI/UX design completion tr∆∞·ªõc frontend development
- Database schema finalization tr∆∞·ªõc backend APIs
- Security audit completion tr∆∞·ªõc production deployment

---

## 2.6 Ki·∫øn tr√∫c h·ªá th·ªëng c·∫•p cao

### 2.6.1 System Context Diagram
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Brand/Agency  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  PSS Platform        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Retail Network ‚îÇ
‚îÇ   - Dashboard   ‚îÇ    ‚îÇ  - Campaign Mgmt     ‚îÇ    ‚îÇ  - POS Systems  ‚îÇ
‚îÇ   - Analytics   ‚îÇ    ‚îÇ  - User Portal       ‚îÇ    ‚îÇ  - Staff Apps   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  - Admin Console     ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ            ‚îÇ            ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ   CRM/ERP   ‚îÇ ‚îÇ   SMS/Email ‚îÇ ‚îÇ  Analytics  ‚îÇ
          ‚îÇ   Systems   ‚îÇ ‚îÇ   Providers ‚îÇ ‚îÇ   Tools     ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.6.2 Deployment Architecture
- **Multi-tier**: Presentation ‚Üí Application ‚Üí Data layers
- **Microservices**: Independent deployable services
- **Cloud-native**: Container-based v·ªõi Kubernetes orchestration
- **Multi-region**: Primary (VN), DR (Singapore)

---

## 2.7 M√¥ h√¨nh d·ªØ li·ªáu c·∫•p cao

### 2.7.1 Core Entities
- **Campaign**: Th√¥ng tin campaign, timeline, budget
- **Barcode**: Voucher codes v√† tr·∫°ng th√°i lifecycle  
- **User**: Profile kh√°ch h√†ng v·ªõi verified status
- **Location**: Retail nodes v√† geo-targeting
- **Analytics**: Event logs v√† funnel metrics

### 2.7.2 Data Flow
```
QR Scan ‚Üí Landing Page ‚Üí Form Submit ‚Üí OTP Verify ‚Üí Barcode Issue ‚Üí Redemption ‚Üí Analytics
```

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- Business Requirement Document (01-BRD.md v3.0) - Stakeholders, Business constraints
- System Feature Tree (System_Feature_Tree_Grok.md v4.0) - Functional overview
- Access Control Tree (Access_Control_Tree_Grok.md v2.2) - User roles v√† permissions
- Problem Definition (Problem.md v1.0) - Business context v√† challenges
- Vision & Strategy Document (Product-Sampling-Vision-and-Strategy Document.md v1.0) - Market positioning

**T√¨nh tr·∫°ng**: Part02 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part03 - Scope and Objectives  
**Ng∆∞·ªùi review**: System Architect, Product Manager
# üìã SRS Part03 - Ph·∫°m vi v√† m·ª•c ti√™u s·∫£n ph·∫©m (Scope and Objectives)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: System Analyst Team  

---

## 3.1 M·ª•c ti√™u kinh doanh

### 3.1.1 Vision Statement (t·ª´ Product-Sampling-Vision-and-Strategy Document.md)
> "Transform product sampling from a cost center into a data-driven growth engine"

Product Sampling Platform h∆∞·ªõng t·ªõi tr·ªü th√†nh **n·ªÅn t·∫£ng h·∫° t·∫ßng sampling to√†n c·∫ßu**, n∆°i m·ªçi th∆∞∆°ng hi·ªáu c√≥ th·ªÉ:
- Tri·ªÉn khai chi·∫øn d·ªãch sampling ƒëa k√™nh trong v√†i ph√∫t
- X√°c th·ª±c kh√°ch h√†ng v√† ch·ªëng gian l·∫≠n t·ª± ƒë·ªông  
- Nh·∫≠n insight chi ti·∫øt v·ªÅ hi·ªáu qu·∫£ campaign theo th·ªùi gian th·ª±c
- D·ª± ƒëo√°n ROI chi·∫øn d·ªãch b·∫±ng AI

### 3.1.2 Business Objectives

**Ng·∫Øn h·∫°n (2025 - MVP):**
- Tri·ªÉn khai th√†nh c√¥ng t·∫°i Vi·ªát Nam v·ªõi 25 brands
- X·ª≠ l√Ω 1M sample distribution 
- Thu th·∫≠p 50K verified leads/th√°ng
- ƒê·∫°t doanh thu 5.76 t·ª∑ VND

**Trung h·∫°n (2026 - Scale):**
- M·ªü r·ªông Thailand, Indonesia v·ªõi 80 brands
- X·ª≠ l√Ω 3M users active
- ƒê·∫°t doanh thu 26.88 t·ª∑ VND
- Net Promoter Score >60

**D√†i h·∫°n (2027 - Market Leadership):**
- D·∫´n ƒë·∫ßu Southeast Asia v·ªõi 200 brands
- Ph·ª•c v·ª• 10M users
- ƒê·∫°t doanh thu 67.2 t·ª∑ VND v·ªõi l·ª£i nhu·∫≠n 21.312 t·ª∑ VND
- Chu·∫©n b·ªã exit strategy (M&A/IPO)

### 3.1.3 Success Metrics (t·ª´ 01-BRD.md v3.0)

| Category | KPI | Target Value | Measurement Method |
|----------|-----|--------------|-------------------|
| **Cost Efficiency** | Cost per verified lead | ‚â§ 0.4 USD | Platform analytics |
| **User Experience** | Form completion rate | ‚â• 90% | Funnel tracking |
| **Data Quality** | OTP verification success | ‚â• 95% | System logs |
| **Fraud Prevention** | Fraud rate | ‚â§ 5% | ML detection algorithms |
| **System Performance** | Platform uptime | ‚â• 99.9% | Monitoring tools |
| **Business Growth** | Brand retention rate | ‚â• 85% | Customer success tracking |
| **User Engagement** | Redemption rate | ‚â• 85% | POS integration data |

---

## 3.2 Ph·∫°m vi ch·ª©c nƒÉng

### 3.2.1 Must-Have Features (Core MVP - d·ª±a tr√™n System_Feature_Tree_Grok.md v4.0)

**Campaign & Content Management:**
- **FR-001**: Qu·∫£n l√Ω Campaign v·ªõi barcode assignment, location targeting, UTM tracking
- **FR-002**: Qu·∫£n l√Ω Barcode/Voucher v·ªõi single-use validation v√† reconciliation  
- **FR-003**: Qu·∫£n l√Ω Ads Format v·ªõi 13 lo·∫°i format v√† dynamic QR generation

**Customer Data Collection:**
- **FR-004**: Landing Page v·ªõi responsive form, quiz integration, consent management
- **FR-005**: OTP Verification v·ªõi SMS/Email, rate limiting, fraud detection
- **FR-006**: C·∫•p ph√°t Barcode personalized v·ªõi Apple Wallet integration

**Distribution & Analytics:**
- **FR-007**: POS Integration v·ªõi offline sync, atomic redemption
- **FR-008**: Analytics Dashboard v·ªõi funnel tracking, export capabilities
- **FR-009**: CRM Integration v·ªõi webhook/API sync, GDPR compliance

**Security & Management:**
- **FR-010**: Access Control v·ªõi 6 roles RBAC, audit trails
- **FR-011**: User Portal PWA v·ªõi history tracking, notification system

### 3.2.2 Should-Have Features (Advanced Phase 2)

**Advanced Operations:**
- Inventory reconciliation v·ªõi batch tracking
- Retailer portal v·ªõi store management
- Fraud detection v·ªõi ML-based scoring
- A/B testing framework cho campaign optimization

**Enhanced Experience:**  
- Support ticketing system
- Multi-language localization
- Advanced analytics v·ªõi predictive insights
- Consent management hub

### 3.2.3 Nice-to-Have Features (Future Phase 3)

**AI & Intelligence:**
- Predictive analytics cho demand forecasting
- AI-driven personalization
- Marketplace cho brand co-sampling
- Sustainability tracking

**Advanced Integration:**
- Blockchain traceability (optional)
- AR integration cho virtual try-on
- Voice-activated campaigns
- Real-time attribution v·ªõi sales data

---

## 3.3 Ph·∫°m vi k·ªπ thu·∫≠t

### 3.3.1 Technology Scope

**Platform Architecture:**
- **Backend**: Microservices v·ªõi Node.js/Go
- **Frontend**: React PWA cho cross-platform compatibility
- **Database**: MongoDB (documents), PostgreSQL (relational), Redis (cache)
- **Cloud**: AWS/GCP v·ªõi multi-region deployment
- **API**: RESTful services v·ªõi OpenAPI 3.0 specification

**Integration Scope:**
- **CRM Systems**: HubSpot, Salesforce, custom APIs
- **Communication**: Twilio, MessageBird cho SMS/Email
- **Analytics**: GA4, Meta Pixel, custom tracking
- **POS Systems**: Scandit SDK, generic barcode scanners
- **Support**: Zendesk integration cho ticketing

### 3.3.2 Performance Scope

**Scalability Targets:**
- **Concurrent Users**: 10K (MVP) ‚Üí 100K (Scale) ‚Üí 1M (Long-term)
- **API Throughput**: 100K requests/minute peak load
- **Data Storage**: 100GB (Year 1) ‚Üí 10TB (Year 3)
- **Geographic**: Vietnam ‚Üí ASEAN ‚Üí Global expansion capability

**Performance Benchmarks:**
- **Response Time**: <3s cho dashboard loads
- **API Latency**: <500ms cho core operations  
- **Mobile Performance**: <2s cho PWA load times
- **Offline Capability**: 24h local storage cho retail nodes

### 3.3.3 Security Scope

**Data Protection:**
- PII encryption v·ªõi AES-256
- GDPR/PDPA compliance framework
- ISO 27001-aligned security controls
- SOC 2 Type II audit readiness

**Access Control:**
- OAuth 2.0/OpenID Connect authentication
- JWT-based session management
- Role-based access control (RBAC)
- Multi-factor authentication cho admin roles

---

## 3.4 Ph·∫°m vi ng∆∞·ªùi d√πng

### 3.4.1 Primary Users

**Brand Managers/Marketing Teams:**
- **Quantity**: 100-500 users (Year 1-3)
- **Geography**: Vietnam ‚Üí Thailand, Indonesia, Philippines
- **Use Cases**: Campaign creation, analytics review, ROI tracking
- **Technical Proficiency**: Medium, c·∫ßn UI intuitive

**Retail Staff/Serving Accounts:**  
- **Quantity**: 1K-10K users (store staff)
- **Geography**: Urban centers v·ªõi retail network
- **Use Cases**: Barcode scanning, redemption processing
- **Technical Proficiency**: Basic, c·∫ßn mobile-optimized tools

**End Consumers:**
- **Quantity**: 50K-10M verified users  
- **Demographics**: 18-45 tu·ªïi, smartphone users, brand conscious
- **Use Cases**: Sample collection, profile management, history tracking
- **Technical Proficiency**: Varied, c·∫ßn PWA user-friendly

### 3.4.2 Secondary Users

**System Administrators:**
- Platform management, troubleshooting, system configuration
- Y√™u c·∫ßu technical expertise cao

**Auditors/Compliance:**
- Compliance monitoring, audit trail review, regulatory reporting  
- Y√™u c·∫ßu read-only access v·ªõi detailed logging

---

## 3.5 R√†ng bu·ªôc v√† gi·ªõi h·∫°n

### 3.5.1 Business Constraints (t·ª´ 01-BRD.md v3.0)

**Budget Constraints:**
- Total development budget: 122.64 t·ª∑ VND (3 years)
- MVP development: 36 t·ª∑ VND (6 months)
- Operational costs: <40% revenue sau Year 2

**Timeline Constraints:**
- MVP launch: Q2 2025 (6 months development)
- Scale phase: Q3 2025 - Q4 2026  
- Regional expansion: 18 months sau MVP

**Regulatory Constraints:**
- GDPR compliance cho EU customers
- PDPA compliance cho ASEAN markets
- Local telecommunications regulations cho SMS OTP
- PCI-DSS n·∫øu c√≥ payment processing

### 3.5.2 Technical Constraints

**Performance Constraints:**
- 99.9% uptime SLA requirement
- <3s response time cho critical operations
- Support cho 100K concurrent users (peak)
- Mobile-first design v·ªõi PWA compatibility

**Integration Constraints:**
- RESTful API compatibility v·ªõi existing CRM systems
- Offline-first design cho intermittent connectivity
- Multi-language support cho regional expansion
- Cross-browser compatibility (Chrome, Safari, Firefox)

### 3.5.3 Operational Constraints

**Scalability Constraints:**
- Auto-scaling capability cho traffic spikes
- Database sharding strategy cho large datasets  
- CDN deployment cho global performance
- Disaster recovery v·ªõi <4h RTO, <1h RPO

**Maintenance Constraints:**
- Zero-downtime deployment capability
- Automated backup v√† recovery procedures
- 24/7 monitoring v·ªõi alerting system
- Security patch deployment trong 48h

---

## 3.6 Feature Prioritization Matrix

### 3.6.1 MoSCoW Analysis (t·ª´ Problem.md v1.0)

| Priority | Features | Business Value | Development Effort | Timeline |
|----------|----------|----------------|-------------------|----------|
| **Must-Have** | Campaign Management, OTP Verification, POS Integration | Cao | Medium | Q1-Q2 2025 |
| **Should-Have** | Fraud Detection, A/B Testing, Inventory Reconciliation | Medium-High | Medium-High | Q3 2025-Q1 2026 |
| **Could-Have** | Advanced Analytics, Multi-language Support | Medium | Medium | Q2-Q4 2026 |
| **Won't-Have** | AI Personalization, Blockchain, AR Integration | Low-Medium | High | Phase 3 (2027+) |

### 3.6.2 Value vs Effort Matrix

```
High Value ‚îÇ Analytics      ‚îÇ Fraud Detection ‚îÇ
          ‚îÇ Dashboard      ‚îÇ A/B Testing     ‚îÇ
          ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
          ‚îÇ User Portal    ‚îÇ AI Insights     ‚îÇ
Low Value ‚îÇ Basic Reports  ‚îÇ Blockchain      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           Low Effort        High Effort
```

---

## 3.7 Success Criteria v√† Acceptance

### 3.7.1 MVP Success Criteria

**Technical Criteria:**
- [ ] H·ªá th·ªëng x·ª≠ l√Ω ƒë∆∞·ª£c 10K users concurrent
- [ ] API response time <3s cho 95% requests  
- [ ] 99% uptime trong 3 th√°ng ƒë·∫ßu production
- [ ] Zero critical security vulnerabilities

**Business Criteria:**
- [ ] 25 brands ƒëƒÉng k√Ω s·ª≠ d·ª•ng platform
- [ ] 50K verified leads thu th·∫≠p ƒë∆∞·ª£c
- [ ] Cost-per-lead <0.4 USD achievement
- [ ] 90%+ form completion rate

**User Experience Criteria:**
- [ ] NPS score >50 t·ª´ brand users
- [ ] <10s average form completion time
- [ ] >85% redemption rate t·∫°i POS
- [ ] Mobile responsiveness score >90

### 3.7.2 Long-term Success Criteria

**Market Position:**
- Market leadership position trong SEA sampling industry
- 200+ enterprise clients v·ªõi high retention rate  
- Platform scalability ƒë·∫øn 10M+ end users
- Profitable unit economics v·ªõi sustainable growth

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- Business Requirement Document (01-BRD.md v3.0) - Business objectives, financial targets, success metrics
- System Feature Tree (System_Feature_Tree_Grok.md v4.0) - Feature prioritization, MoSCoW analysis
- Problem Definition (Problem.md v1.0) - Must-have/Should-have/Nice-to-have classification
- Vision & Strategy Document (Product-Sampling-Vision-and-Strategy Document.md v1.0) - Vision statement, market objectives
- Access Control Tree (Access_Control_Tree_Grok.md v2.2) - User scope definition

**T√¨nh tr·∫°ng**: Part03 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part04 - Functional Requirements  
**Ng∆∞·ªùi review**: Product Manager, Business Analyst, System Architect

# üìã SRS Part04 - Y√™u c·∫ßu ch·ª©c nƒÉng (Functional Requirements)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: ƒê·ªôi ph√¢n t√≠ch h·ªá th·ªëng  

---

## 4.1 T·ªïng quan y√™u c·∫ßu ch·ª©c nƒÉng

### 4.1.1 Ph√¢n nh√≥m ch·ª©c nƒÉng ch√≠nh
D·ª±a tr√™n **System_Feature_Tree_Grok.md v4.0**, h·ªá th·ªëng ƒë∆∞·ª£c chia th√†nh 11 y√™u c·∫ßu ch·ª©c nƒÉng ch√≠nh:

| M√£ FR | T√™n ch·ª©c nƒÉng | ƒê·ªô ∆∞u ti√™n | Ngu·ªìn tham chi·∫øu |
|-------|---------------|------------|------------------|
| FR-001 | Qu·∫£n l√Ω chi·∫øn d·ªãch | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.1 |
| FR-002 | Qu·∫£n l√Ω Barcode/Voucher | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.2 |
| FR-003 | Qu·∫£n l√Ω ƒë·ªãnh d·∫°ng qu·∫£ng c√°o | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.10 |
| FR-004 | Trang ƒë√≠ch v√† bi·ªÉu m·∫´u | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.3 |
| FR-005 | X√°c th·ª±c OTP | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.4 |
| FR-006 | C·∫•p ph√°t m√£ barcode | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.5 |
| FR-007 | T√≠ch h·ª£p POS v√† ƒë·ªïi qu√† | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.5 |
| FR-008 | Ph√¢n t√≠ch v√† b√°o c√°o | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.6 |
| FR-009 | T√≠ch h·ª£p CRM | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.7 |
| FR-010 | Ki·ªÉm so√°t truy c·∫≠p v√† ph√¢n quy·ªÅn | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.8 |
| FR-011 | C·ªïng th√¥ng tin ng∆∞·ªùi d√πng | B·∫Øt bu·ªôc c√≥ | C√¢y ch·ª©c nƒÉng 1.9 |

---

## 4.2 FR-001: Qu·∫£n l√Ω chi·∫øn d·ªãch

### 4.2.1 M√¥ t·∫£ ch·ª©c nƒÉng
H·ªá th·ªëng cung c·∫•p kh·∫£ nƒÉng t·∫°o, qu·∫£n l√Ω v√† theo d√µi c√°c chi·∫øn d·ªãch ph√¢n ph·ªëi m·∫´u s·∫£n ph·∫©m v·ªõi vi·ªác g√°n barcode, nh·∫Øm m·ª•c ti√™u ƒë·ªãa ƒëi·ªÉm v√† theo d√µi UTM.

### 4.2.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.1)
- **Qu·∫£n tr·ªã vi√™n**: T√¥i t·∫°o chi·∫øn d·ªãch to√†n c·∫ßu, g√°n barcode/ƒë·ªãa ƒëi·ªÉm, c√†i ƒë·∫∑t theo d√µi UTM
- **Qu·∫£n tr·ªã nh√≥m**: T√¥i t·∫°o chi·∫øn d·ªãch trong nh√≥m, xem tr∆∞·ªõc tr∆∞·ªõc khi xu·∫•t b·∫£n
- **T√†i kho·∫£n kh√°ch h√†ng**: T√¥i qu·∫£n l√Ω chi·∫øn d·ªãch ri√™ng, xem tr∆∞·ªõc chi·∫øn d·ªãch
- **Ki·ªÉm to√°n vi√™n**: T√¥i xem nh·∫≠t k√Ω th·ª±c thi chi·∫øn d·ªãch

### 4.2.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**Y√™u c·∫ßu ƒë·∫ßu v√†o:**
- T√™n chi·∫øn d·ªãch (b·∫Øt bu·ªôc, t·ªëi ƒëa 255 k√Ω t·ª±)
- M√¥ t·∫£ chi·∫øn d·ªãch (t√πy ch·ªçn, t·ªëi ƒëa 1000 k√Ω t·ª±)  
- Th·ªùi gian b·∫Øt ƒë·∫ßu/k·∫øt th√∫c (b·∫Øt bu·ªôc, ƒë·ªãnh d·∫°ng ng√†y gi·ªù)
- M√£ ƒë·ªãa ƒëi·ªÉm (b·∫Øt bu·ªôc, danh s√°ch c√°c ƒë·ªãnh danh ƒë·ªãa ƒëi·ªÉm)
- T·∫£i l√™n CSV barcode (b·∫Øt bu·ªôc, ƒë·ªãnh d·∫°ng ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c)
- Tham s·ªë UTM (m√£_chi·∫øn_d·ªãch, ngu·ªìn, ph∆∞∆°ng ti·ªán, t·ª´_kh√≥a, n·ªôi_dung)

**Logic x·ª≠ l√Ω:**
- X√°c th·ª±c th·ªùi gian chi·∫øn d·ªãch (b·∫Øt ƒë·∫ßu < k·∫øt th√∫c, ng√†y trong t∆∞∆°ng lai)
- Ki·ªÉm tra t√≠nh kh·∫£ d·ª•ng c·ªßa barcode v√† quy·ªÅn ƒë·ªãa ƒëi·ªÉm
- T·∫°o m√£ chi·∫øn d·ªãch duy nh·∫•t
- T·∫°o m√£ QR ƒë·ªông v·ªõi theo d√µi nh√∫ng
- C√°ch ly ƒëa thu√™ bao d·ª±a tr√™n vai tr√≤ ng∆∞·ªùi d√πng

**Y√™u c·∫ßu ƒë·∫ßu ra:**
- T·∫°o m√£ chi·∫øn d·ªãch (ƒë·ªãnh d·∫°ng UUID)
- M√£ QR ƒë·ªông cho m·ªói ƒë·ªãa ƒëi·ªÉm/ƒë·ªãnh d·∫°ng qu·∫£ng c√°o
- Tr·∫°ng th√°i chi·∫øn d·ªãch (Nh√°p/Ho·∫°t ƒë·ªông/T·∫°m d·ª´ng/Ho√†n th√†nh)
- URL theo d√µi v·ªõi tham s·ªë UTM

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Qu·∫£n tr·ªã vi√™n c√≥ th·ªÉ t·∫°o kh√¥ng gi·ªõi h·∫°n chi·∫øn d·ªãch
- [ ] Qu·∫£n tr·ªã nh√≥m ch·ªâ t·∫°o chi·∫øn d·ªãch trong ph·∫°m vi nh√≥m
- [ ] T√†i kho·∫£n kh√°ch h√†ng ch·ªâ qu·∫£n l√Ω chi·∫øn d·ªãch ri√™ng
- [ ] Th·ªùi gian thi·∫øt l·∫≠p chi·∫øn d·ªãch <2 ng√†y (y√™u c·∫ßu kinh doanh)
- [ ] ƒê·ªô ch√≠nh x√°c theo d√µi UTM 100%

---

## 4.3 FR-002: Qu·∫£n l√Ω Barcode/Voucher

### 4.3.1 M√¥ t·∫£ ch·ª©c nƒÉng
Qu·∫£n l√Ω v√≤ng ƒë·ªùi barcode/voucher t·ª´ nh·∫≠p kh·∫©u, g√°n ƒë·∫øn ƒë·ªïi qu√† v·ªõi x√°c th·ª±c s·ª≠ d·ª•ng m·ªôt l·∫ßn v√† kh·∫£ nƒÉng ƒë·ªëi so√°t.

### 4.3.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.2)
- **Qu·∫£n tr·ªã vi√™n**: T√¥i nh·∫≠p CSV barcode, ƒë·ªëi so√°t tr·∫°ng th√°i, c√†i ƒë·∫∑t API ƒë·∫©y/k√©o v·ªõi ERP
- **Qu·∫£n tr·ªã nh√≥m**: T√¥i nh·∫≠p barcode cho nh√≥m, xem nh·∫≠t k√Ω nh·∫≠p
- **T√†i kho·∫£n kh√°ch h√†ng**: T√¥i nh·∫≠p barcode cho chi·∫øn d·ªãch ri√™ng
- **Ki·ªÉm to√°n vi√™n**: T√¥i xem nh·∫≠t k√Ω nh·∫≠p/ƒë·ªëi so√°t barcode

### 4.3.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**Y√™u c·∫ßu ƒë·∫ßu v√†o:**
- ƒê·ªãnh d·∫°ng CSV: barcode, t√™n_s·∫£n_ph·∫©m, ng√†y_h·∫øt_h·∫°n, gi√°_tr·ªã, m√£_l√¥, s·ªë_l∆∞·ª£ng_c√≥_s·∫µn
- X√°c th·ª±c t·ªáp: m√£ h√≥a UTF-8, k√≠ch th∆∞·ªõc t·ªáp t·ªëi ƒëa 100MB
- ƒê·ªãnh d·∫°ng barcode: Ch·ªØ v√† s·ªë, 8-50 k√Ω t·ª±
- X√°c th·ª±c ng√†y h·∫øt h·∫°n (ch·ªâ ng√†y trong t∆∞∆°ng lai)

**Logic x·ª≠ l√Ω:**
- Ph√¢n t√≠ch CSV v·ªõi x·ª≠ l√Ω l·ªói v√† ph√°t hi·ªán tr√πng l·∫∑p
- X√°c th·ª±c t√≠nh duy nh·∫•t c·ªßa barcode tr√™n to√†n h·ªá th·ªëng
- V√≤ng ƒë·ªùi tr·∫°ng th√°i: Ch∆∞a ph√°t ‚Üí ƒê√£ ph√°t ‚Üí ƒê√£ ƒë·ªïi ‚Üí H·∫øt h·∫°n ‚Üí Thu h·ªìi
- Ho·∫°t ƒë·ªông nguy√™n t·ª≠ cho c·∫≠p nh·∫≠t kho
- D·∫•u v·∫øt ki·ªÉm tra cho m·ªçi thay ƒë·ªïi tr·∫°ng th√°i

**Y√™u c·∫ßu ƒë·∫ßu ra:**
- B√°o c√°o th√†nh c√¥ng/th·∫•t b·∫°i nh·∫≠p kh·∫©u
- T·∫°o h√¨nh ·∫£nh QR/Barcode (ƒë·ªãnh d·∫°ng PDF/PNG)
- T√≠ch h·ª£p Apple Wallet cho ng∆∞·ªùi d√πng di ƒë·ªông
- B·∫£ng ƒëi·ªÅu khi·ªÉn theo d√µi kho th·ªùi gian th·ª±c

**ƒêi·ªÉm t√≠ch h·ª£p:**
- API Voucherify cho t√≠nh nƒÉng voucher n√¢ng cao
- H·ªá th·ªëng ERP qua REST API/webhook
- H·ªá th·ªëng POS cho x√°c th·ª±c ƒë·ªïi qu√†

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Nh·∫≠p CSV <10MB trong <30 gi√¢y
- [ ] Th·ª±c thi t√≠nh duy nh·∫•t barcode 100%
- [ ] ƒê·ªô ch√≠nh x√°c kho >95%
- [ ] X√°c th·ª±c s·ª≠ d·ª•ng m·ªôt l·∫ßn v·ªõi kh√¥ng c√≥ ƒë·ªïi qu√† k√©p

---

## 4.4 FR-003: Qu·∫£n l√Ω ƒë·ªãnh d·∫°ng qu·∫£ng c√°o

### 4.4.1 M√¥ t·∫£ ch·ª©c nƒÉng
T·∫°o v√† qu·∫£n l√Ω c√°c ƒë·ªãnh d·∫°ng qu·∫£ng c√°o cho chi·∫øn d·ªãch v·ªõi t·∫£i l√™n thi·∫øt k·∫ø, c·∫•u h√¨nh m√£ QR v√† t√≠ch h·ª£p theo d√µi.

### 4.4.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.10)
- **Qu·∫£n tr·ªã vi√™n**: T√¥i t·∫°o/t·∫£i l√™n ƒë·ªãnh d·∫°ng qu·∫£ng c√°o (300 DPI), c·∫•u h√¨nh v√πng/t·ªça ƒë·ªô QR, theo d√µi
- **Qu·∫£n tr·ªã nh√≥m**: T√¥i t·∫°o/t·∫£i l√™n ƒë·ªãnh d·∫°ng qu·∫£ng c√°o cho nh√≥m, xem tr∆∞·ªõc tr∆∞·ªõc xu·∫•t b·∫£n
- **T√†i kho·∫£n kh√°ch h√†ng**: T√¥i t·∫°o/t·∫£i l√™n ƒë·ªãnh d·∫°ng qu·∫£ng c√°o cho chi·∫øn d·ªãch ri√™ng
- **Ki·ªÉm to√°n vi√™n**: T√¥i xem nh·∫≠t k√Ω t·∫£i l√™n v√† c·∫•u h√¨nh ƒë·ªãnh d·∫°ng qu·∫£ng c√°o

### 4.4.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**ƒê·ªãnh d·∫°ng ƒë∆∞·ª£c h·ªó tr·ª£ (13 lo·∫°i):**
1. T·ªù r∆°i A4 (210x297mm)
2. Poster A3 (297x420mm)  
3. Poster A2 (420x594mm)
4. Banner 2x1m
5. Banner 3x1m
6. Standee 60x160cm
7. Th·∫ª l·ªÅu A5
8. Banner hi·ªÉn th·ªã k·ªπ thu·∫≠t s·ªë
9. B√†i ƒëƒÉng m·∫°ng x√£ h·ªôi
10. Ti√™u ƒë·ªÅ email
11. Th√¥ng b√°o ƒë·∫©y di ƒë·ªông
12. Bi·ªÉn hi·ªáu k·ªá trong c·ª≠a h√†ng
13. Ch√¢n trang h√≥a ƒë∆°n

**Y√™u c·∫ßu ƒë·∫ßu v√†o:**
- T·ªáp thi·∫øt k·∫ø: PNG/JPG/PDF ‚â•300 DPI
- T·∫£i l√™n logo (t√πy ch·ªçn): PNG v·ªõi n·ªÅn trong su·ªët
- T·ªça ƒë·ªô v√πng QR (x, y, chi·ªÅu_r·ªông, chi·ªÅu_cao)
- K√≠ch th∆∞·ªõc QR t·ªëi thi·ªÉu: 2cm x 2cm v·ªõi v√πng an to√†n 0.5cm
- S·ªë l∆∞·ª£ng in v√† k·∫ø ho·∫°ch ph√¢n ph·ªëi

**Logic x·ª≠ l√Ω:**
- X√°c th·ª±c t·ªáp (DPI, ƒë·ªãnh d·∫°ng, k√≠ch th∆∞·ªõc t·ªáp <50MB)
- T·∫°o m√£ QR ƒë·ªông v·ªõi tham s·ªë theo d√µi
- K·∫øt xu·∫•t m·∫´u v·ªõi h∆∞·ªõng d·∫´n th∆∞∆°ng hi·ªáu
- T·∫°o ƒë·∫ßu ra ƒëa ƒë·ªãnh d·∫°ng

**Y√™u c·∫ßu ƒë·∫ßu ra:**
- T·ªáp s·∫µn s√†ng in v·ªõi m√£ QR nh√∫ng
- ƒê·ªãnh d·∫°ng banner k·ªπ thu·∫≠t s·ªë cho ph√¢n ph·ªëi tr·ª±c tuy·∫øn
- T·∫°o li√™n k·∫øt ng·∫Øn cho m·∫°ng x√£ h·ªôi
- T√≠ch h·ª£p pixel theo d√µi

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] ƒê·ªô ch√≠nh x√°c x√°c th·ª±c t·ªáp 100%
- [ ] Th·ªùi gian t·∫°o QR <5 gi√¢y
- [ ] T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi qu√©t-g·ª≠i >90%
- [ ] V∆∞·ª£t qua x√°c minh ch·∫•t l∆∞·ª£ng in

---

## 4.5 FR-004: Trang ƒë√≠ch v√† bi·ªÉu m·∫´u

### 4.5.1 M√¥ t·∫£ ch·ª©c nƒÉng
Trang ƒë√≠ch ph·∫£n h·ªìi v·ªõi bi·ªÉu m·∫´u thu th·∫≠p d·ªØ li·ªáu kh√°ch h√†ng, t√≠ch h·ª£p c√¢u ƒë·ªë, qu·∫£n l√Ω ƒë·ªìng √Ω v√† li√™n k·∫øt c·ªïng th√¥ng tin ng∆∞·ªùi d√πng.

### 4.5.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.3)
- **Qu·∫£n tr·ªã vi√™n**: T√¥i t·∫°o/ch·ªânh s·ª≠a m·∫´u trang ƒë√≠ch, c·∫•u h√¨nh c√¢u ƒë·ªë/kh·∫£o s√°t, qu·∫£n l√Ω ƒë·ªìng √Ω
- **Qu·∫£n tr·ªã nh√≥m**: T√¥i xem tr∆∞·ªõc/ch·ªânh s·ª≠a m·∫´u trong nh√≥m
- **T√†i kho·∫£n kh√°ch h√†ng**: T√¥i xem tr∆∞·ªõc trang ƒë√≠ch, c·∫•u h√¨nh c√¢u ƒë·ªë c∆° b·∫£n
- **Ng∆∞·ªùi d√πng cu·ªëi**: T√¥i ƒëi·ªÅn bi·ªÉu m·∫´u trong 30 gi√¢y, nh·∫≠n barcode, xem c·ªïng th√¥ng tin ng∆∞·ªùi d√πng
- **Ki·ªÉm to√°n vi√™n**: T√¥i xem nh·∫≠t k√Ω g·ª≠i/ƒë·ªìng √Ω

### 4.5.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**Tr∆∞·ªùng bi·ªÉu m·∫´u:**
- **B·∫Øt bu·ªôc**: H·ªç t√™n, Email, S·ªë ƒëi·ªán tho·∫°i
- **T√πy ch·ªçn**: Tu·ªïi, Gi·ªõi t√≠nh, ƒê·ªãa ch·ªâ, Ngh·ªÅ nghi·ªáp
- **S·ªü th√≠ch**: C√¢u ƒë·ªë ng·∫Øn (5-10 c√¢u h·ªèi tr·∫Øc nghi·ªám)
- **ƒê·ªìng √Ω**: ƒêƒÉng k√Ω ti·∫øp th·ªã, Th·ªèa thu·∫≠n x·ª≠ l√Ω d·ªØ li·ªáu, Ch·∫•p nh·∫≠n ƒëi·ªÅu kho·∫£n

**Logic x·ª≠ l√Ω:**
- X√°c th·ª±c bi·ªÉu m·∫´u th·ªùi gian th·ª±c (m·∫´u regex)
- T√≠ch h·ª£p reCAPTCHA v3 (ƒëi·ªÉm >0.5)
- L·∫≠p h·ªì s∆° ti·∫øn b·ªô ƒë·ªÉ gi·∫£m b·ªè bi·ªÉu m·∫´u
- N·ªôi dung ƒë·ªông d·ª±a tr√™n ph·∫£n h·ªìi ng∆∞·ªùi d√πng
- Thu th·∫≠p ƒë·ªìng √Ω tu√¢n th·ªß GDPR/PDPA

**Y√™u c·∫ßu ƒë·∫ßu ra:**
- H·ªì s∆° JSON v·ªõi PII ƒë∆∞·ª£c bƒÉm
- C·ªù ƒë·ªìng √Ω v·ªõi d·∫•u th·ªùi gian
- K·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm c√¢u ƒë·ªë/kh·∫£o s√°t
- T·∫°o token truy c·∫≠p c·ªïng th√¥ng tin ng∆∞·ªùi d√πng

**ƒêi·ªÉm t√≠ch h·ª£p:**
- React PWA cho tr·∫£i nghi·ªám ∆∞u ti√™n di ƒë·ªông
- Theo d√µi s·ª± ki·ªán GA4 cho ph√¢n t√≠ch ph·ªÖu
- T√≠ch h·ª£p khung ki·ªÉm th·ª≠ A/B
- H·ªó tr·ª£ ƒëa ng√¥n ng·ªØ

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Th·ªùi gian ho√†n th√†nh bi·ªÉu m·∫´u trung b√¨nh <30 gi√¢y
- [ ] ƒêi·ªÉm ph·∫£n h·ªìi di ƒë·ªông >95
- [ ] T·ª∑ l·ªá ho√†n th√†nh bi·ªÉu m·∫´u >90%
- [ ] ƒêi·ªÉm ch·∫•t l∆∞·ª£ng d·ªØ li·ªáu >95%
- [ ] T·ª∑ l·ªá ph·∫£n h·ªìi kh·∫£o s√°t >50%

---

## 4.6 FR-005: X√°c th·ª±c OTP

### 4.6.1 M√¥ t·∫£ ch·ª©c nƒÉng
H·ªá th·ªëng x√°c th·ª±c OTP ƒëa k√™nh v·ªõi ngƒÉn ch·∫∑n gian l·∫≠n, gi·ªõi h·∫°n t·ª∑ l·ªá v√† l·∫•y d·∫•u v√¢n tay thi·∫øt b·ªã.

### 4.6.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.4)
- **Ng∆∞·ªùi d√πng cu·ªëi**: T√¥i nh·∫≠p OTP (3 l·∫ßn th·ª≠, 5 ph√∫t h·∫øt th·ªùi gian) ƒë·ªÉ m·ªü kh√≥a barcode
- **Qu·∫£n tr·ªã vi√™n**: T√¥i c·∫•u h√¨nh quy t·∫Øc OTP, xem th·ªëng k√™ t·ª∑ l·ªá th·∫•t b·∫°i
- **Ki·ªÉm to√°n vi√™n**: T√¥i xem nh·∫≠t k√Ω th·ª≠ OTP v√† s·ª± ki·ªán b·∫£o m·∫≠t

### 4.6.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**T·∫°o OTP:**
- M√£ s·ªë 6 ch·ªØ s·ªë
- C·ª≠a s·ªï h·∫øt h·∫°n 5 ph√∫t
- T·∫°o ng·∫´u nhi√™n an to√†n m·∫≠t m√£
- T√πy ch·ªçn g·ª≠i SMS v√† Email

**Logic x√°c minh:**
- T·ªëi ƒëa 3 l·∫ßn th·ª≠ m·ªói phi√™n
- ƒê·ªô tr·ªÖ ti·∫øn b·ªô: 30s ‚Üí 60s ‚Üí 120s
- L·∫•y d·∫•u v√¢n tay thi·∫øt b·ªã cho ng∆∞·ªùi d√πng l·∫∑p l·∫°i
- Ki·ªÉm tra t·ªëc ƒë·ªô (s·ªë l·∫ßn th·ª≠ t·ªëi ƒëa tr√™n IP/ƒëi·ªán tho·∫°i)

**NgƒÉn ch·∫∑n gian l·∫≠n:**
- Gi·ªõi h·∫°n t·ª∑ l·ªá: 10 y√™u c·∫ßu OTP/gi·ªù m·ªói s·ªë ƒëi·ªán tho·∫°i
- Ph√°t hi·ªán v√† ch·∫∑n email d√πng m·ªôt l·∫ßn
- Ph√°t hi·ªán VPN/proxy
- Ph√°t hi·ªán m·∫´u ƒë√°ng ng·ªù

**ƒêi·ªÉm t√≠ch h·ª£p:**
- Twilio/MessageBird cho g·ª≠i SMS
- SendGrid/AWS SES cho g·ª≠i email  
- Redis cho qu·∫£n l√Ω phi√™n
- C√¥ng c·ª• ch·∫•m ƒëi·ªÉm gian l·∫≠n ML

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Th·ªùi gian g·ª≠i OTP <30 gi√¢y
- [ ] T·ª∑ l·ªá th√†nh c√¥ng x√°c minh >95%
- [ ] ƒê·ªô ch√≠nh x√°c ph√°t hi·ªán gian l·∫≠n >90%
- [ ] Kh√¥ng c√≥ d∆∞∆°ng t√≠nh gi·∫£ cho ng∆∞·ªùi d√πng h·ª£p ph√°p

---

## 4.7 FR-006: C·∫•p ph√°t m√£ barcode

### 4.7.1 M√¥ t·∫£ ch·ª©c nƒÉng
G√°n barcode t·ª± ƒë·ªông sau x√°c minh th√†nh c√¥ng v·ªõi c√° nh√¢n h√≥a v√† t√≠ch h·ª£p v√≠ di ƒë·ªông.

### 4.7.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.5)
- **H·ªá th·ªëng**: Sau x√°c minh, g√°n barcode s·ª≠ d·ª•ng m·ªôt l·∫ßn t·ª´ pool ch∆∞a ph√°t
- **Ng∆∞·ªùi d√πng cu·ªëi**: T√¥i nh·∫≠n barcode qua email/SMS ho·∫∑c v√≠ di ƒë·ªông
- **Qu·∫£n tr·ªã vi√™n**: T√¥i c·∫•u h√¨nh quy t·∫Øc c√° nh√¢n h√≥a v√† ph∆∞∆°ng th·ª©c g·ª≠i

### 4.7.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**Logic g√°n:**
- Ph√¢n b·ªï barcode d·ª±a tr√™n pool
- Pool barcode ri√™ng cho chi·∫øn d·ªãch
- X√°c th·ª±c ng√†y h·∫øt h·∫°n
- Th·ª±c thi h·∫°n ch·∫ø ƒë·ªãa l√Ω

**C√° nh√¢n h√≥a:**
- G√°n d·ª±a tr√™n s·ªü th√≠ch ng∆∞·ªùi d√πng
- Kh·ªõp bi·∫øn th·ªÉ s·∫£n ph·∫©m
- ∆Øu ƒë√£i theo ƒë·ªãa ƒëi·ªÉm c·ª• th·ªÉ
- Xem x√©t h√†nh vi l·ªãch s·ª≠

**Ph∆∞∆°ng th·ª©c g·ª≠i:**
- Email v·ªõi t·ªáp ƒë√≠nh k√®m PDF
- SMS v·ªõi li√™n k·∫øt t·∫£i xu·ªëng
- T·∫°o th·∫ª Apple Wallet
- T√≠ch h·ª£p Google Pay
- Hi·ªÉn th·ªã PWA trong ·ª©ng d·ª•ng

**Y√™u c·∫ßu ghi nh·∫≠t k√Ω:**
- D·∫•u v·∫øt ki·ªÉm tra ƒë·∫ßy ƒë·ªß: m√£_ng∆∞·ªùi_d√πng, m√£_chi·∫øn_d·ªãch, m√£_barcode, d·∫•u_th·ªùi_gian
- Thu th·∫≠p th√¥ng tin thi·∫øt b·ªã
- D·ªØ li·ªáu v·ªã tr√≠ (n·∫øu ƒë∆∞·ª£c c·∫•p ph√©p)
- Theo d√µi ph√¢n b·ªï

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Th·ªùi gian g√°n <2 gi√¢y sau x√°c minh
- [ ] T√≠nh duy nh·∫•t barcode 100%
- [ ] Kh·∫£ nƒÉng t∆∞∆°ng th√≠ch v√≠ di ƒë·ªông >95%
- [ ] T·ª∑ l·ªá g·ª≠i th√†nh c√¥ng >98%

---

## 4.8 FR-007: T√≠ch h·ª£p POS v√† ƒë·ªïi qu√†

### 4.8.1 M√¥ t·∫£ ch·ª©c nƒÉng
H·ªá th·ªëng ƒë·ªïi qu√† ƒëa k√™nh v·ªõi t√≠ch h·ª£p POS, ƒë·ªìng b·ªô ngo·∫°i tuy·∫øn v√† x·ª≠ l√Ω giao d·ªãch nguy√™n t·ª≠.

### 4.8.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.5)
- **T√†i kho·∫£n ph·ª•c v·ª•**: T√¥i qu√©t barcode t·∫°i Circle K, c·∫≠p nh·∫≠t tr·∫°ng th√°i th·ªùi gian th·ª±c
- **Qu·∫£n tr·ªã vi√™n**: T√¥i thi·∫øt l·∫≠p API/webhook POS, nh·∫≠p nh·∫≠t k√Ω ƒë·ªïi qu√† theo l√¥
- **Ng∆∞·ªùi d√πng cu·ªëi**: T√¥i xem tr·∫°ng th√°i ƒë·ªïi qu√† trong c·ªïng th√¥ng tin ng∆∞·ªùi d√πng
- **Ki·ªÉm to√°n vi√™n**: T√¥i xem nh·∫≠t k√Ω tu√¢n th·ªß ƒë·ªïi qu√†

### 4.8.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**K√™nh ƒë·ªïi qu√†:**
- T√≠ch h·ª£p terminal POS
- ·ª®ng d·ª•ng qu√©t di ƒë·ªông (Nh√¢n vi√™n)
- C√¥ng c·ª• ƒë·ªïi qu√† d·ª±a tr√™n web
- Nh·∫≠p CSV theo l√¥ cho ƒë·ªïi qu√† ngo·∫°i tuy·∫øn

**Logic x·ª≠ l√Ω:**
- X√°c th·ª±c barcode nguy√™n t·ª≠ v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i
- H·∫°n ch·∫ø ƒë·ªïi qu√† d·ª±a tr√™n ƒë·ªãa ƒëi·ªÉm
- X√°c th·ª±c c·ª≠a s·ªï th·ªùi gian (gi·ªù kinh doanh)
- Ki·ªÉm tra t√≠nh kh·∫£ d·ª•ng c·ªßa kho

**Kh·∫£ nƒÉng ngo·∫°i tuy·∫øn:**
- L∆∞u tr·ªØ d·ªØ li·ªáu c·ª•c b·ªô (IndexedDB)
- ƒê·ªìng b·ªô d·ª±a tr√™n h√†ng ƒë·ª£i khi k·∫øt n·ªëi l·∫°i
- Gi·∫£i quy·∫øt xung ƒë·ªôt cho ƒë·ªïi qu√† ƒë·ªìng th·ªùi
- Kh·∫£ nƒÉng ho·∫°t ƒë·ªông ngo·∫°i tuy·∫øn 24 gi·ªù

**ƒêi·ªÉm t√≠ch h·ª£p:**
- Scandit SDK cho qu√©t barcode
- B·ªô chuy·ªÉn ƒë·ªïi API POS (Circle K, GS25, Mini Stop)
- Th√¥ng b√°o webhook cho c·∫≠p nh·∫≠t th·ªùi gian th·ª±c
- API c·ªïng th√¥ng tin ng∆∞·ªùi d√πng cho ƒë·ªìng b·ªô tr·∫°ng th√°i

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] T·ª∑ l·ªá th√†nh c√¥ng ƒë·ªïi qu√† >98%
- [ ] ƒê·ªô ch√≠nh x√°c ƒë·ªìng b·ªô ngo·∫°i tuy·∫øn 100%
- [ ] Th·ªùi gian qu√©t trung b√¨nh <3 gi√¢y
- [ ] Kh√¥ng c√≥ s·ª± c·ªë ƒë·ªïi qu√† k√©p

---

## 4.9 FR-008: Ph√¢n t√≠ch v√† b√°o c√°o

### 4.9.1 M√¥ t·∫£ ch·ª©c nƒÉng
B·∫£ng ƒëi·ªÅu khi·ªÉn ph√¢n t√≠ch th·ªùi gian th·ª±c v·ªõi theo d√µi ph·ªÖu, kh·∫£ nƒÉng xu·∫•t v√† b√°o c√°o n√¢ng cao.

### 4.9.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.6)
- **Qu·∫£n tr·ªã vi√™n**: T√¥i xem s·ªë li·ªáu ph·ªÖu ƒë·∫ßy ƒë·ªß, xu·∫•t CSV/API, c·∫•u h√¨nh b√°o c√°o n√¢ng cao
- **Qu·∫£n tr·ªã nh√≥m**: T√¥i xem b√°o c√°o t·ªïng h·ª£p nh√≥m
- **T√†i kho·∫£n kh√°ch h√†ng**: T√¥i xem b√°o c√°o chi·∫øn d·ªãch ri√™ng, xu·∫•t d·ªØ li·ªáu kh√°ch h√†ng
- **Ki·ªÉm to√°n vi√™n**: T√¥i xem b√°o c√°o tu√¢n th·ªß v√† d·∫•u v·∫øt ki·ªÉm tra

### 4.9.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**S·ªë li·ªáu c·ªët l√µi:**
- Chuy·ªÉn ƒë·ªïi ph·ªÖu: Qu√©t ‚Üí G·ª≠i ‚Üí X√°c minh ‚Üí Ph√°t h√†nh ‚Üí ƒê·ªïi
- Chi ph√≠ tr√™n kh√°ch h√†ng ti·ªÅm nƒÉng ƒë∆∞·ª£c x√°c minh (CPL)
- Ph√¢n ph·ªëi ƒë·ªãa l√Ω
- Ph√¢n t√≠ch chu·ªói th·ªùi gian
- T√≠nh to√°n ROI chi·∫øn d·ªãch

**T√≠nh nƒÉng b·∫£ng ƒëi·ªÅu khi·ªÉn:**
- C·∫≠p nh·∫≠t d·ªØ li·ªáu th·ªùi gian th·ª±c (<5 gi√¢y ƒë·ªô tr·ªÖ)
- Bi·ªÉu ƒë·ªì t∆∞∆°ng t√°c v√† l·ªçc
- Kh·∫£ nƒÉng drill-down
- C√¥ng c·ª• ph√¢n t√≠ch so s√°nh
- L·ª±a ch·ªçn ph·∫°m vi ng√†y t√πy ch·ªânh

**Kh·∫£ nƒÉng xu·∫•t:**
- Xu·∫•t CSV/Excel cho d·ªØ li·ªáu th√¥
- B√°o c√°o PDF v·ªõi t√≥m t·∫Øt ƒëi·ªÅu h√†nh
- ƒêi·ªÉm cu·ªëi API cho truy c·∫≠p theo ch∆∞∆°ng tr√¨nh
- B√°o c√°o email theo l·ªãch

**Ph√¢n t√≠ch n√¢ng cao:**
- K·∫øt qu·∫£ kh·∫£o s√°t sau l·∫•y m·∫´u
- Ch·∫•m ƒëi·ªÉm NPS v√† ph√¢n t√≠ch t√¨nh c·∫£m
- Ph√¢n t√≠ch nh√≥m cho h√†nh vi ng∆∞·ªùi d√πng
- Ph√¢n t√≠ch d·ª± ƒëo√°n cho hi·ªáu su·∫•t chi·∫øn d·ªãch

**ƒêi·ªÉm t√≠ch h·ª£p:**
- Ph√¢n t√≠ch nh√∫ng Metabase
- BigQuery cho ph√¢n t√≠ch d·ªØ li·ªáu quy m√¥ l·ªõn
- T√≠ch h·ª£p GA4 cho ph√¢n t√≠ch web
- B·ªô k·∫øt n·ªëi c√¥ng c·ª• BI t√πy ch·ªânh

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Th·ªùi gian t·∫£i b·∫£ng ƒëi·ªÅu khi·ªÉn <3 gi√¢y
- [ ] ƒê·ªô ch√≠nh x√°c d·ªØ li·ªáu 99.9%
- [ ] T·∫°o xu·∫•t <30 gi√¢y cho 100K b·∫£n ghi
- [ ] ƒê·ªô tr·ªÖ c·∫≠p nh·∫≠t th·ªùi gian th·ª±c <5 gi√¢y

---

## 4.10 FR-009: T√≠ch h·ª£p CRM

### 4.10.1 M√¥ t·∫£ ch·ª©c nƒÉng
ƒê·ªìng b·ªô CRM hai chi·ªÅu v·ªõi ch·∫•m ƒëi·ªÉm kh√°ch h√†ng ti·ªÅm nƒÉng, quy tr√¨nh l√†m vi·ªác t·ª± ƒë·ªông v√† tu√¢n th·ªß GDPR.

### 4.10.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.7)
- **Qu·∫£n tr·ªã vi√™n**: T√¥i c·∫•u h√¨nh k·∫øt n·ªëi API CRM, thi·∫øt l·∫≠p √°nh x·∫° d·ªØ li·ªáu
- **T√†i kho·∫£n kh√°ch h√†ng**: T√¥i xu·∫•t kh√°ch h√†ng ti·ªÅm nƒÉng ƒë√£ x√°c minh cho chi·∫øn d·ªãch ri√™ng
- **Ng∆∞·ªùi d√πng cu·ªëi**: T√¥i nh·∫≠n ∆∞u ƒë√£i c√° nh√¢n h√≥a qua ti·∫øp th·ªã l·∫°i
- **Ki·ªÉm to√°n vi√™n**: T√¥i x√°c minh tu√¢n th·ªß GDPR cho chuy·ªÉn giao d·ªØ li·ªáu

### 4.10.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**H·ªá th·ªëng CRM ƒë∆∞·ª£c h·ªó tr·ª£:**
- HubSpot (t√≠ch h·ª£p ch√≠nh)
- Salesforce
- Pipedrive
- ƒêi·ªÉm cu·ªëi API REST t√πy ch·ªânh

**ƒê·ªìng b·ªô d·ªØ li·ªáu:**
- ƒê·∫©y webhook th·ªùi gian th·ª±c
- L·∫≠p l·ªãch xu·∫•t theo l√¥
- C·∫≠p nh·∫≠t gia tƒÉng
- Kh·∫£ nƒÉng ƒë·ªìng b·ªô hai chi·ªÅu

**Ch·∫•m ƒëi·ªÉm kh√°ch h√†ng ti·ªÅm nƒÉng:**
- T√≠nh to√°n ƒëi·ªÉm t∆∞∆°ng t√°c
- X√°c su·∫•t chuy·ªÉn ƒë·ªïi
- Ch·∫•m ƒëi·ªÉm nh√¢n kh·∫©u h·ªçc
- Ph√¢n t√≠ch h√†nh vi

**Tu√¢n th·ªß quy·ªÅn ri√™ng t∆∞:**
- ƒê·ªìng b·ªô c·ªù ƒë·ªìng √Ω
- T·ª± ƒë·ªông h√≥a quy·ªÅn b·ªã l√£ng qu√™n
- Th·ª±c thi gi·∫£m thi·ªÉu d·ªØ li·ªáu
- Duy tr√¨ d·∫•u v·∫øt ki·ªÉm tra

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] T·ª∑ l·ªá th√†nh c√¥ng ƒë·ªìng b·ªô >99%
- [ ] ƒê·ªô tr·ªÖ chuy·ªÉn giao d·ªØ li·ªáu <60 gi√¢y
- [ ] Tu√¢n th·ªß GDPR 100%
- [ ] ƒê·ªô ch√≠nh x√°c ch·∫•m ƒëi·ªÉm kh√°ch h√†ng ti·ªÅm nƒÉng >85%

---

## 4.11 FR-010: Ki·ªÉm so√°t truy c·∫≠p v√† ph√¢n quy·ªÅn RBAC

### 4.11.1 M√¥ t·∫£ ch·ª©c nƒÉng
H·ªá th·ªëng ki·ªÉm so√°t truy c·∫≠p d·ª±a tr√™n vai tr√≤ v·ªõi 6 vai tr√≤ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a, quy·ªÅn chi ti·∫øt v√† ghi nh·∫≠t k√Ω ki·ªÉm tra.

### 4.11.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ Access_Control_Tree_Grok.md v2.2)
- **Qu·∫£n tr·ªã vi√™n**: T√¥i g√°n vai tr√≤, qu·∫£n l√Ω ng∆∞·ªùi d√πng, c·∫•u h√¨nh ch√≠nh s√°ch b·∫£o m·∫≠t
- **Qu·∫£n tr·ªã nh√≥m**: T√¥i t·∫°o ng∆∞·ªùi d√πng trong ph·∫°m vi nh√≥m
- **T√†i kho·∫£n kh√°ch h√†ng**: T√¥i xem quy·ªÅn v√† c√†i ƒë·∫∑t h·ªì s∆°
- **Ki·ªÉm to√°n vi√™n**: T√¥i gi√°m s√°t m·∫´u truy c·∫≠p v√† tu√¢n th·ªß

### 4.11.3 Ma tr·∫≠n ph√¢n quy·ªÅn ƒë·ªông (t·ª´ Access_Control_Tree_Grok.md v2.2)

**Thi·∫øt k·∫ø quy·ªÅn ƒë·ªông cho t·ª´ng ch·ª©c nƒÉng:**

| Ch·ª©c nƒÉng | Admin | Group Admin | Customer Account | Serving Account | Auditor | User Role |
|-----------|-------|-------------|------------------|-----------------|---------|-----------|
| **FR-001: Qu·∫£n l√Ω Campaign** | ‚úÖ Full | ‚úÖ Group scope | ‚úÖ Own campaigns | ‚ùå | üëÅÔ∏è View logs | ‚ùå |
| **FR-002: Qu·∫£n l√Ω Barcode** | ‚úÖ Full import/export | ‚úÖ Group import | ‚úÖ Campaign import | ‚ùå | üëÅÔ∏è View logs | ‚ùå |
| **FR-003: Qu·∫£n l√Ω Ads Format** | ‚úÖ Create/upload global | ‚úÖ Group upload/preview | ‚úÖ Campaign upload/preview | ‚ùå | üëÅÔ∏è View logs | ‚ùå |
| **FR-004: Landing Page** | ‚úÖ Create/edit templates | ‚úÖ Group edit/preview | ‚úÖ Preview own | ‚ùå | üëÅÔ∏è View logs | ‚úÖ Fill form/quiz |
| **FR-005: OTP Verification** | ‚úÖ Config rules/view stats | ‚úÖ View group stats | ‚úÖ View campaign stats | ‚ùå | üëÅÔ∏è View logs | ‚úÖ Verify OTP |
| **FR-006: C·∫•p ph√°t Barcode** | ‚úÖ Config rules global | ‚úÖ View group allocation | ‚úÖ View campaign allocation | ‚ùå | üëÅÔ∏è View logs | ‚úÖ Receive barcode |
| **FR-007: POS & Redemption** | ‚úÖ Setup API/webhook | ‚úÖ View group stats | ‚úÖ View campaign stats | ‚úÖ Scan/redeem | üëÅÔ∏è View logs | üëÅÔ∏è View status |
| **FR-008: Analytics** | ‚úÖ Full analytics/export | ‚úÖ Group analytics | ‚úÖ Campaign analytics | ‚ùå | ‚úÖ Compliance reports | üëÅÔ∏è Personal reports |
| **FR-009: CRM Integration** | ‚úÖ Config API connections | ‚úÖ Group data export | ‚úÖ Campaign data export | ‚ùå | üëÅÔ∏è Compliance logs | ‚ùå |
| **FR-010: Access Control** | ‚úÖ Manage all users/roles | ‚úÖ Create group users | üëÅÔ∏è View own permissions | üîí Login redeem tool | üëÅÔ∏è View permissions | ‚ùå |
| **FR-011: User Portal** | ‚úÖ Config portal/FAQ | üëÅÔ∏è View group user stats | üëÅÔ∏è View campaign user stats | üëÅÔ∏è View redeem tickets | üëÅÔ∏è View user interactions | ‚úÖ Full portal access |

**K√Ω hi·ªáu:**
- ‚úÖ = Full permission
- üîí = Limited access  
- üëÅÔ∏è = View only
- ‚ùå = No access

### 4.11.4 Thi·∫øt k·∫ø quy·ªÅn ƒë·ªông chi ti·∫øt

**C·∫•u tr√∫c quy·ªÅn theo t√†i nguy√™n:**
```json
{
  "permissions": {
    "campaign": {
      "create": ["admin", "group_admin", "customer_account"],
      "read": ["admin", "group_admin", "customer_account", "auditor"],
      "update": ["admin", "group_admin:own_group", "customer_account:own"],
      "delete": ["admin", "group_admin:own_group", "customer_account:own"]
    },
    "barcode": {
      "import": ["admin", "group_admin:own_group", "customer_account:own"],
      "export": ["admin", "group_admin:own_group", "customer_account:own"],
      "view_logs": ["admin", "group_admin:own_group", "auditor"]
    },
    "redemption": {
      "scan": ["serving_account"],
      "process": ["serving_account"],
      "view_status": ["user_role:own"]
    }
  }
}
```

**Scope-based access control:**
- **Global scope**: Admin c√≥ quy·ªÅn tr√™n to√†n h·ªá th·ªëng
- **Group scope**: Group Admin ch·ªâ trong group ƒë∆∞·ª£c g√°n
- **Campaign scope**: Customer Account ch·ªâ campaigns ri√™ng  
- **Personal scope**: User Role ch·ªâ d·ªØ li·ªáu c√° nh√¢n

**Dynamic permission evaluation:**
```javascript
function hasPermission(user, action, resource, context) {
  const userRole = user.role;
  const resourceOwner = resource.owner;
  const userGroup = user.group;
  
  // Check role-based permissions
  if (!rolePermissions[userRole][action]) return false;
  
  // Apply scope restrictions
  switch(userRole) {
    case 'group_admin':
      return resource.group === userGroup;
    case 'customer_account':
      return resource.owner === user.id;
    case 'serving_account':
      return action === 'redemption' && resource.location in user.locations;
    default:
      return true;
  }
}
```

**Ph∆∞∆°ng th·ª©c x√°c th·ª±c:**
- OAuth 2.0/OpenID Connect
- Qu·∫£n l√Ω phi√™n JWT
- X√°c th·ª±c ƒëa y·∫øu t·ªë
- Kh·∫£ nƒÉng t√≠ch h·ª£p SSO

**Khung ·ªßy quy·ªÅn:**
- Quy·ªÅn d·ª±a tr√™n t√†i nguy√™n
- K·∫ø th·ª´a vai tr√≤ ph√¢n c·∫•p
- ƒê√°nh gi√° quy·ªÅn ƒë·ªông
- Ki·ªÉm so√°t truy c·∫≠p c·∫•p API

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Kh√¥ng c√≥ s·ª± c·ªë truy c·∫≠p tr√°i ph√©p
- [ ] Th·ªùi gian g√°n vai tr√≤ <2 ph√∫t
- [ ] Ph·∫£n h·ªìi x√°c th·ª±c <1 gi√¢y
- [ ] T√≠nh ƒë·∫ßy ƒë·ªß nh·∫≠t k√Ω ki·ªÉm tra 100%

---

## 4.12 FR-011: C·ªïng th√¥ng tin ng∆∞·ªùi d√πng

### 4.12.1 M√¥ t·∫£ ch·ª©c nƒÉng
·ª®ng d·ª•ng web ti·∫øn b·ªô cho ng∆∞·ªùi d√πng cu·ªëi v·ªõi l·ªãch s·ª≠ s·∫£n ph·∫©m, theo d√µi tr·∫°ng th√°i, th√¥ng b√°o v√† h·ªá th·ªëng ticket h·ªó tr·ª£.

### 4.12.2 C√¢u chuy·ªán ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md 1.9)
- **Ng∆∞·ªùi d√πng cu·ªëi**: T√¥i xem l·ªãch s·ª≠ s·∫£n ph·∫©m, ki·ªÉm tra tr·∫°ng th√°i barcode, nh·∫≠n th√¥ng b√°o
- **Ng∆∞·ªùi d√πng cu·ªëi**: T√¥i g·ª≠i ticket h·ªó tr·ª£, r√∫t ƒë·ªìng √Ω GDPR
- **Qu·∫£n tr·ªã vi√™n**: T√¥i c·∫•u h√¨nh quy t·∫Øc th√¥ng b√°o, n·ªôi dung FAQ
- **Ki·ªÉm to√°n vi√™n**: T√¥i gi√°m s√°t t∆∞∆°ng t√°c ng∆∞·ªùi d√πng v√† tu√¢n th·ªß quy·ªÅn ri√™ng t∆∞

### 4.12.3 ƒê·∫∑c t·∫£ ch·ª©c nƒÉng chi ti·∫øt

**T√≠nh nƒÉng c·ªët l√µi:**
- L·ªãch s·ª≠ s·∫£n ph·∫©m v·ªõi barcode, t√™n_s·∫£n_ph·∫©m, ng√†y_h·∫øt_h·∫°n
- Theo d√µi tr·∫°ng th√°i th·ªùi gian th·ª±c (Ch∆∞a ƒë·ªïi/ƒê√£ ƒë·ªïi/H·∫øt h·∫°n)
- Th√¥ng b√°o ƒë·∫©y cho nh·∫Øc nh·ªü ƒë·ªïi qu√† v√† ∆∞u ƒë√£i m·ªõi
- G·ª≠i ticket h·ªó tr·ª£ v·ªõi t·ªáp ƒë√≠nh k√®m

**Kh·∫£ nƒÉng PWA:**
- Ch·ª©c nƒÉng ngo·∫°i tuy·∫øn v·ªõi l∆∞u tr·ªØ c·ª•c b·ªô
- H·ªó tr·ª£ th√¥ng b√°o ƒë·∫©y
- Tr·∫£i nghi·ªám gi·ªëng ·ª©ng d·ª•ng ƒëa n·ªÅn t·∫£ng
- T·∫£i nhanh v·ªõi b·ªô nh·ªõ ƒë·ªám service worker

**H·ªá th·ªëng th√¥ng b√°o:**
- Th√¥ng b√°o SMS qua Twilio
- Th√¥ng b√°o email v·ªõi m·∫´u
- Th√¥ng b√°o ƒë·∫©y PWA
- Trung t√¢m th√¥ng b√°o trong ·ª©ng d·ª•ng

**Ki·ªÉm so√°t quy·ªÅn ri√™ng t∆∞:**
- Giao di·ªán qu·∫£n l√Ω ƒë·ªìng √Ω
- Y√™u c·∫ßu t·∫£i xu·ªëng d·ªØ li·ªáu
- Y√™u c·∫ßu x√≥a t√†i kho·∫£n
- T√πy ch·ªçn giao ti·∫øp

**ƒêi·ªÉm t√≠ch h·ª£p:**
- H·ªá th·ªëng x√°c th·ª±c ng∆∞·ªùi d√πng
- API d·ªØ li·ªáu chi·∫øn d·ªãch
- Ticketing h·ªó tr·ª£ (Zendesk)
- Theo d√µi ph√¢n t√≠ch (GA4)

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] ƒêi·ªÉm hi·ªáu su·∫•t PWA >90
- [ ] T·ª∑ l·ªá t∆∞∆°ng t√°c ng∆∞·ªùi d√πng >70%
- [ ] T·ª∑ l·ªá g·ª≠i th√¥ng b√°o >95%
- [ ] Gi·∫£i quy·∫øt ticket h·ªó tr·ª£ <48h
- [ ] Tu√¢n th·ªß GDPR 100%

---

## 4.13 Ma tr·∫≠n truy xu·∫•t ngu·ªìn g·ªëc

| Y√™u c·∫ßu kinh doanh | Y√™u c·∫ßu ch·ª©c nƒÉng | ƒê·ªô ∆∞u ti√™n tri·ªÉn khai |
|-------------------|-------------------|----------------------|
| Ph√¢n ph·ªëi m·∫´u hi·ªáu qu·∫£ chi ph√≠ | FR-001, FR-002, FR-007 | B·∫Øt bu·ªôc c√≥ |
| Thu th·∫≠p d·ªØ li·ªáu kh√°ch h√†ng ƒë√£ x√°c minh | FR-004, FR-005, FR-006 | B·∫Øt bu·ªôc c√≥ |
| ƒêo l∆∞·ªùng hi·ªáu su·∫•t chi·∫øn d·ªãch | FR-008, FR-009 | B·∫Øt bu·ªôc c√≥ |
| Ph√¢n ph·ªëi ƒëa k√™nh | FR-003, FR-007 | B·∫Øt bu·ªôc c√≥ |
| T·ªëi ∆∞u tr·∫£i nghi·ªám ng∆∞·ªùi d√πng | FR-004, FR-011 | B·∫Øt bu·ªôc c√≥ |
| B·∫£o m·∫≠t v√† tu√¢n th·ªß | FR-005, FR-010 | B·∫Øt bu·ªôc c√≥ |
| NgƒÉn ch·∫∑n gian l·∫≠n | FR-005, FR-006 | B·∫Øt bu·ªôc c√≥ |
| Ho·∫°t ƒë·ªông c√≥ th·ªÉ m·ªü r·ªông | T·∫•t c·∫£ FR | Ti·∫øn b·ªô |

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- C√¢y ch·ª©c nƒÉng h·ªá th·ªëng (System_Feature_Tree_Grok.md v4.0) - Chi ti·∫øt t·∫•t c·∫£ c√¢u chuy·ªán ng∆∞·ªùi d√πng v√† y√™u c·∫ßu
- C√¢y ki·ªÉm so√°t truy c·∫≠p (Access_Control_Tree_Grok.md v2.2) - ƒê·∫∑c t·∫£ RBAC
- T√†i li·ªáu y√™u c·∫ßu kinh doanh (01-BRD.md v3.0) - B·ªëi c·∫£nh kinh doanh v√† ti√™u ch√≠ ch·∫•p nh·∫≠n
- ƒê·ªãnh nghƒ©a v·∫•n ƒë·ªÅ (Problem.md v1.0) - ∆Øu ti√™n MoSCoW

**T√¨nh tr·∫°ng**: Part04 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part05 - Y√™u c·∫ßu phi ch·ª©c nƒÉng  
**Ng∆∞·ªùi ƒë√°nh gi√°**: Ki·∫øn tr√∫c s∆∞ h·ªá th·ªëng, Tr∆∞·ªüng nh√≥m ph√°t tri·ªÉn, Tr∆∞·ªüng nh√≥m QA
# üìã SRS Part05 - Y√™u c·∫ßu phi ch·ª©c nƒÉng (Non-Functional Requirements)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: ƒê·ªôi ph√¢n t√≠ch h·ªá th·ªëng  

---

## 5.1 T·ªïng quan y√™u c·∫ßu phi ch·ª©c nƒÉng

### 5.1.1 Ph√¢n lo·∫°i y√™u c·∫ßu phi ch·ª©c nƒÉng
D·ª±a tr√™n **01-BRD.md v3.0** v√† **System_Feature_Tree_Grok.md v4.0**, c√°c y√™u c·∫ßu phi ch·ª©c nƒÉng ƒë∆∞·ª£c chia th√†nh 8 nh√≥m ch√≠nh:

| M√£ NFR | T√™n nh√≥m | M√¥ t·∫£ | Ngu·ªìn tham chi·∫øu |
|--------|----------|-------|------------------|
| NFR-001 | Hi·ªáu nƒÉng | Th·ªùi gian ph·∫£n h·ªìi, l∆∞u l∆∞·ª£ng, ƒë·ªô tr·ªÖ | BRD 1.4, C√¢y ch·ª©c nƒÉng KPI |
| NFR-002 | Kh·∫£ nƒÉng m·ªü r·ªông | Ng∆∞·ªùi d√πng ƒë·ªìng th·ªùi, kh·ªëi l∆∞·ª£ng d·ªØ li·ªáu, ƒë·ªãa l√Ω | BRD 2.2, T√†i li·ªáu chi·∫øn l∆∞·ª£c |
| NFR-003 | ƒê·ªô tin c·∫≠y | Th·ªùi gian ho·∫°t ƒë·ªông, ch·ªãu l·ªói, ph·ª•c h·ªìi | BRD 1.4, C√¢y ch·ª©c nƒÉng |
| NFR-004 | B·∫£o m·∫≠t | X√°c th·ª±c, ·ªßy quy·ªÅn, m√£ h√≥a | C√¢y ki·ªÉm so√°t truy c·∫≠p v2.2 |
| NFR-005 | Kh·∫£ nƒÉng s·ª≠ d·ª•ng | Tr·∫£i nghi·ªám ng∆∞·ªùi d√πng, kh·∫£ nƒÉng ti·∫øp c·∫≠n, di ƒë·ªông | BRD 4.4, C√¢y ch·ª©c nƒÉng UX |
| NFR-006 | T∆∞∆°ng th√≠ch | Tr√¨nh duy·ªát, thi·∫øt b·ªã, t√≠ch h·ª£p | Problem.md, BRD |
| NFR-007 | B·∫£o tr√¨ | Ch·∫•t l∆∞·ª£ng code, tri·ªÉn khai, gi√°m s√°t | BRD 6.1, C√¢y ch·ª©c nƒÉng |
| NFR-008 | Tu√¢n th·ªß | GDPR, PDPA, ti√™u chu·∫©n ISO | BRD 1.4, Ki·ªÉm so√°t truy c·∫≠p |

---

## 5.2 NFR-001: Y√™u c·∫ßu hi·ªáu nƒÉng

### 5.2.1 M·ª•c ti√™u hi·ªáu nƒÉng (t·ª´ 01-BRD.md 1.5)
- **Chi ph√≠ tr√™n ng∆∞·ªùi d√πng ƒë√£ x√°c minh**: ‚â§ 0.4 USD
- **ƒê·ªô tr·ªÖ b·∫£ng ƒëi·ªÅu khi·ªÉn th·ªùi gian th·ª±c**: ‚â§ 3 gi√¢y
- **T·∫£i ƒë·ªânh c·ªïng API**: 100,000 y√™u c·∫ßu/ph√∫t
- **T·ª∑ l·ªá ho√†n th√†nh bi·ªÉu m·∫´u**: ‚â• 90%

### 5.2.2 Y√™u c·∫ßu th·ªùi gian ph·∫£n h·ªìi

| Thao t√°c | M·ª•c ti√™u th·ªùi gian | ƒêi·ªÅu ki·ªán ƒëo | Ngu·ªìn tham chi·∫øu |
|----------|-------------------|--------------|------------------|
| **T·∫£i trang ƒë√≠ch** | < 2 gi√¢y | 95% y√™u c·∫ßu, di ƒë·ªông 3G | C√¢y ch·ª©c nƒÉng 1.3 KPI |
| **G·ª≠i OTP** | < 30 gi√¢y | G·ª≠i SMS/Email | C√¢y ch·ª©c nƒÉng 1.4 KPI |
| **X√°c th·ª±c OTP** | < 3 gi√¢y | 95% y√™u c·∫ßu | C√¢y ch·ª©c nƒÉng 1.4 KPI |
| **T·∫°o m√£ v·∫°ch** | < 5 gi√¢y | Sau x√°c minh th√†nh c√¥ng | C√¢y ch·ª©c nƒÉng 1.5 KPI |
| **Qu√©t ƒë·ªïi qu√†** | < 3 gi√¢y | Qu√©t POS/di ƒë·ªông | C√¢y ch·ª©c nƒÉng 1.5 KPI |
| **T·∫£i b·∫£ng ƒëi·ªÅu khi·ªÉn** | < 3 gi√¢y | C·ªïng qu·∫£n tr·ªã/th∆∞∆°ng hi·ªáu | C√¢y ch·ª©c nƒÉng 1.6 KPI |
| **Xu·∫•t b√°o c√°o** | < 30 gi√¢y | 100K b·∫£n ghi CSV/Excel | C√¢y ch·ª©c nƒÉng 1.6 KPI |

### 5.2.3 Y√™u c·∫ßu l∆∞u l∆∞·ª£ng

**ƒêi·ªÉm cu·ªëi API:**
- **Trang ƒë√≠ch**: 50,000 y√™u c·∫ßu/ph√∫t (ƒë·ªânh kh·ªüi ch·∫°y chi·∫øn d·ªãch)
- **X√°c th·ª±c OTP**: 20,000 y√™u c·∫ßu/ph√∫t
- **T·∫°o m√£ v·∫°ch**: 10,000 y√™u c·∫ßu/ph√∫t  
- **API ƒë·ªïi qu√†**: 5,000 y√™u c·∫ßu/ph√∫t
- **Truy v·∫•n ph√¢n t√≠ch**: 1,000 y√™u c·∫ßu/ph√∫t

**Hi·ªáu nƒÉng c∆° s·ªü d·ªØ li·ªáu:**
- **Thao t√°c ƒë·ªçc**: < 100ms cho 95% truy v·∫•n
- **Thao t√°c ghi**: < 200ms cho giao d·ªãch
- **K·∫øt n·ªëi ƒë·ªìng th·ªùi**: 1,000 k·∫øt n·ªëi c√πng l√∫c
- **L∆∞u l∆∞·ª£ng truy v·∫•n**: 10,000 truy v·∫•n/gi√¢y

### 5.2.4 Ti√™u ch√≠ ch·∫•p nh·∫≠n hi·ªáu nƒÉng
- [ ] Ki·ªÉm th·ª≠ t·∫£i v·ªõi JMeter/K6 ƒë·∫°t 100K RPM
- [ ] Th·ªùi gian ph·∫£n h·ªìi ph·∫ßn trƒÉm th·ª© 95 < m·ª•c ti√™u
- [ ] Kh√¥ng c√≥ l·ªói h·∫øt th·ªùi gian trong t·∫£i b√¨nh th∆∞·ªùng
- [ ] T·ªëi ∆∞u truy v·∫•n c∆° s·ªü d·ªØ li·ªáu < 100ms trung b√¨nh

---

## 5.3 NFR-002: Y√™u c·∫ßu kh·∫£ nƒÉng m·ªü r·ªông

### 5.3.1 M·ª•c ti√™u m·ªü r·ªông (t·ª´ Product-Sampling-Vision-and-Strategy Document.md)
- **NƒÉm 1**: 50K ng∆∞·ªùi d√πng ƒë√£ x√°c minh, 25 th∆∞∆°ng hi·ªáu
- **NƒÉm 2**: 200K ng∆∞·ªùi d√πng ƒë√£ x√°c minh, 80 th∆∞∆°ng hi·ªáu  
- **NƒÉm 3**: 500K ng∆∞·ªùi d√πng ƒë√£ x√°c minh, 200 th∆∞∆°ng hi·ªáu
- **D√†i h·∫°n**: 10M ng∆∞·ªùi d√πng, to√†n khu v·ª±c ASEAN

### 5.3.2 Kh·∫£ nƒÉng m·ªü r·ªông ng∆∞·ªùi d√πng

| Giai ƒëo·∫°n | Ng∆∞·ªùi d√πng ƒë·ªìng th·ªùi | T·∫£i ƒë·ªânh | Kh·ªëi l∆∞·ª£ng d·ªØ li·ªáu | Y√™u c·∫ßu h·∫° t·∫ßng |
|-----------|----------------------|----------|---------------------|-----------------|
| **MVP (Q1-Q2 2025)** | 10,000 | 50K RPM | 100 GB | Tri·ªÉn khai 2-AZ |
| **M·ªü r·ªông (Q3 2025-Q4 2026)** | 100,000 | 500K RPM | 1 TB | ƒêa v√πng |
| **Khu v·ª±c (2027+)** | 1,000,000 | 5M RPM | 10 TB | Tri·ªÉn khai ASEAN |

### 5.3.3 Kh·∫£ nƒÉng m·ªü r·ªông ƒë·ªãa l√Ω
**Giai ƒëo·∫°n 1 (Vi·ªát Nam):**
- H·ªì Ch√≠ Minh v√† H√† N·ªôi l√†m v√πng ch√≠nh
- 99.9% th·ªùi gian ho·∫°t ƒë·ªông trong gi·ªù cao ƒëi·ªÉm (9-18h)
- H·ªó tr·ª£ ti·∫øng Vi·ªát

**Giai ƒëo·∫°n 2 (ASEAN):**
- Th√°i Lan, Indonesia, Philippines
- H·ªó tr·ª£ ƒëa ng√¥n ng·ªØ (Th√°i, Bahasa, ti·∫øng Anh)
- Tu√¢n th·ªß ƒë·ªãa ph∆∞∆°ng (l∆∞u tr·ªØ d·ªØ li·ªáu, nh√† cung c·∫•p vi·ªÖn th√¥ng)
- T·ªïng h·ª£p ph√¢n t√≠ch xuy√™n bi√™n gi·ªõi

### 5.3.4 Kh·∫£ nƒÉng m·ªü r·ªông d·ªØ li·ªáu
**Chi·∫øn l∆∞·ª£c ph√¢n v√πng c∆° s·ªü d·ªØ li·ªáu:**
- **Kh√≥a ph√¢n v√πng**: m√£_qu·ªëc_gia + m√£_chi·∫øn_d·ªãch
- **M·ªü r·ªông ngang**: Ph√¢n v√πng MongoDB, ph√¢n chia PostgreSQL
- **L∆∞u tr·ªØ d·ªØ li·ªáu**: 2 nƒÉm d·ªØ li·ªáu n√≥ng, 5 nƒÉm l∆∞u tr·ªØ l·∫°nh
- **Chi·∫øn l∆∞·ª£c sao l∆∞u**: Gia tƒÉng h√†ng ng√†y, sao l∆∞u ƒë·∫ßy ƒë·ªß h√†ng tu·∫ßn

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Th·ªùi gian ph·∫£n h·ªìi t·ª± ƒë·ªông m·ªü r·ªông < 5 ph√∫t
- [ ] Kh√¥ng m·∫•t d·ªØ li·ªáu trong s·ª± ki·ªán m·ªü r·ªông
- [ ] ƒê·ªô tr·ªÖ xuy√™n v√πng < 200ms
- [ ] M·ªü r·ªông c∆° s·ªü d·ªØ li·ªáu minh b·∫°ch cho ng∆∞·ªùi d√πng

---

## 5.4 NFR-003: Y√™u c·∫ßu ƒë·ªô tin c·∫≠y

### 5.4.1 M·ª•c ti√™u ƒë·ªô tin c·∫≠y (t·ª´ 01-BRD.md 1.4)
- **Th·ªùi gian ho·∫°t ƒë·ªông n·ªÅn t·∫£ng**: 99.9% SLA
- **T√≠nh kh·∫£ d·ª•ng API**: 99.95% cho ƒëi·ªÉm cu·ªëi quan tr·ªçng
- **T√≠nh nh·∫•t qu√°n d·ªØ li·ªáu**: 100% cho giao d·ªãch t√†i ch√≠nh
- **M·ª•c ti√™u ph·ª•c h·ªìi**: RTO < 4 gi·ªù, RPO < 1 gi·ªù

### 5.4.2 Kh·∫£ nƒÉng ch·ªãu l·ªói

**Lo·∫°i b·ªè ƒëi·ªÉm l·ªói ƒë∆°n:**
- **B·ªô c√¢n b·∫±ng t·∫£i**: ƒêa AZ v·ªõi ki·ªÉm tra s·ª©c kh·ªèe
- **M√°y ch·ªß ·ª©ng d·ª•ng**: Nh√≥m t·ª± ƒë·ªông m·ªü r·ªông
- **C∆° s·ªü d·ªØ li·ªáu**: Sao ch√©p ch√≠nh-ph·ª•, chuy·ªÉn ƒë·ªïi d·ª± ph√≤ng t·ª± ƒë·ªông
- **B·ªô nh·ªõ ƒë·ªám**: C·ª•m Redis v·ªõi t√≠nh b·ªÅn v·ªØng
- **L∆∞u tr·ªØ t·ªáp**: S3 v·ªõi sao ch√©p xuy√™n v√πng

**M√¥ h√¨nh ng·∫Øt m·∫°ch:**
- **API b√™n th·ª© ba**: H·∫øt th·ªùi gian 30s, th·ª≠ l·∫°i 3 l·∫ßn
- **K·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu**: Qu·∫£n l√Ω pool v·ªõi k·∫øt n·ªëi l·∫°i
- **Nh√† cung c·∫•p SMS/Email**: Nh√† cung c·∫•p d·ª± ph√≤ng t·ª± ƒë·ªông

### 5.4.3 Sao l∆∞u v√† ph·ª•c h·ªìi
**Chi·∫øn l∆∞·ª£c sao l∆∞u:**
- **C∆° s·ªü d·ªØ li·ªáu**: Sao l∆∞u li√™n t·ª•c v·ªõi ph·ª•c h·ªìi ƒëi·ªÉm th·ªùi gian
- **T·∫£i l√™n t·ªáp**: Sao ch√©p xuy√™n v√πng
- **C·∫•u h√¨nh**: H·∫° t·∫ßng d∆∞·ªõi d·∫°ng code (Terraform)
- **Code ·ª©ng d·ª•ng**: Tri·ªÉn khai d·ª±a tr√™n Git v·ªõi rollback

**Kh√¥i ph·ª•c th·∫£m h·ªça:**
- **RTO (M·ª•c ti√™u th·ªùi gian ph·ª•c h·ªìi)**: 4 gi·ªù
- **RPO (M·ª•c ti√™u ƒëi·ªÉm ph·ª•c h·ªìi)**: 1 gi·ªù
- **Ki·ªÉm th·ª≠ chuy·ªÉn ƒë·ªïi d·ª± ph√≤ng**: B√†i t·∫≠p drill h√†ng th√°ng
- **D·ª± ph√≤ng trung t√¢m d·ªØ li·ªáu**: Trang web ch√≠nh + DR

### 5.4.4 Gi√°m s√°t v√† c·∫£nh b√°o
**Gi√°m s√°t h·ªá th·ªëng:**
- **Ch·ªâ s·ªë ·ª©ng d·ª•ng**: Th·ªùi gian ph·∫£n h·ªìi, t·ª∑ l·ªá l·ªói, l∆∞u l∆∞·ª£ng
- **Ch·ªâ s·ªë h·∫° t·∫ßng**: CPU, b·ªô nh·ªõ, ƒëƒ©a, m·∫°ng
- **Ch·ªâ s·ªë kinh doanh**: T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi, doanh thu, ho·∫°t ƒë·ªông ng∆∞·ªùi d√πng
- **Ch·ªâ s·ªë b·∫£o m·∫≠t**: ƒêƒÉng nh·∫≠p th·∫•t b·∫°i, ho·∫°t ƒë·ªông ƒë√°ng ng·ªù

**Quy t·∫Øc c·∫£nh b√°o:**
- **Quan tr·ªçng**: Th·ªùi gian ph·∫£n h·ªìi > 5s, T·ª∑ l·ªá l·ªói > 1%, Ng·ª´ng ho·∫°t ƒë·ªông
- **C·∫£nh b√°o**: Th·ªùi gian ph·∫£n h·ªìi > 3s, T·ª∑ l·ªá l·ªói > 0.5%
- **Th√¥ng tin**: Ho√†n th√†nh tri·ªÉn khai, s·ª± ki·ªán m·ªü r·ªông

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] ƒêo l∆∞·ªùng 99.9% th·ªùi gian ho·∫°t ƒë·ªông qua 3 th√°ng
- [ ] Drill kh√¥i ph·ª•c th·∫£m h·ªça th√†nh c√¥ng
- [ ] Th·ªùi gian trung b√¨nh ƒë·ªÉ ph·ª•c h·ªìi (MTTR) < 30 ph√∫t
- [ ] Kh√¥ng c√≥ s·ª± c·ªë h·ªèng d·ªØ li·ªáu

---

## 5.5 NFR-004: Y√™u c·∫ßu b·∫£o m·∫≠t

### 5.5.1 M·ª•c ti√™u b·∫£o m·∫≠t (t·ª´ Access_Control_Tree_Grok.md v2.2)
- **X√°c th·ª±c**: OAuth 2.0/OpenID Connect
- **·ª¶y quy·ªÅn**: RBAC v·ªõi quy·ªÅn ƒë·ªông 6 vai tr√≤
- **B·∫£o v·ªá d·ªØ li·ªáu**: M√£ h√≥a PII AES-256
- **Tu√¢n th·ªß**: ISO 27001, GDPR/PDPA

### 5.5.2 B·∫£o m·∫≠t x√°c th·ª±c v√† ·ªßy quy·ªÅn

**Y√™u c·∫ßu x√°c th·ª±c:**
- **Ch√≠nh s√°ch m·∫≠t kh·∫©u**: T·ªëi thi·ªÉu 8 k√Ω t·ª±, quy t·∫Øc ph·ª©c t·∫°p
- **X√°c th·ª±c ƒëa y·∫øu t·ªë**: SMS/Email OTP cho vai tr√≤ qu·∫£n tr·ªã
- **Qu·∫£n l√Ω phi√™n**: JWT v·ªõi h·∫øt h·∫°n tr∆∞·ª£t
- **Kh√≥a t√†i kho·∫£n**: 5 l·∫ßn th·ª≠ th·∫•t b·∫°i ‚Üí kh√≥a 15 ph√∫t

**Khung ·ªßy quy·ªÅn:**
- **Quy·ªÅn d·ª±a tr√™n vai tr√≤**: G√°n ƒë·ªông theo ch·ª©c nƒÉng
- **B·∫£o m·∫≠t c·∫•p t√†i nguy√™n**: C√°ch ly tenant, l·ªçc d·ªØ li·ªáu
- **B·∫£o m·∫≠t API**: Gi·ªõi h·∫°n t·ª∑ l·ªá, qu·∫£n l√Ω kh√≥a API
- **TƒÉng c·∫•p ƒë·∫∑c quy·ªÅn**: N√¢ng cao vai tr√≤ t·∫°m th·ªùi v·ªõi ph√™ duy·ªát

### 5.5.3 B·∫£o m·∫≠t d·ªØ li·ªáu

**M√£ h√≥a d·ªØ li·ªáu:**
- **Khi ngh·ªâ**: AES-256 cho PII trong c∆° s·ªü d·ªØ li·ªáu
- **Khi truy·ªÅn**: TLS 1.3 cho t·∫•t c·∫£ giao ti·∫øp API
- **M√£ h√≥a sao l∆∞u**: T·ªáp sao l∆∞u ƒë∆∞·ª£c m√£ h√≥a
- **Qu·∫£n l√Ω kh√≥a**: AWS KMS ho·∫∑c HashiCorp Vault

**Quy·ªÅn ri√™ng t∆∞ d·ªØ li·ªáu:**
- **X·ª≠ l√Ω PII**: L∆∞u tr·ªØ bƒÉm, thu th·∫≠p t·ªëi thi·ªÉu
- **L∆∞u gi·ªØ d·ªØ li·ªáu**: 7 nƒÉm cho ki·ªÉm to√°n, 2 nƒÉm cho ti·∫øp th·ªã
- **Quy·ªÅn b·ªã l√£ng qu√™n**: Quy tr√¨nh x√≥a t·ª± ƒë·ªông
- **Qu·∫£n l√Ω ƒë·ªìng √Ω**: Ki·ªÉm so√°t ƒëƒÉng k√Ω/h·ªßy ƒëƒÉng k√Ω chi ti·∫øt

### 5.5.4 B·∫£o m·∫≠t ·ª©ng d·ª•ng

**B·∫£o v·ªá OWASP Top 10:**
- **Ti√™m**: Truy v·∫•n tham s·ªë, x√°c th·ª±c ƒë·∫ßu v√†o
- **X√°c th·ª±c b·ªã h·ªèng**: Qu·∫£n l√Ω phi√™n an to√†n
- **Ti·∫øt l·ªô d·ªØ li·ªáu nh·∫°y c·∫£m**: M√£ h√≥a, ti√™u ƒë·ªÅ b·∫£o m·∫≠t
- **XXE**: V√¥ hi·ªáu h√≥a x·ª≠ l√Ω th·ª±c th·ªÉ b√™n ngo√†i
- **Ki·ªÉm so√°t truy c·∫≠p b·ªã h·ªèng**: ·ª¶y quy·ªÅn c·∫•p t√†i nguy√™n
- **C·∫•u h√¨nh sai b·∫£o m·∫≠t**: Qu√©t b·∫£o m·∫≠t t·ª± ƒë·ªông
- **XSS**: Ch√≠nh s√°ch b·∫£o m·∫≠t n·ªôi dung, m√£ h√≥a ƒë·∫ßu ra
- **Deserialization kh√¥ng an to√†n**: API ch·ªâ JSON
- **Th√†nh ph·∫ßn c√≥ l·ªó h·ªïng**: Qu√©t ph·ª• thu·ªôc
- **Ghi nh·∫≠t k√Ω kh√¥ng ƒë·ªß**: D·∫•u v·∫øt ki·ªÉm tra to√†n di·ªán

**Ki·ªÉm th·ª≠ b·∫£o m·∫≠t:**
- **Ph√¢n t√≠ch tƒ©nh**: SonarQube, CodeQL
- **Ph√¢n t√≠ch ƒë·ªông**: OWASP ZAP, Burp Suite
- **Ki·ªÉm th·ª≠ th√¢m nh·∫≠p**: ƒê√°nh gi√° b√™n ngo√†i h√†ng qu√Ω
- **Qu·∫£n l√Ω l·ªó h·ªïng**: Qu√©t t·ª± ƒë·ªông, qu·∫£n l√Ω b·∫£n v√°

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Kh√¥ng c√≥ l·ªó h·ªïng quan tr·ªçng trong s·∫£n xu·∫•t
- [ ] Ki·ªÉm th·ª≠ th√¢m nh·∫≠p passed v·ªõi no high-risk findings
- [ ] Ki·ªÉm to√°n tu√¢n th·ªß GDPR passed
- [ ] Th·ªùi gian ph·∫£n h·ªìi s·ª± c·ªë b·∫£o m·∫≠t < 2 gi·ªù

---

## 5.6 NFR-005: Y√™u c·∫ßu kh·∫£ nƒÉng s·ª≠ d·ª•ng

### 5.6.1 M·ª•c ti√™u tr·∫£i nghi·ªám ng∆∞·ªùi d√πng (t·ª´ System_Feature_Tree_Grok.md UX KPIs)
- **T·ª∑ l·ªá ho√†n th√†nh bi·ªÉu m·∫´u**: > 90%
- **T·ª∑ l·ªá t∆∞∆°ng t√°c ng∆∞·ªùi d√πng**: > 70% (C·ªïng ng∆∞·ªùi d√πng)
- **Ph·∫£n h·ªìi di ƒë·ªông**: > 95% ƒëi·ªÉm
- **Kh·∫£ nƒÉng ti·∫øp c·∫≠n**: Tu√¢n th·ªß WCAG 2.1 AA

### 5.6.2 Giao di·ªán ng∆∞·ªùi d√πng

**Nguy√™n t·∫Øc thi·∫øt k·∫ø:**
- **∆Øu ti√™n di ƒë·ªông**: PWA v·ªõi thi·∫øt k·∫ø ph·∫£n h·ªìi
- **UI t·ªëi gi·∫£n**: T·∫≠p trung v√†o h√†nh ƒë·ªông c·ªët l√µi
- **Ti·∫øt l·ªô ti·∫øn b·ªô**: Hi·ªÉn th·ªã th√¥ng tin theo m·ª©c ƒë·ªô c·∫ßn thi·∫øt
- **Th∆∞∆°ng hi·ªáu nh·∫•t qu√°n**: Kh·∫£ nƒÉng white-label cho th∆∞∆°ng hi·ªáu

**Lu·ªìng tr·∫£i nghi·ªám ng∆∞·ªùi d√πng:**
- **Trang ƒë√≠ch**: Ho√†n th√†nh bi·ªÉu m·∫´u m·ªôt trang < 30 gi√¢y
- **X√°c th·ª±c OTP**: H∆∞·ªõng d·∫´n r√µ r√†ng, c∆° ch·∫ø th·ª≠ l·∫°i
- **Hi·ªÉn th·ªã m√£ v·∫°ch**: Nhi·ªÅu ƒë·ªãnh d·∫°ng (QR, Apple Wallet, PDF)
- **C·ªïng ng∆∞·ªùi d√πng**: ƒêi·ªÅu h∆∞·ªõng tr·ª±c quan, ch·ª©c nƒÉng t√¨m ki·∫øm

### 5.6.3 Ti√™u chu·∫©n kh·∫£ nƒÉng ti·∫øp c·∫≠n

**Tu√¢n th·ªß WCAG 2.1 AA:**
- **C√≥ th·ªÉ nh·∫≠n th·ª©c**: VƒÉn b·∫£n thay th·∫ø cho h√¨nh ·∫£nh, t·ª∑ l·ªá t∆∞∆°ng ph·∫£n m√†u
- **C√≥ th·ªÉ v·∫≠n h√†nh**: ƒêi·ªÅu h∆∞·ªõng b√†n ph√≠m, ch·ªâ b√°o focus
- **C√≥ th·ªÉ hi·ªÉu**: Ng√¥n ng·ªØ r√µ r√†ng, ƒëi·ªÅu h∆∞·ªõng nh·∫•t qu√°n
- **M·∫°nh m·∫Ω**: HTML ng·ªØ nghƒ©a, kh·∫£ nƒÉng t∆∞∆°ng th√≠ch tr√¨nh ƒë·ªçc m√†n h√¨nh

**H·ªó tr·ª£ ƒëa ng√¥n ng·ªØ:**
- **B·∫£n ƒë·ªãa h√≥a**: Ti·∫øng Vi·ªát, ti·∫øng Anh, ti·∫øng Th√°i, Bahasa Indonesia
- **H·ªó tr·ª£ RTL**: Th·ªã tr∆∞·ªùng ·∫¢ R·∫≠p/Hebrew (t∆∞∆°ng lai)
- **ƒê·ªãnh d·∫°ng s·ªë/ng√†y**: ƒê·ªãnh d·∫°ng theo ƒë·ªãa ph∆∞∆°ng
- **Ti·ªÅn t·ªá**: Hi·ªÉn th·ªã ti·ªÅn t·ªá ƒë·ªãa ph∆∞∆°ng

### 5.6.4 Hi·ªáu nƒÉng UX

**Core Web Vitals:**
- **Largest Contentful Paint (LCP)**: < 2.5 gi√¢y
- **First Input Delay (FID)**: < 100ms
- **Cumulative Layout Shift (CLS)**: < 0.1

**Y√™u c·∫ßu PWA:**
- **Ch·ª©c nƒÉng ngo·∫°i tuy·∫øn**: B·ªô nh·ªõ ƒë·ªám service worker
- **L·ªùi nh·∫Øc c√†i ƒë·∫∑t**: Kh·∫£ nƒÉng th√™m v√†o m√†n h√¨nh ch√≠nh
- **Th√¥ng b√°o ƒë·∫©y**: T∆∞∆°ng t√°c v√† gi·ªØ ch√¢n
- **Tr·∫£i nghi·ªám gi·ªëng ·ª©ng d·ª•ng**: Ch·∫ø ƒë·ªô to√†n m√†n h√¨nh, m√†n h√¨nh kh·ªüi ƒë·ªông

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] ƒêi·ªÉm Google PageSpeed Insights > 90
- [ ] ƒêi·ªÉm Lighthouse PWA > 90
- [ ] Ki·ªÉm th·ª≠ t·ª± ƒë·ªông WCAG 2.1 AA passed
- [ ] Ki·ªÉm th·ª≠ ch·∫•p nh·∫≠n ng∆∞·ªùi d√πng > 85% h√†i l√≤ng

---

## 5.7 NFR-006: Y√™u c·∫ßu t∆∞∆°ng th√≠ch

### 5.7.1 T∆∞∆°ng th√≠ch tr√¨nh duy·ªát v√† thi·∫øt b·ªã

**H·ªó tr·ª£ tr√¨nh duy·ªát:**
- **Desktop**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **Di ƒë·ªông**: Chrome Mobile 90+, Safari iOS 14+, Samsung Internet 14+
- **C·∫£i ti·∫øn ti·∫øn b·ªô**: Suy gi·∫£m graceful cho tr√¨nh duy·ªát c≈©

**T∆∞∆°ng th√≠ch thi·∫øt b·ªã:**
- **ƒêi·ªán tho·∫°i th√¥ng minh**: iOS 12+, Android 8+ (API level 26+)
- **M√°y t√≠nh b·∫£ng**: iPad iOS 14+, m√°y t√≠nh b·∫£ng Android 10"+
- **Desktop**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **K√≠ch th∆∞·ªõc m√†n h√¨nh**: Thi·∫øt k·∫ø ph·∫£n h·ªìi 320px ƒë·∫øn 4K

### 5.7.2 T∆∞∆°ng th√≠ch t√≠ch h·ª£p

**T√≠ch h·ª£p CRM (t·ª´ System_Feature_Tree_Grok.md 1.7):**
- **HubSpot**: REST API v3, h·ªó tr·ª£ webhook
- **Salesforce**: REST API v52, OAuth 2.0
- **Pipedrive**: REST API v1, ƒë·ªìng b·ªô th·ªùi gian th·ª±c
- **API t√πy ch·ªânh**: ƒê·∫∑c t·∫£ OpenAPI 3.0

**T√≠ch h·ª£p POS (t·ª´ System_Feature_Tree_Grok.md 1.5):**
- **Circle K**: T√≠ch h·ª£p API t√πy ch·ªânh
- **GS25**: Giao th·ª©c qu√©t m√£ v·∫°ch
- **Mini Stop**: Kh·∫£ nƒÉng ƒë·ªìng b·ªô ngo·∫°i tuy·∫øn
- **POS chung**: Scandit SDK, ƒë·ªãnh d·∫°ng m√£ v·∫°ch ti√™u chu·∫©n

**D·ªãch v·ª• b√™n th·ª© ba:**
- **Nh√† cung c·∫•p SMS**: Twilio, MessageBird v·ªõi d·ª± ph√≤ng
- **D·ªãch v·ª• email**: SendGrid, AWS SES
- **Ph√¢n t√≠ch**: GA4, Meta Pixel, theo d√µi t√πy ch·ªânh
- **H·ªó tr·ª£**: T√≠ch h·ª£p Zendesk, Freshdesk

### 5.7.3 T∆∞∆°ng th√≠ch API

**Ti√™u chu·∫©n REST API:**
- **OpenAPI 3.0**: T√†i li·ªáu API ƒë·∫ßy ƒë·ªß
- **Ph∆∞∆°ng th·ª©c HTTP**: GET, POST, PUT, DELETE, PATCH
- **M√£ tr·∫°ng th√°i**: M√£ ph·∫£n h·ªìi HTTP ti√™u chu·∫©n
- **Gi·ªõi h·∫°n t·ª∑ l·ªá**: 1000 y√™u c·∫ßu/gi·ªù m·ªói kh√≥a API
- **Phi√™n b·∫£n**: C·∫•u tr√∫c URL /api/v1/

**H·ªó tr·ª£ webhook:**
- **Lo·∫°i s·ª± ki·ªán**: S·ª± ki·ªán chi·∫øn d·ªãch, ƒë·ªïi qu√†, h√†nh ƒë·ªông ng∆∞·ªùi d√πng
- **ƒê·ªãnh d·∫°ng payload**: JSON v·ªõi x√°c minh ch·ªØ k√Ω
- **Logic th·ª≠ l·∫°i**: Backoff theo c·∫•p s·ªë nh√¢n, h√†ng ƒë·ª£i dead letter
- **B·∫£o m·∫≠t**: Ch·ªØ k√Ω HMAC, danh s√°ch tr·∫Øng IP

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Ki·ªÉm th·ª≠ cross-browser passed tr√™n t·∫•t c·∫£ tr√¨nh duy·ªát ƒë∆∞·ª£c h·ªó tr·ª£
- [ ] Ki·ªÉm th·ª≠ t∆∞∆°ng th√≠ch API v·ªõi h·ªá th·ªëng CRM ch√≠nh
- [ ] Ki·ªÉm th·ª≠ thi·∫øt b·ªã di ƒë·ªông tr√™n iOS v√† Android
- [ ] Ki·ªÉm th·ª≠ t√≠ch h·ª£p b√™n th·ª© ba ho√†n th√†nh

---

## 5.8 NFR-007: Y√™u c·∫ßu b·∫£o tr√¨

### 5.8.1 Kh·∫£ nƒÉng b·∫£o tr√¨ code

**Ti√™u chu·∫©n ch·∫•t l∆∞·ª£ng code:**
- **Code coverage**: > 80% unit test coverage
- **Ch·ªâ s·ªë ph·ª©c t·∫°p**: Ph·ª©c t·∫°p cyclomatic < 10
- **T√†i li·ªáu**: B√¨nh lu·∫≠n inline, t√†i li·ªáu API
- **Phong c√°ch code**: ƒê·ªãnh d·∫°ng nh·∫•t qu√°n, quy t·∫Øc linting

**Kh·∫£ nƒÉng b·∫£o tr√¨ ki·∫øn tr√∫c:**
- **Microservices**: K·∫øt n·ªëi l·ªèng l·∫ªo, tri·ªÉn khai ƒë·ªôc l·∫≠p
- **Thi·∫øt k·∫ø API-first**: Ranh gi·ªõi d·ªãch v·ª• r√µ r√†ng
- **Qu·∫£n l√Ω c·∫•u h√¨nh**: C·∫•u h√¨nh theo m√¥i tr∆∞·ªùng
- **Qu·∫£n l√Ω ph·ª• thu·ªôc**: C·∫≠p nh·∫≠t th∆∞·ªùng xuy√™n, b·∫£n v√° b·∫£o m·∫≠t

### 5.8.2 Tri·ªÉn khai v√† CI/CD

**T√≠ch h·ª£p li√™n t·ª•c:**
- **Ki·ªÉm th·ª≠ t·ª± ƒë·ªông**: Unit, t√≠ch h·ª£p, end-to-end tests
- **C·ªïng ch·∫•t l∆∞·ª£ng code**: Ph√¢n t√≠ch SonarQube, qu√©t b·∫£o m·∫≠t
- **T·ª± ƒë·ªông h√≥a build**: Container h√≥a Docker
- **Qu·∫£n l√Ω artifact**: Tri·ªÉn khai c√≥ phi√™n b·∫£n

**Tri·ªÉn khai li√™n t·ª•c:**
- **Tri·ªÉn khai blue-green**: Ph√°t h√†nh kh√¥ng downtime
- **Kh·∫£ nƒÉng rollback**: Ho√†n nguy√™n ngay l·∫≠p t·ª©c trong < 5 ph√∫t
- **ThƒÉng ti·∫øn m√¥i tr∆∞·ªùng**: Dev ‚Üí Staging ‚Üí Production
- **Feature flags**: Tri·ªÉn khai t√≠nh nƒÉng t·ª´ t·ª´

### 5.8.3 Gi√°m s√°t v√† observability

**Gi√°m s√°t ·ª©ng d·ª•ng:**
- **Thu th·∫≠p ch·ªâ s·ªë**: Prometheus, CloudWatch
- **T·ªïng h·ª£p nh·∫≠t k√Ω**: ELK stack, ghi nh·∫≠t k√Ω t·∫≠p trung
- **Tracing ph√¢n t√°n**: Jaeger, t∆∞∆°ng quan y√™u c·∫ßu
- **Theo d√µi l·ªói**: Sentry, t·ªïng h·ª£p ngo·∫°i l·ªá

**Tr√≠ tu·ªá kinh doanh:**
- **B·∫£ng ƒëi·ªÅu khi·ªÉn KPI**: Ch·ªâ s·ªë kinh doanh th·ªùi gian th·ª±c
- **Ph√¢n t√≠ch s·ª≠ d·ª•ng**: Theo d√µi h√†nh vi ng∆∞·ªùi d√πng
- **Xu h∆∞·ªõng hi·ªáu nƒÉng**: Ph√¢n t√≠ch l·ªãch s·ª≠
- **L·∫≠p k·∫ø ho·∫°ch nƒÉng l·ª±c**: Xu h∆∞·ªõng s·ª≠ d·ª•ng t√†i nguy√™n

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] C·ªïng ch·∫•t l∆∞·ª£ng code passed trong pipeline CI
- [ ] Ki·ªÉm th·ª≠ t·ª± ƒë·ªông h√≥a tri·ªÉn khai ho√†n th√†nh
- [ ] C·∫£nh b√°o gi√°m s√°t ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng
- [ ] T√†i li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√† c√≥ th·ªÉ truy c·∫≠p

---

## 5.9 NFR-008: Y√™u c·∫ßu tu√¢n th·ªß

### 5.9.1 Tu√¢n th·ªß quy ƒë·ªãnh d·ªØ li·ªáu (t·ª´ Access_Control_Tree_Grok.md Tu√¢n th·ªß)

**Tu√¢n th·ªß GDPR (Li√™n minh ch√¢u √Çu):**
- **C∆° s·ªü ph√°p l√Ω**: ƒê·ªìng √Ω cho ti·∫øp th·ªã, l·ª£i √≠ch h·ª£p ph√°p cho d·ªãch v·ª•
- **Gi·∫£m thi·ªÉu d·ªØ li·ªáu**: Ch·ªâ thu th·∫≠p d·ªØ li·ªáu c·∫ßn thi·∫øt
- **Quy·ªÅn truy c·∫≠p**: C·ªïng ng∆∞·ªùi d√πng v·ªõi t·∫£i xu·ªëng d·ªØ li·ªáu
- **Quy·ªÅn ch·ªânh s·ª≠a**: Ch·ª©c nƒÉng c·∫≠p nh·∫≠t h·ªì s∆°
- **Quy·ªÅn x√≥a**: X√≥a t√†i kho·∫£n v·ªõi t·∫©y d·ªØ li·ªáu
- **T√≠nh di ƒë·ªông d·ªØ li·ªáu**: Xu·∫•t d·ªØ li·ªáu ng∆∞·ªùi d√πng trong ƒë·ªãnh d·∫°ng machine-readable
- **Quy·ªÅn ri√™ng t∆∞ theo thi·∫øt k·∫ø**: C√†i ƒë·∫∑t quy·ªÅn ri√™ng t∆∞ m·∫∑c ƒë·ªãnh

**Tu√¢n th·ªß PDPA (ASEAN):**
- **B·∫£n ƒë·ªãa h√≥a d·ªØ li·ªáu**: Y√™u c·∫ßu l∆∞u tr·ªØ d·ªØ li·ªáu trong n∆∞·ªõc
- **Qu·∫£n l√Ω ƒë·ªìng √Ω**: ƒêƒÉng k√Ω r√µ r√†ng cho x·ª≠ l√Ω d·ªØ li·ªáu
- **Th√¥ng b√°o vi ph·∫°m d·ªØ li·ªáu**: Y√™u c·∫ßu th√¥ng b√°o 72 gi·ªù
- **Chuy·ªÉn giao xuy√™n bi√™n gi·ªõi**: Quy·∫øt ƒë·ªãnh ƒë·∫ßy ƒë·ªß, ƒëi·ªÅu kho·∫£n h·ª£p ƒë·ªìng ti√™u chu·∫©n

### 5.9.2 Tu√¢n th·ªß b·∫£o m·∫≠t

**Ph√π h·ª£p ISO 27001:**
- **Ch√≠nh s√°ch b·∫£o m·∫≠t th√¥ng tin**: Ch√≠nh s√°ch v√† quy tr√¨nh ƒë∆∞·ª£c t√†i li·ªáu h√≥a
- **ƒê√°nh gi√° r·ªßi ro**: ƒê√°nh gi√° b·∫£o m·∫≠t th∆∞·ªùng xuy√™n
- **Ki·ªÉm so√°t truy c·∫≠p**: Quy·ªÅn d·ª±a tr√™n vai tr√≤, ƒë·∫∑c quy·ªÅn t·ªëi thi·ªÉu
- **Qu·∫£n l√Ω s·ª± c·ªë**: K·∫ø ho·∫°ch ph·∫£n h·ªìi s·ª± c·ªë b·∫£o m·∫≠t
- **Li√™n t·ª•c kinh doanh**: Quy tr√¨nh kh√¥i ph·ª•c th·∫£m h·ªça
- **Qu·∫£n l√Ω nh√† cung c·∫•p**: ƒê√°nh gi√° b·∫£o m·∫≠t b√™n th·ª© ba

**SOC 2 Type II (T∆∞∆°ng lai):**
- **B·∫£o m·∫≠t**: Ki·ªÉm so√°t truy c·∫≠p logic v√† v·∫≠t l√Ω
- **T√≠nh kh·∫£ d·ª•ng**: Gi√°m s√°t uptime v√† hi·ªáu nƒÉng h·ªá th·ªëng
- **T√≠nh to√†n v·∫πn x·ª≠ l√Ω**: C∆° ch·∫ø b·∫£o v·ªá ƒë·ªô ch√≠nh x√°c v√† ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu
- **B·∫£o m·∫≠t**: C∆° ch·∫ø b·∫£o v·ªá d·ªØ li·ªáu
- **Quy·ªÅn ri√™ng t∆∞**: X·ª≠ l√Ω th√¥ng tin c√° nh√¢n

### 5.9.3 Tu√¢n th·ªß t√†i ch√≠nh

**Ch·ªëng r·ª≠a ti·ªÅn (AML):**
- **Nh·∫≠n d·∫°ng kh√°ch h√†ng**: Quy tr√¨nh KYC cho chi·∫øn d·ªãch gi√° tr·ªã cao
- **Gi√°m s√°t giao d·ªãch**: Ph√°t hi·ªán ho·∫°t ƒë·ªông ƒë√°ng ng·ªù
- **L∆∞u gi·ªØ h·ªì s∆°**: L∆∞u gi·ªØ l·ªãch s·ª≠ giao d·ªãch 5 nƒÉm

**Tu√¢n th·ªß thu·∫ø:**
- **T√≠nh to√°n VAT/GST**: T√≠nh thu·∫ø t·ª± ƒë·ªông
- **B√°o c√°o**: Kh·∫£ nƒÉng b√°o c√°o c∆° quan thu·∫ø
- **D·∫•u v·∫øt ki·ªÉm tra**: Nh·∫≠t k√Ω giao d·ªãch t√†i ch√≠nh ƒë·∫ßy ƒë·ªß

### 5.9.4 Ki·ªÉm to√°n v√† b√°o c√°o tu√¢n th·ªß

**Y√™u c·∫ßu ki·ªÉm to√°n:**
- **Nh·∫≠t k√Ω ki·ªÉm to√°n**: Ghi nh·∫≠t k√Ω s·ª± ki·ªán b·∫•t bi·∫øn
- **D√≤ng d·ªØ li·ªáu**: Theo d√µi lu·ªìng d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß
- **B√°o c√°o tu√¢n th·ªß**: B√°o c√°o tr·∫°ng th√°i tu√¢n th·ªß t·ª± ƒë·ªông
- **Ki·ªÉm to√°n b√™n ngo√†i**: Ki·ªÉm to√°n tu√¢n th·ªß b√™n th·ª© ba h√†ng nƒÉm

**Kh·∫£ nƒÉng b√°o c√°o:**
- **B√°o c√°o quy·ªÅn ri√™ng t∆∞**: Ho·∫°t ƒë·ªông x·ª≠ l√Ω d·ªØ li·ªáu
- **B√°o c√°o b·∫£o m·∫≠t**: T√≥m t·∫Øt s·ª± c·ªë, tr·∫°ng th√°i l·ªó h·ªïng
- **B√°o c√°o t√†i ch√≠nh**: T√≥m t·∫Øt giao d·ªãch, t√≠nh to√°n thu·∫ø
- **B√°o c√°o v·∫≠n h√†nh**: Tu√¢n th·ªß SLA, ch·ªâ s·ªë hi·ªáu nƒÉng

**Ti√™u ch√≠ ch·∫•p nh·∫≠n:**
- [ ] Ki·ªÉm to√°n tu√¢n th·ªß GDPR passed
- [ ] X√°c minh tu√¢n th·ªß PDPA ho√†n th√†nh
- [ ] Ph√¢n t√≠ch kho·∫£ng c√°ch ISO 27001 ho√†n th√†nh
- [ ] X√°c minh t√≠nh to√†n v·∫πn nh·∫≠t k√Ω ki·ªÉm to√°n passed

---

## 5.10 Ma tr·∫≠n ∆∞u ti√™n NFR

| NFR | M·ª©c ƒë·ªô quan tr·ªçng | Giai ƒëo·∫°n tri·ªÉn khai | ∆Ø·ªõc t√≠nh c√¥ng s·ª©c | Ph·ª• thu·ªôc |
|-----|-------------------|---------------------|-------------------|-----------|
| **NFR-001 Hi·ªáu nƒÉng** | Cao | MVP | Trung b√¨nh | T·ªëi ∆∞u c∆° s·ªü d·ªØ li·ªáu |
| **NFR-002 Kh·∫£ nƒÉng m·ªü r·ªông** | Cao | Giai ƒëo·∫°n 2 | Cao | H·∫° t·∫ßng ƒë√°m m√¢y |
| **NFR-003 ƒê·ªô tin c·∫≠y** | Cao | MVP | Trung b√¨nh | Thi·∫øt l·∫≠p gi√°m s√°t |
| **NFR-004 B·∫£o m·∫≠t** | R·∫•t cao | MVP | Cao | Khung tu√¢n th·ªß |
| **NFR-005 Kh·∫£ nƒÉng s·ª≠ d·ª•ng** | Cao | MVP | Trung b√¨nh | Thi·∫øt k·∫ø UX ho√†n th√†nh |
| **NFR-006 T∆∞∆°ng th√≠ch** | Trung b√¨nh | MVP | Th·∫•p | API b√™n th·ª© ba |
| **NFR-007 B·∫£o tr√¨** | Trung b√¨nh | Li√™n t·ª•c | Trung b√¨nh | Thi·∫øt l·∫≠p DevOps |
| **NFR-008 Tu√¢n th·ªß** | R·∫•t cao | MVP | Cao | ƒê√°nh gi√° ph√°p l√Ω |

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- T√†i li·ªáu y√™u c·∫ßu kinh doanh (01-BRD.md v3.0) - M·ª•c ti√™u KPI, r√†ng bu·ªôc kinh doanh, m√¥ h√¨nh t√†i ch√≠nh
- C√¢y ch·ª©c nƒÉng h·ªá th·ªëng (System_Feature_Tree_Grok.md v4.0) - KPI hi·ªáu nƒÉng, y√™u c·∫ßu UX
- C√¢y ki·ªÉm so√°t truy c·∫≠p (Access_Control_Tree_Grok.md v2.2) - Y√™u c·∫ßu b·∫£o m·∫≠t, khung tu√¢n th·ªß
- ƒê·ªãnh nghƒ©a v·∫•n ƒë·ªÅ (Problem.md v1.0) - R√†ng bu·ªôc k·ªπ thu·∫≠t, y√™u c·∫ßu m·ªü r·ªông
- T√†i li·ªáu t·∫ßm nh√¨n v√† chi·∫øn l∆∞·ª£c (Product-Sampling-Vision-and-Strategy Document.md v1.0) - M·ª•c ti√™u kh·∫£ nƒÉng m·ªü r·ªông, m·ªü r·ªông th·ªã tr∆∞·ªùng

**T√¨nh tr·∫°ng**: Part05 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part06 - Ki·∫øn tr√∫c h·ªá th·ªëng v√† th√†nh ph·∫ßn  
**Ng∆∞·ªùi ƒë√°nh gi√°**: Ki·∫øn tr√∫c s∆∞ h·ªá th·ªëng, K·ªπ s∆∞ b·∫£o m·∫≠t, K·ªπ s∆∞ hi·ªáu nƒÉng
# üìã SRS Part06 - Ki·∫øn tr√∫c h·ªá th·ªëng v√† th√†nh ph·∫ßn (System Architecture & Components)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: ƒê·ªôi ph√¢n t√≠ch h·ªá th·ªëng  

---

## 6.1 T·ªïng quan ki·∫øn tr√∫c h·ªá th·ªëng

### 6.1.1 Nguy√™n t·∫Øc thi·∫øt k·∫ø ki·∫øn tr√∫c (t·ª´ System_Feature_Tree_Grok.md v4.0)
D·ª±a tr√™n **y√™u c·∫ßu k·ªπ thu·∫≠t t·ªïng quan** trong t√†i li·ªáu c√¢y ch·ª©c nƒÉng, h·ªá th·ªëng ƒë∆∞·ª£c thi·∫øt k·∫ø theo c√°c nguy√™n t·∫Øc:

- **Microservices**: Ki·∫øn tr√∫c d·ªãch v·ª• nh·ªè v·ªõi Node.js/Go
- **Multi-tenant**: H·ªó tr·ª£ 10M ng∆∞·ªùi d√πng ƒë·∫øn 2027
- **Cloud-native**: AWS/GCP v·ªõi kh·∫£ nƒÉng m·ªü r·ªông t·ª± ƒë·ªông
- **Security-first**: M√£ h√≥a PII AES, tu√¢n th·ªß ISO 27001
- **API-driven**: T√≠ch h·ª£p HubSpot, Twilio, Scandit, GA4

### 6.1.2 M·ª•c ti√™u ki·∫øn tr√∫c (t·ª´ 01-BRD.md v3.0)
**M·ª•c ti√™u hi·ªáu nƒÉng:**
- X·ª≠ l√Ω 100,000 requests/ph√∫t t·∫°i API gateway
- Uptime 99.9% SLA
- Kh·∫£ nƒÉng m·ªü r·ªông t·ª´ 25 brands (nƒÉm 1) ƒë·∫øn 200 brands (nƒÉm 3)
- Chi ph√≠ v·∫≠n h√†nh <40% doanh thu sau nƒÉm 2

**M·ª•c ti√™u k·ªπ thu·∫≠t:**
- Th·ªùi gian ph·∫£n h·ªìi <3 gi√¢y cho dashboard
- RTO <4 gi·ªù, RPO <1 gi·ªù cho disaster recovery
- Zero downtime deployment v·ªõi blue-green strategy

### 6.1.3 R√†ng bu·ªôc ki·∫øn tr√∫c
**R√†ng bu·ªôc t·ª´ 01-BRD.md:**
- Ng√¢n s√°ch ph√°t tri·ªÉn: 122.64 t·ª∑ VND (3 nƒÉm)
- ƒê·ªôi ng≈©: 16 ng∆∞·ªùi (nƒÉm 1) ‚Üí 37 ng∆∞·ªùi (nƒÉm 3)
- Timeline: MVP 6 th√°ng, m·ªü r·ªông khu v·ª±c 18 th√°ng

**R√†ng bu·ªôc t·ª´ Problem.md:**
- H·ªó tr·ª£ offline-first sync cho retail nodes
- T√≠ch h·ª£p v·ªõi m·∫°ng l∆∞·ªõi Circle K, GS25, Mini Stop
- Tu√¢n th·ªß GDPR/PDPA cho d·ªØ li·ªáu c√° nh√¢n

---

## 6.2 Ki·∫øn tr√∫c t·ªïng th·ªÉ

### 6.2.1 S∆° ƒë·ªì ki·∫øn tr√∫c c·∫•p cao

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        CDN & Load Balancer                      ‚îÇ
‚îÇ                     (CloudFlare / AWS ALB)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    API Gateway Layer                            ‚îÇ
‚îÇ              (Kong / AWS API Gateway)                           ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ     ‚îÇ Rate Limit  ‚îÇ Auth/OAuth  ‚îÇ  Routing    ‚îÇ  Logging    ‚îÇ   ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Application Layer                              ‚îÇ
‚îÇ                 (Microservices)                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ Campaign    ‚îÇ ‚îÇ User Mgmt   ‚îÇ ‚îÇ Barcode     ‚îÇ ‚îÇ Analytics   ‚îÇ‚îÇ
‚îÇ  ‚îÇ Service     ‚îÇ ‚îÇ Service     ‚îÇ ‚îÇ Service     ‚îÇ ‚îÇ Service     ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ OTP         ‚îÇ ‚îÇ POS         ‚îÇ ‚îÇ CRM         ‚îÇ ‚îÇ Notification‚îÇ‚îÇ
‚îÇ  ‚îÇ Service     ‚îÇ ‚îÇ Service     ‚îÇ ‚îÇ Service     ‚îÇ ‚îÇ Service     ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Data Layer                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ MongoDB     ‚îÇ ‚îÇ PostgreSQL  ‚îÇ ‚îÇ Redis       ‚îÇ ‚îÇ S3/MinIO    ‚îÇ‚îÇ
‚îÇ  ‚îÇ (Documents) ‚îÇ ‚îÇ (ACID)      ‚îÇ ‚îÇ (Cache)     ‚îÇ ‚îÇ (Files)     ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.2.2 Lu·ªìng d·ªØ li·ªáu ch√≠nh (t·ª´ System_Feature_Tree_Grok.md Flow v·∫≠n h√†nh)

```
1. Kh√°ch h√†ng qu√©t QR ‚Üí API Gateway ‚Üí Campaign Service
2. ƒêi·ªÅn form ‚Üí User Service ‚Üí OTP Service ‚Üí SMS/Email Provider
3. X√°c th·ª±c OTP ‚Üí Barcode Service ‚Üí T·∫°o m√£ duy nh·∫•t
4. ƒê·ªïi qu√† t·∫°i POS ‚Üí POS Service ‚Üí C·∫≠p nh·∫≠t tr·∫°ng th√°i
5. Analytics ‚Üí CRM Service ‚Üí ƒê·ªìng b·ªô v·ªõi HubSpot/Salesforce
```

### 6.2.3 Deployment topology

**Multi-region setup:**
- **Primary region**: Vi·ªát Nam (AWS ap-southeast-1)
- **Secondary region**: Singapore (DR + ASEAN expansion)
- **CDN**: Global CloudFlare distribution

**Environment strategy:**
- **Development**: Local + cloud dev environment
- **Staging**: Pre-production testing environment  
- **Production**: Multi-AZ v·ªõi auto-scaling
- **DR (Disaster Recovery)**: Hot standby trong Singapore

---

## 6.3 Microservices chi ti·∫øt

### 6.3.1 Campaign Service (t·ª´ System_Feature_Tree_Grok.md 1.1)

**Ch·ª©c nƒÉng ch√≠nh:**
- Qu·∫£n l√Ω lifecycle campaign (t·∫°o, c·∫≠p nh·∫≠t, t·∫°m d·ª´ng, ho√†n th√†nh)
- G√°n barcode pool v√† location targeting
- T·∫°o dynamic QR v·ªõi UTM tracking
- Multi-tenant isolation theo user role

**API endpoints ch√≠nh:**
```
POST /api/v1/campaigns          - T·∫°o campaign m·ªõi
GET  /api/v1/campaigns/{id}     - Chi ti·∫øt campaign
PUT  /api/v1/campaigns/{id}     - C·∫≠p nh·∫≠t campaign
POST /api/v1/campaigns/{id}/qr  - T·∫°o QR code
```

**Database schema:**
- **campaigns** collection (MongoDB)
- **campaign_locations** (PostgreSQL relation)
- **campaign_analytics** (time-series data)

**Dependencies:**
- User Service (authorization)
- Barcode Service (pool assignment)
- Analytics Service (tracking)

### 6.3.2 User Management Service (t·ª´ Access_Control_Tree_Grok.md v2.2)

**Ch·ª©c nƒÉng ch√≠nh:**
- RBAC v·ªõi 6 roles: Admin, Group Admin, Customer Account, Serving Account, Auditor, User Role
- OAuth 2.0/JWT authentication
- Dynamic permission evaluation
- Audit logging cho compliance

**API endpoints ch√≠nh:**
```
POST /api/v1/auth/login         - ƒêƒÉng nh·∫≠p
POST /api/v1/auth/refresh       - Refresh token
GET  /api/v1/users/me           - Profile ng∆∞·ªùi d√πng
POST /api/v1/users/permissions  - Ki·ªÉm tra quy·ªÅn
```

**Permission matrix implementation:**
```javascript
// Dynamic permission t·ª´ Access_Control_Tree_Grok.md
{
  "campaign.create": ["admin", "group_admin", "customer_account"],
  "barcode.import": ["admin", "group_admin:own_group", "customer_account:own"],
  "redemption.scan": ["serving_account"]
}
```

### 6.3.3 Barcode Service (t·ª´ System_Feature_Tree_Grok.md 1.2)

**Ch·ª©c nƒÉng ch√≠nh:**
- Import/qu·∫£n l√Ω barcode pools t·ª´ CSV
- Single-use validation v√† tr·∫°ng th√°i lifecycle
- Personalized assignment sau OTP verification
- Apple Wallet/Google Pay integration

**Tr·∫°ng th√°i lifecycle:**
```
Ch∆∞a ph√°t ‚Üí ƒê√£ ph√°t ‚Üí ƒê√£ redeem ‚Üí H·∫øt h·∫°n ‚Üí Revoked
```

**API endpoints ch√≠nh:**
```
POST /api/v1/barcodes/import    - Import CSV
POST /api/v1/barcodes/assign    - G√°n cho user
PUT  /api/v1/barcodes/redeem    - ƒê·ªïi qu√†
GET  /api/v1/barcodes/status    - Ki·ªÉm tra tr·∫°ng th√°i
```

**Integration points:**
- Voucherify API cho advanced features
- Apple Wallet API cho mobile wallet
- ERP webhooks cho inventory sync

### 6.3.4 OTP Service (t·ª´ System_Feature_Tree_Grok.md 1.4)

**Ch·ª©c nƒÉng ch√≠nh:**
- Multi-channel OTP (SMS via Twilio, Email via SendGrid)
- Rate limiting v√† fraud prevention
- 6-digit code v·ªõi 5 ph√∫t expiration
- Device fingerprinting cho security

**Fraud prevention rules:**
- Max 10 OTP requests/hour per phone
- 3 verification attempts per session
- Progressive delay: 30s ‚Üí 60s ‚Üí 120s
- Disposable email detection

**API endpoints ch√≠nh:**
```
POST /api/v1/otp/send           - G·ª≠i OTP
POST /api/v1/otp/verify         - X√°c th·ª±c OTP
GET  /api/v1/otp/stats          - Th·ªëng k√™ admin
```

### 6.3.5 POS Service (t·ª´ System_Feature_Tree_Grok.md 1.5)

**Ch·ª©c nƒÉng ch√≠nh:**
- Multi-channel redemption (web tool, mobile app, POS API)
- Offline-first v·ªõi IndexedDB sync
- Atomic barcode validation
- Integration v·ªõi Circle K, GS25, Mini Stop

**Offline capability:**
- 24-hour local storage capacity
- Queue-based sync khi online
- Conflict resolution cho simultaneous redemptions

**API endpoints ch√≠nh:**
```
POST /api/v1/pos/scan           - Scan barcode
POST /api/v1/pos/redeem         - X·ª≠ l√Ω ƒë·ªïi qu√†
POST /api/v1/pos/sync           - Sync offline data
GET  /api/v1/pos/locations      - Danh s√°ch ƒëi·ªÉm ƒë·ªïi
```

### 6.3.6 Analytics Service (t·ª´ System_Feature_Tree_Grok.md 1.6)

**Ch·ª©c nƒÉng ch√≠nh:**
- Real-time funnel tracking: Scan ‚Üí Submit ‚Üí Verify ‚Üí Issue ‚Üí Redeem
- Dashboard v·ªõi <3s response time
- Export CSV/Excel/API capabilities
- Integration v·ªõi GA4, Meta Pixel

**Metrics collection:**
- Event-driven architecture v·ªõi message queue
- Time-series data storage
- Pre-aggregated dashboards
- Custom KPI calculations

**API endpoints ch√≠nh:**
```
GET  /api/v1/analytics/funnel   - Funnel metrics
GET  /api/v1/analytics/export   - Export data
POST /api/v1/analytics/events   - Custom events
GET  /api/v1/analytics/kpi      - Business KPIs
```

### 6.3.7 CRM Service (t·ª´ System_Feature_Tree_Grok.md 1.7)

**Ch·ª©c nƒÉng ch√≠nh:**
- Bi-directional sync v·ªõi HubSpot, Salesforce, Pipedrive
- Lead scoring v√† conversion tracking
- GDPR-compliant data transfer
- Webhook-based real-time updates

**Supported integrations:**
- HubSpot REST API v3
- Salesforce REST API v52  
- Custom webhook endpoints
- Batch export scheduling

**API endpoints ch√≠nh:**
```
POST /api/v1/crm/sync           - Manual sync trigger
GET  /api/v1/crm/mappings       - Field mappings
POST /api/v1/crm/webhook        - Incoming webhooks
GET  /api/v1/crm/leads          - Lead export
```

### 6.3.8 Notification Service

**Ch·ª©c nƒÉng ch√≠nh:**
- Multi-channel notifications (SMS, Email, Push)
- Template management cho brands
- Delivery tracking v√† retry logic
- Personalization d·ª±a tr√™n user preferences

**Provider integrations:**
- Twilio (SMS primary)
- MessageBird (SMS backup)
- SendGrid (Email primary)
- AWS SES (Email backup)

---

## 6.4 Data Architecture

### 6.4.1 Database strategy (t·ª´ System_Feature_Tree_Grok.md y√™u c·∫ßu k·ªπ thu·∫≠t)

**MongoDB (Document store):**
- **Campaigns**: Flexible schema cho campaign metadata
- **User profiles**: JSON documents v·ªõi preferences
- **Analytics events**: Time-series event logs
- **Audit trails**: Immutable compliance logs

**PostgreSQL (ACID transactions):**
- **Users & permissions**: RBAC relationships
- **Barcode inventory**: Financial-grade consistency
- **Transactions**: Payment v√† redemption records
- **Reconciliation**: Settlement v√† audit data

**Redis (Caching & sessions):**
- **Session storage**: JWT token management
- **Rate limiting**: API quotas v√† fraud prevention
- **Real-time data**: Dashboard metrics cache
- **Queue management**: Background job processing

### 6.4.2 Data partitioning strategy

**Horizontal sharding:**
```javascript
// Partition key strategy
{
  "partition_key": "country_code + tenant_id",
  "examples": {
    "VN_brand001": "Vietnam brand data",
    "TH_brand002": "Thailand brand data",
    "ID_brand003": "Indonesia brand data"
  }
}
```

**Data retention policy:**
- **Hot data**: 2 nƒÉm trong primary storage
- **Warm data**: 3-7 nƒÉm trong archive storage
- **Cold data**: >7 nƒÉm trong compliance archive
- **GDPR deletion**: 30 ng√†y processing window

### 6.4.3 Backup v√† recovery strategy

**Backup schedule:**
- **Continuous backup**: MongoDB change streams
- **Daily snapshots**: PostgreSQL v·ªõi point-in-time recovery
- **Weekly full backup**: Cross-region replication
- **Monthly archive**: Long-term compliance storage

**Recovery procedures:**
- **RTO target**: <4 gi·ªù full service restoration
- **RPO target**: <1 gi·ªù data loss tolerance
- **Automated failover**: Database cluster management
- **Manual procedures**: Documented disaster recovery playbook

---

## 6.5 Integration Architecture

### 6.5.1 External integrations (t·ª´ System_Feature_Tree_Grok.md t√≠ch h·ª£p)

**Third-party services:**

| Service | Provider | Purpose | SLA requirement |
|---------|----------|---------|-----------------|
| **SMS OTP** | Twilio, MessageBird | OTP delivery | 99.5% uptime, <30s delivery |
| **Email** | SendGrid, AWS SES | Notifications, OTP | 99.9% delivery rate |
| **CRM** | HubSpot, Salesforce | Lead management | 99% API availability |
| **Analytics** | GA4, Meta Pixel | Tracking, attribution | Best effort |
| **Scanning** | Scandit SDK | Barcode scanning | Offline capability |
| **Wallet** | Apple Wallet, Google Pay | Mobile barcode | Platform-dependent |
| **Support** | Zendesk | Ticketing system | 99% uptime |

### 6.5.2 API Gateway configuration

**Kong/AWS API Gateway setup:**
- **Rate limiting**: 1000 requests/hour per API key
- **Authentication**: JWT token validation
- **Routing**: Service discovery v√† load balancing
- **Monitoring**: Request/response logging
- **Versioning**: /api/v1/, /api/v2/ support

**Security policies:**
- **CORS**: Whitelist origins cho web clients
- **HTTPS only**: TLS 1.3 enforcement
- **Request validation**: OpenAPI 3.0 schema validation
- **IP filtering**: Geo-blocking cho restricted countries

### 6.5.3 Event-driven architecture

**Message queue setup:**
- **Redis Pub/Sub**: Real-time notifications
- **AWS SQS**: Reliable background processing
- **Dead letter queues**: Failed message handling
- **Event sourcing**: Audit trail reconstruction

**Event types:**
```javascript
{
  "campaign.created": {...},
  "barcode.assigned": {...},
  "redemption.completed": {...},
  "user.verified": {...},
  "analytics.tracked": {...}
}
```

---

## 6.6 Security Architecture

### 6.6.1 Authentication & Authorization (t·ª´ Access_Control_Tree_Grok.md v2.2)

**OAuth 2.0 flow:**
```
1. Client ‚Üí Authorization Server (Login)
2. User credentials ‚Üí JWT token issue
3. API calls ‚Üí JWT validation
4. Refresh token ‚Üí New access token
```

**JWT payload structure:**
```json
{
  "sub": "user_id",
  "role": "customer_account", 
  "permissions": ["campaign.create", "barcode.view"],
  "tenant": "brand_001",
  "exp": 1234567890
}
```

### 6.6.2 Data encryption

**Encryption at rest:**
- **PII fields**: AES-256 encryption trong database
- **Backup files**: Encrypted storage v·ªõi key rotation
- **Log files**: Sensitive data masking

**Encryption in transit:**
- **API traffic**: TLS 1.3 cho t·∫•t c·∫£ endpoints
- **Database connections**: SSL/TLS cho DB access
- **Internal services**: mTLS cho service-to-service

**Key management:**
- **AWS KMS**: Centralized key management
- **Key rotation**: Automated 90-day rotation
- **HSM integration**: Hardware security modules cho production

### 6.6.3 Network security

**VPC architecture:**
- **Public subnet**: Load balancers, API gateway
- **Private subnet**: Application servers
- **Database subnet**: Isolated DB access
- **NAT gateway**: Outbound internet access

**Security groups:**
- **Web tier**: Port 80/443 from internet
- **App tier**: Internal communication only
- **DB tier**: Database ports from app tier only

---

## 6.7 Monitoring & Observability

### 6.7.1 Application monitoring

**Metrics collection:**
- **Prometheus**: Application metrics scraping
- **Grafana**: Dashboard visualization
- **AlertManager**: Alert routing v√† notifications

**Key metrics:**
- **SLI (Service Level Indicators)**: Response time, error rate, throughput
- **SLO (Service Level Objectives)**: 99.9% uptime, <3s response time
- **Business metrics**: Conversion rate, revenue, user engagement

### 6.7.2 Logging architecture

**Centralized logging:**
- **ELK Stack**: Elasticsearch, Logstash, Kibana
- **Structured logging**: JSON format v·ªõi correlation IDs
- **Log retention**: 90 ng√†y operational, 7 nƒÉm compliance

**Log categories:**
- **Application logs**: Service interactions, errors
- **Audit logs**: GDPR compliance, user actions
- **Security logs**: Authentication, authorization events
- **Performance logs**: Response times, resource usage

### 6.7.3 Distributed tracing

**Jaeger implementation:**
- **Trace correlation**: Request flow across services
- **Performance profiling**: Bottleneck identification
- **Error tracking**: Exception propagation

**Trace context:**
```javascript
{
  "trace_id": "abc123",
  "span_id": "def456", 
  "operation": "barcode.assign",
  "duration": "150ms",
  "status": "success"
}
```

---

## 6.8 Deployment Architecture

### 6.8.1 Container strategy

**Docker containerization:**
- **Base images**: Alpine Linux cho security
- **Multi-stage builds**: Optimized image sizes
- **Security scanning**: Vulnerability assessment

**Kubernetes orchestration:**
- **EKS/GKE**: Managed Kubernetes service
- **Helm charts**: Application deployment templates
- **Service mesh**: Istio cho advanced networking

### 6.8.2 CI/CD Pipeline

**GitLab CI/Docker approach:**
```yaml
stages:
  - test
  - build
  - deploy

unit_tests:
  stage: test
  script:
    - npm test
    - coverage report

build_image:
  stage: build
  script:
    - docker build -t app:$CI_COMMIT_SHA .
    - docker push registry/app:$CI_COMMIT_SHA

deploy_staging:
  stage: deploy
  script:
    - helm upgrade --install app ./helm-chart
```

**Deployment strategies:**
- **Blue-Green**: Zero downtime deployments
- **Rolling updates**: Gradual service updates
- **Canary releases**: Feature flag-based rollouts

### 6.8.3 Environment management

**Infrastructure as Code:**
- **Terraform**: Cloud resource provisioning
- **Ansible**: Configuration management
- **GitOps**: Declarative environment definitions

**Environment isolation:**
- **Development**: Shared resources, cost optimized
- **Staging**: Production-like, isolated testing
- **Production**: High availability, performance optimized
- **DR**: Hot standby, automated failover

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- System Feature Tree (System_Feature_Tree_Grok.md v4.0) - Y√™u c·∫ßu k·ªπ thu·∫≠t, microservices, flow v·∫≠n h√†nh, KPI technical
- Access Control Tree (Access_Control_Tree_Grok.md v2.2) - Security architecture, RBAC design, authentication
- Business Requirement Document (01-BRD.md v3.0) - Performance targets, scaling requirements, budget constraints
- Problem Definition (Problem.md v1.0) - Technical constraints, integration requirements
- Vision & Strategy Document (Product-Sampling-Vision-and-Strategy Document.md v1.0) - Scaling timeline, market expansion

**T√¨nh tr·∫°ng**: Part06 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part07 - Thi·∫øt k·∫ø d·ªØ li·ªáu v√† CSDL  
**Ng∆∞·ªùi ƒë√°nh gi√°**: Ki·∫øn tr√∫c s∆∞ h·ªá th·ªëng, DevOps Engineer, Security Architect

# üìã SRS Part07 - Thi·∫øt k·∫ø d·ªØ li·ªáu v√† CSDL (Data Design & Database Schema)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: ƒê·ªôi ph√¢n t√≠ch h·ªá th·ªëng  

---

## 7.1 T·ªïng quan thi·∫øt k·∫ø d·ªØ li·ªáu

### 7.1.1 Chi·∫øn l∆∞·ª£c c∆° s·ªü d·ªØ li·ªáu (t·ª´ System_Feature_Tree_Grok.md v4.0)
D·ª±a tr√™n **y√™u c·∫ßu k·ªπ thu·∫≠t t·ªïng quan**, h·ªá th·ªëng s·ª≠ d·ª•ng ki·∫øn tr√∫c c∆° s·ªü d·ªØ li·ªáu ƒëa d·∫°ng:

- **MongoDB**: D·ªØ li·ªáu documents cho campaigns, analytics events, audit logs
- **PostgreSQL**: D·ªØ li·ªáu quan h·ªá cho users, permissions, financial transactions
- **Redis**: Cache layer cho sessions, rate limiting, real-time data
- **S3/MinIO**: File storage cho ads formats, exports, backups

### 7.1.2 Nguy√™n t·∫Øc thi·∫øt k·∫ø d·ªØ li·ªáu
**T·ª´ Access_Control_Tree_Grok.md v2.2:**
- **Multi-tenant isolation**: Ph√¢n t√°ch d·ªØ li·ªáu theo tenant_id
- **GDPR compliance**: PII encryption v√† audit trails
- **Data consistency**: ACID transactions cho financial data
- **Scalability**: Horizontal sharding cho 10M users

**T·ª´ 01-BRD.md v3.0:**
- **Data retention**: 7 nƒÉm cho audit, 2 nƒÉm cho marketing
- **Backup strategy**: Daily incremental, weekly full
- **Performance**: <100ms cho 95% database queries

### 7.1.3 Ph√¢n v√πng d·ªØ li·ªáu
**Chi·∫øn l∆∞·ª£c ph√¢n v√πng theo ƒë·ªãa l√Ω v√† tenant:**
```
Partition Key = country_code + tenant_id
VN_brand001, TH_brand002, ID_brand003...
```

**L∆∞u tr·ªØ ph√¢n t·∫ßng:**
- **Hot data**: Active campaigns, recent transactions
- **Warm data**: Historical analytics, completed campaigns  
- **Cold data**: Archived compliance data

---

## 7.2 MongoDB Schema Design

### 7.2.1 Campaigns Collection (t·ª´ System_Feature_Tree_Grok.md 1.1)

```javascript
// campaigns collection
{
  "_id": ObjectId("..."),
  "campaign_id": "CAMP_2025_001",
  "tenant_id": "brand_001",
  "name": "T√™n chi·∫øn d·ªãch sampling",
  "description": "M√¥ t·∫£ chi ti·∫øt chi·∫øn d·ªãch",
  "status": "active", // draft, active, paused, completed
  "dates": {
    "start_date": ISODate("2025-01-01T00:00:00Z"),
    "end_date": ISODate("2025-12-31T23:59:59Z"),
    "created_at": ISODate("2025-01-01T00:00:00Z"),
    "updated_at": ISODate("2025-01-01T00:00:00Z")
  },
  "settings": {
    "max_participants": 10000,
    "budget_limit": 50000.00,
    "cost_per_lead": 0.4
  },
  "targeting": {
    "locations": ["HCM_DIST1", "HN_DIST2"],
    "demographics": {
      "age_min": 18,
      "age_max": 65,
      "gender": "all" // male, female, all
    }
  },
  "utm_tracking": {
    "utm_source": "sampling",
    "utm_medium": "qr",
    "utm_campaign": "CAMP_2025_001",
    "utm_term": "product_trial",
    "utm_content": "poster_v1"
  },
  "barcode_pool": {
    "total_codes": 10000,
    "assigned_codes": 2500,
    "redeemed_codes": 1200,
    "expired_codes": 50
  },
  "created_by": "user_id_123",
  "group_id": "group_001", // cho Group Admin scope
  
  // Indexes
  "indexes": [
    {"tenant_id": 1, "status": 1},
    {"campaign_id": 1},
    {"created_by": 1},
    {"dates.start_date": 1, "dates.end_date": 1}
  ]
}
```

### 7.2.2 User Profiles Collection (t·ª´ System_Feature_Tree_Grok.md 1.3)

```javascript
// user_profiles collection
{
  "_id": ObjectId("..."),
  "user_id": "USER_2025_001",
  "phone_hash": "sha256_hashed_phone", // GDPR compliance
  "email_hash": "sha256_hashed_email",
  "profile": {
    "first_name_encrypted": "AES256_encrypted_data",
    "last_name_encrypted": "AES256_encrypted_data",
    "age_range": "25-34", // aggregated kh√¥ng encrypt
    "gender": "female",
    "city": "Ho Chi Minh",
    "interests": ["beauty", "food", "technology"]
  },
  "preferences": {
    "product_categories": ["cosmetics", "snacks"],
    "notification_channels": ["sms", "email"],
    "language": "vi",
    "timezone": "Asia/Ho_Chi_Minh"
  },
  "verification": {
    "phone_verified": true,
    "email_verified": true,
    "verified_at": ISODate("2025-01-01T10:30:00Z"),
    "verification_method": "sms_otp"
  },
  "consent": {
    "marketing_opt_in": true,
    "data_processing_consent": true,
    "consent_version": "v1.2",
    "consent_date": ISODate("2025-01-01T10:30:00Z"),
    "gdpr_compliant": true
  },
  "engagement": {
    "total_campaigns": 5,
    "total_redemptions": 4,
    "last_activity": ISODate("2025-10-15T14:20:00Z"),
    "engagement_score": 85 // 0-100
  },
  "created_at": ISODate("2025-01-01T10:30:00Z"),
  "updated_at": ISODate("2025-10-15T14:20:00Z"),
  
  // Indexes
  "indexes": [
    {"phone_hash": 1},
    {"email_hash": 1},
    {"created_at": -1},
    {"engagement.last_activity": -1}
  ]
}
```

### 7.2.3 Analytics Events Collection (t·ª´ System_Feature_Tree_Grok.md 1.6)

```javascript
// analytics_events collection (time-series)
{
  "_id": ObjectId("..."),
  "event_id": "EVT_2025_001234",
  "timestamp": ISODate("2025-10-17T14:30:00Z"),
  "event_type": "qr_scan", // form_submit, otp_verify, barcode_assign, redemption
  "campaign_id": "CAMP_2025_001",
  "user_id": "USER_2025_001",
  "session_id": "SESS_ABC123",
  
  "location": {
    "location_id": "HCM_CIRCLE_K_001",
    "city": "Ho Chi Minh",
    "district": "District 1",
    "coordinates": {
      "lat": 10.7769,
      "lng": 106.7009
    }
  },
  
  "device": {
    "device_type": "mobile",
    "os": "iOS",
    "browser": "Safari",
    "screen_size": "375x812",
    "user_agent": "Mozilla/5.0..."
  },
  
  "conversion_funnel": {
    "step": "scan", // scan, form, verify, assign, redeem
    "step_order": 1,
    "time_from_previous": 0, // seconds
    "completion_rate": 0.95
  },
  
  "attribution": {
    "utm_source": "poster",
    "utm_medium": "qr",
    "ads_format_id": "ADS_POSTER_A4_001",
    "referrer": "organic"
  },
  
  "metadata": {
    "ip_address_hash": "sha256_ip",
    "country_code": "VN",
    "tenant_id": "brand_001"
  },
  
  // Time-series optimized indexes
  "indexes": [
    {"timestamp": -1, "event_type": 1},
    {"campaign_id": 1, "timestamp": -1},
    {"user_id": 1, "timestamp": -1},
    {"tenant_id": 1, "timestamp": -1}
  ]
}
```

### 7.2.4 Audit Logs Collection (t·ª´ Access_Control_Tree_Grok.md v2.2)

```javascript
// audit_logs collection (immutable)
{
  "_id": ObjectId("..."),
  "audit_id": "AUDIT_2025_001234",
  "timestamp": ISODate("2025-10-17T14:30:00Z"),
  "action": "barcode_import", // user_login, campaign_create, permission_change
  "actor": {
    "user_id": "USER_ADMIN_001",
    "role": "admin",
    "tenant_id": "brand_001",
    "ip_address_hash": "sha256_ip"
  },
  "target": {
    "resource_type": "barcode",
    "resource_id": "BARCODE_BATCH_001",
    "campaign_id": "CAMP_2025_001"
  },
  "changes": {
    "before": {"status": "pending"},
    "after": {"status": "imported", "count": 10000}
  },
  "compliance": {
    "gdpr_relevant": true,
    "retention_until": ISODate("2032-10-17T14:30:00Z"), // 7 years
    "legal_basis": "legitimate_interest"
  },
  "metadata": {
    "user_agent": "Mozilla/5.0...",
    "session_id": "SESS_ABC123",
    "request_id": "REQ_DEF456"
  },
  
  // Immutable - kh√¥ng ƒë∆∞·ª£c update sau khi t·∫°o
  "immutable": true,
  
  // Compliance indexes
  "indexes": [
    {"timestamp": -1},
    {"actor.user_id": 1, "timestamp": -1},
    {"target.resource_type": 1, "timestamp": -1},
    {"compliance.retention_until": 1}
  ]
}
```

---

## 7.3 PostgreSQL Schema Design

### 7.3.1 Users v√† RBAC Tables (t·ª´ Access_Control_Tree_Grok.md v2.2)

```sql
-- Users table
CREATE TABLE users (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(100) UNIQUE NOT NULL,
    email_hash VARCHAR(64) UNIQUE NOT NULL, -- SHA-256 hash
    phone_hash VARCHAR(64) UNIQUE, -- SHA-256 hash
    password_hash VARCHAR(255) NOT NULL, -- bcrypt
    role_id INTEGER REFERENCES roles(role_id),
    tenant_id VARCHAR(50) NOT NULL,
    group_id VARCHAR(50), -- NULL cho global users
    
    -- Profile data (encrypted trong application layer)
    profile_encrypted TEXT, -- JSON encrypted v·ªõi AES-256
    
    -- Status tracking
    status VARCHAR(20) DEFAULT 'active', -- active, inactive, suspended
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,
    
    -- Audit fields
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(user_id),
    last_login TIMESTAMP,
    
    -- Indexes
    CONSTRAINT users_tenant_check CHECK (tenant_id ~ '^[a-z0-9_]+$')
);

CREATE INDEX idx_users_tenant_role ON users(tenant_id, role_id);
CREATE INDEX idx_users_email_hash ON users(email_hash);
CREATE INDEX idx_users_phone_hash ON users(phone_hash);
CREATE INDEX idx_users_last_login ON users(last_login);

-- Roles table (6 roles t·ª´ Access Control Tree)
CREATE TABLE roles (
    role_id SERIAL PRIMARY KEY,
    role_name VARCHAR(50) UNIQUE NOT NULL,
    role_description TEXT,
    scope_type VARCHAR(20) NOT NULL, -- global, group, campaign, personal
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO roles (role_name, role_description, scope_type) VALUES
('admin', 'To√†n quy·ªÅn h·ªá th·ªëng', 'global'),
('group_admin', 'Qu·∫£n tr·ªã nh√≥m', 'group'),
('customer_account', 'T√†i kho·∫£n kh√°ch h√†ng', 'campaign'),
('serving_account', 'T√†i kho·∫£n ph·ª•c v·ª•', 'personal'),
('auditor', 'Ki·ªÉm to√°n vi√™n', 'global'),
('user_role', 'Ng∆∞·ªùi d√πng cu·ªëi', 'personal');

-- Permissions table (dynamic permissions)
CREATE TABLE permissions (
    permission_id SERIAL PRIMARY KEY,
    permission_name VARCHAR(100) UNIQUE NOT NULL,
    resource_type VARCHAR(50) NOT NULL, -- campaign, barcode, analytics
    action VARCHAR(50) NOT NULL, -- create, read, update, delete
    scope_restriction VARCHAR(100), -- own, group, global
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Role-Permission mapping
CREATE TABLE role_permissions (
    role_id INTEGER REFERENCES roles(role_id),
    permission_id INTEGER REFERENCES permissions(permission_id),
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (role_id, permission_id)
);
```

### 7.3.2 Barcode Inventory Tables (t·ª´ System_Feature_Tree_Grok.md 1.2)

```sql
-- Barcode batches
CREATE TABLE barcode_batches (
    batch_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    batch_name VARCHAR(255) NOT NULL,
    campaign_id VARCHAR(100), -- Reference to MongoDB campaigns
    tenant_id VARCHAR(50) NOT NULL,
    
    -- Batch metadata
    total_codes INTEGER NOT NULL,
    imported_codes INTEGER DEFAULT 0,
    assigned_codes INTEGER DEFAULT 0,
    redeemed_codes INTEGER DEFAULT 0,
    expired_codes INTEGER DEFAULT 0,
    
    -- Product info
    product_name VARCHAR(255) NOT NULL,
    product_value DECIMAL(10,2),
    expiry_date DATE,
    
    -- Audit
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(user_id),
    
    CONSTRAINT positive_counts CHECK (
        total_codes >= 0 AND
        imported_codes >= 0 AND
        assigned_codes >= 0 AND
        redeemed_codes >= 0 AND
        expired_codes >= 0
    )
);

CREATE INDEX idx_barcode_batches_campaign ON barcode_batches(campaign_id);
CREATE INDEX idx_barcode_batches_tenant ON barcode_batches(tenant_id);

-- Individual barcodes
CREATE TABLE barcodes (
    barcode_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    barcode_value VARCHAR(100) UNIQUE NOT NULL,
    batch_id UUID REFERENCES barcode_batches(batch_id),
    
    -- Status lifecycle
    status VARCHAR(20) DEFAULT 'available', -- available, assigned, redeemed, expired, revoked
    
    -- Assignment tracking
    assigned_to_user_hash VARCHAR(64), -- SHA-256 c·ªßa user identifier
    assigned_at TIMESTAMP,
    assignment_campaign_id VARCHAR(100),
    
    -- Redemption tracking
    redeemed_at TIMESTAMP,
    redeemed_location_id VARCHAR(100),
    redeemed_by_staff VARCHAR(100),
    
    -- Expiry
    expires_at TIMESTAMP,
    
    -- Audit trail
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Constraints
    CONSTRAINT valid_status CHECK (
        status IN ('available', 'assigned', 'redeemed', 'expired', 'revoked')
    ),
    CONSTRAINT assignment_logic CHECK (
        (status = 'assigned' AND assigned_to_user_hash IS NOT NULL) OR
        (status != 'assigned' OR assigned_to_user_hash IS NULL)
    )
);

-- Optimized indexes cho performance
CREATE UNIQUE INDEX idx_barcodes_value ON barcodes(barcode_value);
CREATE INDEX idx_barcodes_batch_status ON barcodes(batch_id, status);
CREATE INDEX idx_barcodes_user_hash ON barcodes(assigned_to_user_hash) WHERE assigned_to_user_hash IS NOT NULL;
CREATE INDEX idx_barcodes_redemption ON barcodes(redeemed_at) WHERE redeemed_at IS NOT NULL;
CREATE INDEX idx_barcodes_expiry ON barcodes(expires_at) WHERE expires_at IS NOT NULL;

-- Barcode status history (cho audit)
CREATE TABLE barcode_status_history (
    history_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    barcode_id UUID REFERENCES barcodes(barcode_id),
    old_status VARCHAR(20),
    new_status VARCHAR(20),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    changed_by UUID REFERENCES users(user_id),
    change_reason TEXT,
    metadata JSONB
);

CREATE INDEX idx_barcode_history_barcode ON barcode_status_history(barcode_id, changed_at);
```

### 7.3.3 Financial Transactions Table (t·ª´ 01-BRD.md v3.0)

```sql
-- Transactions cho billing v√† settlement
CREATE TABLE transactions (
    transaction_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id VARCHAR(50) NOT NULL,
    
    -- Transaction details
    transaction_type VARCHAR(50) NOT NULL, -- subscription, usage_fee, refund
    amount DECIMAL(15,2) NOT NULL,
    currency CHAR(3) DEFAULT 'VND',
    
    -- Reference data
    campaign_id VARCHAR(100),
    billing_period DATE,
    item_count INTEGER, -- s·ªë l∆∞·ª£ng leads, redemptions, etc.
    unit_price DECIMAL(10,4),
    
    -- Status
    status VARCHAR(20) DEFAULT 'pending', -- pending, completed, failed, refunded
    processed_at TIMESTAMP,
    
    -- Payment integration
    payment_provider VARCHAR(50),
    payment_reference VARCHAR(255),
    
    -- Audit
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(user_id),
    
    -- Invoice data
    invoice_id VARCHAR(100),
    invoice_generated_at TIMESTAMP,
    
    CONSTRAINT positive_amount CHECK (amount > 0),
    CONSTRAINT valid_status CHECK (
        status IN ('pending', 'completed', 'failed', 'refunded')
    )
);

CREATE INDEX idx_transactions_tenant_period ON transactions(tenant_id, billing_period);
CREATE INDEX idx_transactions_status ON transactions(status, created_at);
CREATE INDEX idx_transactions_campaign ON transactions(campaign_id) WHERE campaign_id IS NOT NULL;
```

### 7.3.4 Locations v√† Retail Network (t·ª´ System_Feature_Tree_Grok.md 2.8)

```sql
-- Retail locations
CREATE TABLE locations (
    location_id VARCHAR(100) PRIMARY KEY,
    location_name VARCHAR(255) NOT NULL,
    location_type VARCHAR(50), -- circle_k, gs25, mini_stop, booth, other
    
    -- Address
    address TEXT NOT NULL,
    city VARCHAR(100) NOT NULL,
    district VARCHAR(100),
    country_code CHAR(2) DEFAULT 'VN',
    postal_code VARCHAR(20),
    
    -- Coordinates
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    
    -- Operational info
    status VARCHAR(20) DEFAULT 'active', -- active, inactive, maintenance
    operating_hours JSONB, -- {"mon": "06:00-22:00", "tue": "06:00-22:00", ...}
    contact_phone VARCHAR(20),
    contact_email VARCHAR(100),
    
    -- Partner info
    partner_id VARCHAR(100),
    partner_name VARCHAR(255),
    commission_rate DECIMAL(5,4) DEFAULT 0.00, -- % commission
    
    -- Capabilities
    pos_integration BOOLEAN DEFAULT FALSE,
    offline_capability BOOLEAN DEFAULT TRUE,
    max_daily_redemptions INTEGER,
    
    -- Audit
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT valid_coordinates CHECK (
        (latitude IS NULL AND longitude IS NULL) OR
        (latitude BETWEEN -90 AND 90 AND longitude BETWEEN -180 AND 180)
    )
);

CREATE INDEX idx_locations_city_status ON locations(city, status);
CREATE INDEX idx_locations_type_country ON locations(location_type, country_code);
CREATE INDEX idx_locations_partner ON locations(partner_id) WHERE partner_id IS NOT NULL;

-- Spatial index cho geo queries (PostGIS extension)
CREATE INDEX idx_locations_geo ON locations USING GIST (ST_MakePoint(longitude, latitude));
```

---

## 7.4 Redis Schema Design

### 7.4.1 Session Management (t·ª´ System_Feature_Tree_Grok.md 1.4)

```javascript
// Redis keys cho session management
{
  // JWT session cache
  "session:jwt:{token_hash}": {
    "user_id": "USER_2025_001",
    "role": "customer_account",
    "tenant_id": "brand_001",
    "permissions": ["campaign.create", "barcode.view"],
    "expires_at": "2025-10-17T18:00:00Z"
  },
  "ttl": 3600, // 1 hour
  
  // OTP verification
  "otp:verify:{phone_hash}": {
    "code": "123456",
    "attempts": 1,
    "max_attempts": 3,
    "created_at": "2025-10-17T14:30:00Z"
  },
  "ttl": 300, // 5 minutes
  
  // Rate limiting
  "rate_limit:api:{user_id}": {
    "count": 45,
    "window_start": "2025-10-17T14:00:00Z"
  },
  "ttl": 3600, // 1 hour window
  
  // Fraud detection
  "fraud:phone:{phone_hash}": {
    "otp_requests_today": 8,
    "last_request": "2025-10-17T14:30:00Z",
    "suspicious_score": 0.2
  },
  "ttl": 86400 // 24 hours
}
```

### 7.4.2 Real-time Analytics Cache

```javascript
// Dashboard metrics cache
{
  "analytics:campaign:{campaign_id}:today": {
    "scans": 1250,
    "form_submissions": 980,
    "verifications": 945,
    "assignments": 920,
    "redemptions": 650,
    "conversion_rate": 0.76,
    "last_updated": "2025-10-17T14:30:00Z"
  },
  "ttl": 300, // 5 minutes
  
  "analytics:funnel:{campaign_id}:realtime": {
    "scan_to_form": 0.78,
    "form_to_verify": 0.96,
    "verify_to_assign": 0.97,
    "assign_to_redeem": 0.71,
    "overall_conversion": 0.52
  },
  "ttl": 60, // 1 minute
  
  // Location-based metrics
  "analytics:location:{location_id}:today": {
    "total_scans": 85,
    "unique_users": 72,
    "redemptions": 45,
    "peak_hour": "14:00-15:00",
    "avg_time_to_redeem": 1800 // seconds
  },
  "ttl": 1800 // 30 minutes
}
```

### 7.4.3 Background Jobs Queue

```javascript
// Job queue cho background processing
{
  "queue:email:high": [
    {
      "job_id": "JOB_EMAIL_001",
      "type": "otp_email",
      "recipient": "user@example.com",
      "template": "otp_verification",
      "data": {"otp_code": "123456"},
      "retry_count": 0,
      "created_at": "2025-10-17T14:30:00Z"
    }
  ],
  
  "queue:sms:high": [
    {
      "job_id": "JOB_SMS_001", 
      "type": "otp_sms",
      "phone": "+84901234567",
      "message": "M√£ x√°c th·ª±c c·ªßa b·∫°n: 123456",
      "provider": "twilio",
      "retry_count": 0
    }
  ],
  
  "queue:analytics:low": [
    {
      "job_id": "JOB_ANALYTICS_001",
      "type": "event_processing",
      "events_batch": [...],
      "processing_at": "2025-10-17T14:35:00Z"
    }
  ]
}
```

---

## 7.5 File Storage Design

### 7.5.1 S3/MinIO Bucket Structure (t·ª´ System_Feature_Tree_Grok.md 1.10)

```
product-sampling-storage/
‚îú‚îÄ‚îÄ ads-formats/
‚îÇ   ‚îú‚îÄ‚îÄ {tenant_id}/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ {campaign_id}/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ original/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ poster_a4_v1.pdf
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ flyer_a5_v2.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ processed/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ poster_a4_v1_qr.pdf
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ flyer_a5_v2_qr.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ thumbnails/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ poster_a4_v1_thumb.jpg
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ flyer_a5_v2_thumb.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ brand_guidelines.pdf
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ logo_high_res.png
‚îú‚îÄ‚îÄ exports/
‚îÇ   ‚îú‚îÄ‚îÄ {tenant_id}/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-17_campaign_report.csv
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 2025-10-17_user_data.xlsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ barcodes/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ batch_001_export.csv
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ redemption_log.csv
‚îú‚îÄ‚îÄ backups/
‚îÇ   ‚îú‚îÄ‚îÄ mongodb/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-17/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ campaigns_backup.gz
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analytics_backup.gz
‚îÇ   ‚îú‚îÄ‚îÄ postgresql/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-17/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ full_backup.sql.gz
‚îî‚îÄ‚îÄ compliance/
    ‚îú‚îÄ‚îÄ audit_logs/
    ‚îÇ   ‚îú‚îÄ‚îÄ 2025/10/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ audit_2025_10_17.json.gz
    ‚îî‚îÄ‚îÄ gdpr_exports/
        ‚îú‚îÄ‚îÄ user_data_export_{user_id}.zip
        ‚îî‚îÄ‚îÄ deletion_confirmations/
```

### 7.5.2 File Metadata Schema

```javascript
// File metadata trong MongoDB
{
  "_id": ObjectId("..."),
  "file_id": "FILE_2025_001234",
  "tenant_id": "brand_001",
  "campaign_id": "CAMP_2025_001",
  
  "file_info": {
    "original_name": "poster_a4_campaign.pdf",
    "stored_name": "ads-formats/brand_001/CAMP_2025_001/original/poster_a4_v1.pdf",
    "file_size": 2048576, // bytes
    "mime_type": "application/pdf",
    "checksum": "sha256_hash_here"
  },
  
  "processing": {
    "status": "completed", // pending, processing, completed, failed
    "qr_embedded": true,
    "thumbnail_generated": true,
    "dpi_validated": true,
    "dpi_value": 300
  },
  
  "usage": {
    "ads_format_type": "poster_a4",
    "print_ready": true,
    "download_count": 25,
    "last_downloaded": ISODate("2025-10-17T14:30:00Z")
  },
  
  "metadata": {
    "dimensions": "210x297mm",
    "qr_position": {"x": 180, "y": 50, "size": "20mm"},
    "color_mode": "CMYK",
    "bleed": "3mm"
  },
  
  "audit": {
    "uploaded_by": "USER_2025_001",
    "uploaded_at": ISODate("2025-10-17T14:00:00Z"),
    "last_modified": ISODate("2025-10-17T14:30:00Z")
  }
}
```

---

## 7.6 Data Migration Strategy

### 7.6.1 Migration Scripts

```sql
-- PostgreSQL migration script example
-- Migration: 001_create_users_table.sql

BEGIN;

-- Create users table
CREATE TABLE users (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    -- ... columns ƒë·ªãnh nghƒ©a nh∆∞ tr√™n
);

-- Insert seed data cho roles
INSERT INTO roles (role_name, role_description, scope_type) 
VALUES 
    ('admin', 'To√†n quy·ªÅn h·ªá th·ªëng', 'global'),
    ('group_admin', 'Qu·∫£n tr·ªã nh√≥m', 'group');

-- Create indexes
CREATE INDEX idx_users_tenant_role ON users(tenant_id, role_id);

COMMIT;
```

```javascript
// MongoDB migration script
// migration_001_create_campaigns_collection.js

db.campaigns.createIndex({"tenant_id": 1, "status": 1});
db.campaigns.createIndex({"campaign_id": 1});
db.campaigns.createIndex({"created_by": 1});

// T·∫°o campaigns m·∫∑c ƒë·ªãnh cho testing
db.campaigns.insertOne({
  "campaign_id": "DEMO_CAMPAIGN_001",
  "tenant_id": "demo_brand",
  "name": "Demo Sampling Campaign",
  "status": "active",
  "dates": {
    "start_date": new Date(),
    "end_date": new Date(Date.now() + 30*24*60*60*1000) // 30 ng√†y
  },
  "created_at": new Date()
});

// T·∫°o collections v·ªõi validation rules
db.createCollection("analytics_events", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["event_type", "timestamp", "campaign_id"],
      properties: {
        event_type: {
          bsonType: "string",
          enum: ["qr_scan", "form_submit", "otp_verify", "barcode_assign", "redemption"]
        },
        timestamp: { bsonType: "date" },
        campaign_id: { bsonType: "string" }
      }
    }
  }
});
```

### 7.6.2 Chi·∫øn l∆∞·ª£c Migration d·ªØ li·ªáu hi·ªán t·∫°i

**Giai ƒëo·∫°n 1 - Schema Setup:**
```bash
# T·∫°o databases
createdb product_sampling_prod
createdb product_sampling_staging

# Ch·∫°y migrations
psql -d product_sampling_prod -f migrations/001_create_users_table.sql
psql -d product_sampling_prod -f migrations/002_create_barcodes_table.sql

# MongoDB setup
mongosh --eval "use product_sampling; load('migrations/001_campaigns.js')"
```

**Giai ƒëo·∫°n 2 - Data Import:**
```python
# Python script cho data import
import pandas as pd
import psycopg2
from pymongo import MongoClient

def migrate_legacy_barcodes():
    """Import barcode t·ª´ h·ªá th·ªëng c≈©"""
    # ƒê·ªçc CSV legacy data
    df = pd.read_csv('legacy_barcodes.csv')
    
    # Validate data
    df['barcode_value'] = df['barcode_value'].str.strip()
    df = df.drop_duplicates(subset=['barcode_value'])
    
    # Insert v√†o PostgreSQL
    conn = psycopg2.connect(DATABASE_URL)
    cursor = conn.cursor()
    
    for _, row in df.iterrows():
        cursor.execute("""
            INSERT INTO barcodes (barcode_value, batch_id, status, expires_at)
            VALUES (%s, %s, 'available', %s)
        """, (row['barcode_value'], row['batch_id'], row['expiry_date']))
    
    conn.commit()
    cursor.close()
    conn.close()

def migrate_user_profiles():
    """Encrypt v√† migrate user data"""
    # Implementation v·ªõi AES encryption
    pass
```

---

## 7.7 Backup v√† Recovery Strategy

### 7.7.1 Backup Schedule (t·ª´ 01-BRD.md v3.0)

**PostgreSQL Backup:**
```bash
#!/bin/bash
# daily_backup.sh

DATE=$(date +%Y-%m-%d)
BACKUP_DIR="/backups/postgresql/${DATE}"
mkdir -p $BACKUP_DIR

# Full backup v·ªõi compression
pg_dump -h localhost -U postgres -d product_sampling \
  --format=custom --compress=9 \
  --file="${BACKUP_DIR}/full_backup.dump"

# Upload to S3
aws s3 cp "${BACKUP_DIR}/full_backup.dump" \
  "s3://product-sampling-backups/postgresql/${DATE}/"

# Verify backup integrity
pg_restore --list "${BACKUP_DIR}/full_backup.dump" > /dev/null
if [ $? -eq 0 ]; then
    echo "Backup verification successful"
else
    echo "Backup verification failed" | mail -s "Backup Alert" admin@company.com
fi
```

**MongoDB Backup:**
```bash
#!/bin/bash
# mongodb_backup.sh

DATE=$(date +%Y-%m-%d)
BACKUP_DIR="/backups/mongodb/${DATE}"
mkdir -p $BACKUP_DIR

# Mongodump v·ªõi compression
mongodump --host localhost:27017 \
  --db product_sampling \
  --gzip \
  --out $BACKUP_DIR

# Upload to S3
aws s3 sync $BACKUP_DIR \
  "s3://product-sampling-backups/mongodb/${DATE}/"

# Verify backup
if [ -f "${BACKUP_DIR}/product_sampling/campaigns.bson.gz" ]; then
    echo "MongoDB backup completed successfully"
else
    echo "MongoDB backup failed"
fi
```

### 7.7.2 Point-in-Time Recovery

**PostgreSQL PITR Setup:**
```sql
-- Enable WAL archiving trong postgresql.conf
archive_mode = on
archive_command = 'cp %p /archive/%f'
wal_level = replica
max_wal_senders = 3

-- Recovery script
-- restore_to_point.sql
SELECT pg_create_restore_point('before_data_corruption');

-- Restore to specific timestamp
-- recovery.conf
restore_command = 'cp /archive/%f %p'
recovery_target_time = '2025-10-17 14:30:00'
```

**MongoDB Replica Set Recovery:**
```javascript
// Replica set configuration
rs.initiate({
  _id: "product_sampling_rs",
  members: [
    { _id: 0, host: "mongo1:27017", priority: 2 },
    { _id: 1, host: "mongo2:27017", priority: 1 },
    { _id: 2, host: "mongo3:27017", arbiterOnly: true }
  ]
});

// Oplog-based recovery
db.runCommand({
  "replSetResizeOplog": 1,
  "size": 10240 // 10GB oplog
});
```

### 7.7.3 Disaster Recovery Plan

**RTO/RPO Targets (t·ª´ 01-BRD.md):**
- **RTO (Recovery Time Objective)**: <4 gi·ªù
- **RPO (Recovery Point Objective)**: <1 gi·ªù

**DR Procedures:**
```yaml
# dr_playbook.yml
disaster_recovery:
  primary_failure:
    - step_1: "Verify primary datacenter status"
    - step_2: "Promote secondary region to primary"
    - step_3: "Update DNS records to point to DR site"
    - step_4: "Verify application functionality"
    - step_5: "Notify stakeholders"
  
  database_corruption:
    - step_1: "Stop application writes"
    - step_2: "Assess corruption scope"
    - step_3: "Restore from latest clean backup"
    - step_4: "Apply transaction logs"
    - step_5: "Verify data integrity"
    - step_6: "Resume operations"
  
  contact_list:
    - primary_dba: "+84901234567"
    - devops_lead: "+84901234568"
    - security_team: "security@company.com"
```

---

## 7.8 Data Security v√† Compliance

### 7.8.1 PII Encryption Strategy (t·ª´ Access_Control_Tree_Grok.md v2.2)

**Application-level Encryption:**
```python
# encryption_utils.py
import cryptography
from cryptography.fernet import Fernet
import hashlib
import base64

class PIIEncryption:
    def __init__(self, master_key):
        self.fernet = Fernet(master_key)
    
    def encrypt_pii(self, plaintext):
        """Encrypt PII data v·ªõi AES-256"""
        if not plaintext:
            return None
        
        encrypted = self.fernet.encrypt(plaintext.encode('utf-8'))
        return base64.b64encode(encrypted).decode('utf-8')
    
    def decrypt_pii(self, encrypted_data):
        """Decrypt PII data"""
        if not encrypted_data:
            return None
            
        encrypted_bytes = base64.b64decode(encrypted_data)
        decrypted = self.fernet.decrypt(encrypted_bytes)
        return decrypted.decode('utf-8')
    
    def hash_identifier(self, identifier):
        """Hash phone/email cho indexing"""
        return hashlib.sha256(identifier.encode('utf-8')).hexdigest()

# Usage example
encryptor = PIIEncryption(os.getenv('MASTER_KEY'))

user_data = {
    "first_name": encryptor.encrypt_pii("Nguy·ªÖn"),
    "last_name": encryptor.encrypt_pii("VƒÉn A"),
    "phone_hash": encryptor.hash_identifier("+84901234567"),
    "email_hash": encryptor.hash_identifier("user@example.com")
}
```

### 7.8.2 GDPR Compliance Implementation

**Data Subject Rights:**
```sql
-- GDPR right to access
CREATE OR REPLACE FUNCTION get_user_data(user_phone_hash VARCHAR)
RETURNS JSON AS $
DECLARE
    user_record RECORD;
    result JSON;
BEGIN
    -- T√¨m user v√† decrypt data
    SELECT u.user_id, u.profile_encrypted, 
           array_agg(b.barcode_value) as barcodes
    FROM users u
    LEFT JOIN barcodes b ON b.assigned_to_user_hash = user_phone_hash
    WHERE u.phone_hash = user_phone_hash
    GROUP BY u.user_id, u.profile_encrypted
    INTO user_record;
    
    -- Build JSON response
    result := json_build_object(
        'user_id', user_record.user_id,
        'profile_data', user_record.profile_encrypted,
        'barcodes', user_record.barcodes,
        'exported_at', NOW()
    );
    
    RETURN result;
END;
$ LANGUAGE plpgsql;

-- GDPR right to erasure
CREATE OR REPLACE FUNCTION delete_user_data(user_phone_hash VARCHAR)
RETURNS BOOLEAN AS $
BEGIN
    -- Start transaction
    BEGIN
        -- Anonymize user profile
        UPDATE users 
        SET profile_encrypted = NULL,
            email_hash = 'DELETED_' || user_id,
            phone_hash = 'DELETED_' || user_id,
            status = 'deleted'
        WHERE phone_hash = user_phone_hash;
        
        -- Update barcodes ƒë·ªÉ remove personal link
        UPDATE barcodes 
        SET assigned_to_user_hash = 'DELETED'
        WHERE assigned_to_user_hash = user_phone_hash;
        
        -- Log deletion cho compliance
        INSERT INTO audit_logs (action, target_id, details)
        VALUES ('gdpr_deletion', user_phone_hash, 'User data deleted per GDPR request');
        
        RETURN TRUE;
    EXCEPTION WHEN OTHERS THEN
        RETURN FALSE;
    END;
END;
$ LANGUAGE plpgsql;
```

### 7.8.3 Data Retention Policy

**Automated Cleanup Jobs:**
```sql
-- Cleanup job cho expired data
CREATE OR REPLACE FUNCTION cleanup_expired_data()
RETURNS VOID AS $
BEGIN
    -- Archive old analytics events (>2 years)
    INSERT INTO analytics_events_archive 
    SELECT * FROM analytics_events 
    WHERE timestamp < NOW() - INTERVAL '2 years';
    
    DELETE FROM analytics_events 
    WHERE timestamp < NOW() - INTERVAL '2 years';
    
    -- Remove expired barcodes
    UPDATE barcodes 
    SET status = 'expired'
    WHERE expires_at < NOW() AND status != 'expired';
    
    -- Archive old audit logs (>7 years)
    INSERT INTO audit_logs_archive
    SELECT * FROM audit_logs
    WHERE created_at < NOW() - INTERVAL '7 years';
    
    DELETE FROM audit_logs
    WHERE created_at < NOW() - INTERVAL '7 years';
    
    RAISE NOTICE 'Data cleanup completed at %', NOW();
END;
$ LANGUAGE plpgsql;

-- Schedule cleanup job
SELECT cron.schedule('cleanup_expired_data', '0 2 * * *', 'SELECT cleanup_expired_data();');
```

---

## 7.9 Performance Optimization

### 7.9.1 Database Indexing Strategy

**PostgreSQL Indexes:**
```sql
-- Composite indexes cho common queries
CREATE INDEX CONCURRENTLY idx_barcodes_tenant_status_created 
ON barcodes(batch_id, status, created_at) 
WHERE status IN ('available', 'assigned');

-- Partial index cho active campaigns
CREATE INDEX CONCURRENTLY idx_users_active_tenant
ON users(tenant_id, role_id, last_login)
WHERE status = 'active';

-- Functional index cho search
CREATE INDEX CONCURRENTLY idx_users_profile_search
ON users USING gin(to_tsvector('english', 
    COALESCE(profile_encrypted, '')));

-- Index cho analytics queries
CREATE INDEX CONCURRENTLY idx_transactions_reporting
ON transactions(tenant_id, billing_period, status)
INCLUDE (amount, currency);
```

**MongoDB Indexes:**
```javascript
// Compound indexes cho analytics
db.analytics_events.createIndex({
  "tenant_id": 1,
  "timestamp": -1,
  "event_type": 1
}, {
  name: "idx_analytics_tenant_time_type"
});

// Sparse index cho optional fields
db.user_profiles.createIndex({
  "phone_hash": 1
}, {
  sparse: true,
  unique: true,
  name: "idx_user_phone_sparse"
});

// TTL index cho temporary data
db.otp_codes.createIndex({
  "expires_at": 1
}, {
  expireAfterSeconds: 0,
  name: "idx_otp_ttl"
});
```

### 7.9.2 Query Optimization

**Common Query Patterns:**
```sql
-- Optimized campaign analytics query
EXPLAIN (ANALYZE, BUFFERS) 
SELECT 
    c.campaign_id,
    c.name,
    COUNT(DISTINCT b.barcode_id) as total_codes,
    COUNT(DISTINCT CASE WHEN b.status = 'redeemed' THEN b.barcode_id END) as redeemed_codes,
    ROUND(
        COUNT(DISTINCT CASE WHEN b.status = 'redeemed' THEN b.barcode_id END)::numeric / 
        NULLIF(COUNT(DISTINCT b.barcode_id), 0) * 100, 
        2
    ) as redemption_rate
FROM campaigns_view c  -- View k·∫øt h·ª£p MongoDB + PostgreSQL
LEFT JOIN barcode_batches bb ON bb.campaign_id = c.campaign_id
LEFT JOIN barcodes b ON b.batch_id = bb.batch_id
WHERE c.tenant_id = $1 
  AND c.status = 'active'
  AND c.start_date <= CURRENT_DATE
  AND c.end_date >= CURRENT_DATE
GROUP BY c.campaign_id, c.name
ORDER BY redemption_rate DESC
LIMIT 10;

-- Index hints cho performance
/*
Required indexes:
- idx_campaigns_tenant_status_dates ON campaigns_view(tenant_id, status, start_date, end_date)
- idx_barcode_batches_campaign ON barcode_batches(campaign_id)
- idx_barcodes_batch_status ON barcodes(batch_id, status)
*/
```

### 7.9.3 Connection Pooling

**PostgreSQL Connection Pool:**
```python
# connection_pool.py
import psycopg2.pool
from contextlib import contextmanager

class DatabasePool:
    def __init__(self, config):
        self.pool = psycopg2.pool.ThreadedConnectionPool(
            minconn=5,
            maxconn=50,
            host=config['host'],
            database=config['database'],
            user=config['user'],
            password=config['password'],
            # Connection pool settings
            keepalives_idle=30,
            keepalives_interval=10,
            keepalives_count=5
        )
    
    @contextmanager
    def get_connection(self):
        conn = self.pool.getconn()
        try:
            yield conn
        finally:
            self.pool.putconn(conn)
    
    def execute_query(self, query, params=None):
        with self.get_connection() as conn:
            with conn.cursor() as cursor:
                cursor.execute(query, params)
                return cursor.fetchall()
```

---

## 7.10 Monitoring v√† Maintenance

### 7.10.1 Database Health Monitoring

**PostgreSQL Monitoring:**
```sql
-- Query ƒë·ªÉ monitor database health
SELECT 
    schemaname,
    tablename,
    n_tup_ins as inserts,
    n_tup_upd as updates,
    n_tup_del as deletes,
    n_live_tup as live_tuples,
    n_dead_tup as dead_tuples,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_live_tup DESC;

-- Index usage statistics
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan as index_scans,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes
WHERE idx_scan < 100  -- Potentially unused indexes
ORDER BY idx_scan;

-- Connection monitoring
SELECT 
    state,
    COUNT(*) as connection_count,
    AVG(EXTRACT(EPOCH FROM NOW() - query_start)) as avg_duration_seconds
FROM pg_stat_activity
WHERE state IS NOT NULL
GROUP BY state;
```

**MongoDB Monitoring:**
```javascript
// MongoDB health checks
db.runCommand({serverStatus: 1});

// Collection statistics
db.campaigns.stats();
db.analytics_events.stats();

// Index usage
db.campaigns.aggregate([
  {$indexStats: {}},
  {$sort: {"accesses.ops": -1}}
]);

// Slow query profiling
db.setProfilingLevel(1, {slowms: 100});
db.system.profile.find().sort({ts: -1}).limit(5);
```

### 7.10.2 Automated Maintenance

**Database Maintenance Script:**
```bash
#!/bin/bash
# db_maintenance.sh

echo "Starting database maintenance at $(date)"

# PostgreSQL maintenance
psql -d product_sampling -c "
    -- Update table statistics
    ANALYZE;
    
    -- Vacuum tables v·ªõi high update frequency
    VACUUM ANALYZE barcodes;
    VACUUM ANALYZE users;
    VACUUM ANALYZE transactions;
    
    -- Reindex if needed
    REINDEX INDEX CONCURRENTLY idx_barcodes_batch_status;
"

# MongoDB maintenance
mongosh --eval "
    use product_sampling;
    
    // Compact collections
    db.runCommand({compact: 'analytics_events'});
    
    // Update index statistics
    db.campaigns.reIndex();
    
    // Clean up expired TTL documents
    db.otp_codes.deleteMany({expires_at: {\$lt: new Date()}});
"

# Redis maintenance
redis-cli BGREWRITEAOF
redis-cli MEMORY PURGE

echo "Database maintenance completed at $(date)"
```

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- System Feature Tree (System_Feature_Tree_Grok.md v4.0) - Y√™u c·∫ßu k·ªπ thu·∫≠t database, multi-tenant, PII encryption
- Access Control Tree (Access_Control_Tree_Grok.md v2.2) - RBAC schema, audit logs, GDPR compliance  
- Business Requirement Document (01-BRD.md v3.0) - Data retention, backup requirements, performance targets
- Problem Definition (Problem.md v1.0) - Scalability requirements, integration constraints

**T√¨nh tr·∫°ng**: Part07 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part08 - Thi·∫øt k·∫ø API v√† t√≠ch h·ª£p  
**Ng∆∞·ªùi ƒë√°nh gi√°**: Database Architect, Security Engineer, DevOps Engineer

# üìã SRS Part08 - Thi·∫øt k·∫ø API v√† t√≠ch h·ª£p (API Design & Integration)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: ƒê·ªôi ph√¢n t√≠ch h·ªá th·ªëng  

---

## 8.1 T·ªïng quan thi·∫øt k·∫ø API

### 8.1.1 Nguy√™n t·∫Øc thi·∫øt k·∫ø API (t·ª´ System_Feature_Tree_Grok.md v4.0)
D·ª±a tr√™n **y√™u c·∫ßu k·ªπ thu·∫≠t t·ªïng quan**, h·ªá th·ªëng API ƒë∆∞·ª£c thi·∫øt k·∫ø theo c√°c nguy√™n t·∫Øc:

- **RESTful design**: Tu√¢n th·ªß chu·∫©n REST v·ªõi HTTP methods chu·∫©n
- **OpenAPI 3.0**: T√†i li·ªáu API ƒë·∫ßy ƒë·ªß v·ªõi schema validation
- **Microservices**: API ph√¢n t√°n theo t·ª´ng service ƒë·ªôc l·∫≠p
- **Rate limiting**: 1000 requests/gi·ªù per API key (t·ª´ System Feature Tree)
- **Multi-tenant**: Ph√¢n t√°ch d·ªØ li·ªáu theo tenant_id
- **Security-first**: OAuth 2.0, JWT, HTTPS only

### 8.1.2 Ki·∫øn tr√∫c API Gateway (t·ª´ 01-BRD.md v3.0)
**M·ª•c ti√™u hi·ªáu nƒÉng:**
- X·ª≠ l√Ω 100,000 requests/ph√∫t t·∫°i gateway
- Response time <3 gi√¢y cho dashboard APIs
- 99.9% uptime SLA cho critical endpoints

**Th√†nh ph·∫ßn API Gateway:**
- **Authentication**: OAuth 2.0/JWT validation
- **Authorization**: RBAC permission checking
- **Rate limiting**: Per-user v√† per-tenant quotas
- **Logging**: Request/response audit trails
- **Monitoring**: Performance metrics v√† error tracking

### 8.1.3 API versioning strategy
```
C·∫•u tr√∫c URL: https://api.productsampling.com/api/v1/{resource}
- v1: Current stable version (MVP)
- v2: Future version v·ªõi breaking changes
- Backward compatibility: 12 th√°ng support cho old versions
```

---

## 8.2 Core API Endpoints

### 8.2.1 Authentication APIs

**POST /api/v1/auth/login**
```json
{
  "summary": "ƒêƒÉng nh·∫≠p ng∆∞·ªùi d√πng",
  "description": "X√°c th·ª±c credentials v√† tr·∫£ v·ªÅ JWT tokens",
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "username": {"type": "string", "example": "admin@brand.com"},
            "password": {"type": "string", "format": "password"},
            "tenant_id": {"type": "string", "example": "brand_001"}
          },
          "required": ["username", "password"]
        }
      }
    }
  },
  "responses": {
    "200": {
      "description": "ƒêƒÉng nh·∫≠p th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "access_token": {"type": "string"},
              "refresh_token": {"type": "string"},
              "expires_in": {"type": "integer", "example": 3600},
              "user": {
                "type": "object",
                "properties": {
                  "user_id": {"type": "string"},
                  "role": {"type": "string", "enum": ["admin", "group_admin", "customer_account", "serving_account", "auditor", "user_role"]},
                  "permissions": {"type": "array", "items": {"type": "string"}},
                  "tenant_id": {"type": "string"}
                }
              }
            }
          }
        }
      }
    },
    "401": {
      "description": "Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá",
      "content": {
        "application/json": {
          "schema": {"$ref": "#/components/schemas/ErrorResponse"}
        }
      }
    },
    "429": {
      "description": "Qu√° nhi·ªÅu attempts - account b·ªã kh√≥a t·∫°m th·ªùi"
    }
  }
}
```

**POST /api/v1/auth/refresh**
```json
{
  "summary": "L√†m m·ªõi access token",
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "refresh_token": {"type": "string"}
          },
          "required": ["refresh_token"]
        }
      }
    }
  },
  "responses": {
    "200": {
      "description": "Token m·ªõi ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "access_token": {"type": "string"},
              "expires_in": {"type": "integer"}
            }
          }
        }
      }
    }
  }
}
```

### 8.2.2 Campaign Management APIs (t·ª´ System_Feature_Tree_Grok.md 1.1)

**POST /api/v1/campaigns**
```json
{
  "summary": "T·∫°o chi·∫øn d·ªãch m·ªõi",
  "description": "Admin/Group Admin/Customer Account t·∫°o campaign v·ªõi barcode assignment",
  "security": [{"BearerAuth": []}],
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "name": {"type": "string", "maxLength": 255, "example": "T√™n chi·∫øn d·ªãch sampling"},
            "description": {"type": "string", "maxLength": 1000},
            "start_date": {"type": "string", "format": "date-time"},
            "end_date": {"type": "string", "format": "date-time"},
            "location_ids": {
              "type": "array",
              "items": {"type": "string"},
              "example": ["HCM_CIRCLE_K_001", "HN_GS25_002"]
            },
            "settings": {
              "type": "object",
              "properties": {
                "max_participants": {"type": "integer", "minimum": 1},
                "budget_limit": {"type": "number", "minimum": 0},
                "cost_per_lead_target": {"type": "number", "maximum": 0.4}
              }
            },
            "targeting": {
              "type": "object",
              "properties": {
                "demographics": {
                  "type": "object",
                  "properties": {
                    "age_min": {"type": "integer", "minimum": 13},
                    "age_max": {"type": "integer", "maximum": 100},
                    "gender": {"type": "string", "enum": ["male", "female", "all"]}
                  }
                }
              }
            },
            "utm_tracking": {
              "type": "object",
              "properties": {
                "utm_source": {"type": "string"},
                "utm_medium": {"type": "string"},
                "utm_campaign": {"type": "string"},
                "utm_term": {"type": "string"},
                "utm_content": {"type": "string"}
              }
            }
          },
          "required": ["name", "start_date", "end_date", "location_ids"]
        }
      }
    }
  },
  "responses": {
    "201": {
      "description": "Chi·∫øn d·ªãch ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "campaign_id": {"type": "string", "example": "CAMP_2025_001"},
              "name": {"type": "string"},
              "status": {"type": "string", "enum": ["draft", "active", "paused", "completed"]},
              "qr_codes": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "location_id": {"type": "string"},
                    "qr_url": {"type": "string", "format": "uri"},
                    "short_link": {"type": "string", "format": "uri"}
                  }
                }
              },
              "created_at": {"type": "string", "format": "date-time"}
            }
          }
        }
      }
    },
    "400": {"description": "D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá"},
    "403": {"description": "Kh√¥ng c√≥ quy·ªÅn t·∫°o campaign trong scope n√†y"},
    "422": {"description": "Business logic validation failed"}
  }
}
```

**GET /api/v1/campaigns**
```json
{
  "summary": "Danh s√°ch campaigns",
  "description": "L·∫•y campaigns theo ph√¢n quy·ªÅn user",
  "security": [{"BearerAuth": []}],
  "parameters": [
    {
      "name": "status",
      "in": "query",
      "schema": {
        "type": "string",
        "enum": ["draft", "active", "paused", "completed"]
      }
    },
    {
      "name": "start_date",
      "in": "query",
      "schema": {"type": "string", "format": "date"}
    },
    {
      "name": "end_date", 
      "in": "query",
      "schema": {"type": "string", "format": "date"}
    },
    {
      "name": "page",
      "in": "query",
      "schema": {"type": "integer", "minimum": 1, "default": 1}
    },
    {
      "name": "limit",
      "in": "query", 
      "schema": {"type": "integer", "minimum": 1, "maximum": 100, "default": 20}
    }
  ],
  "responses": {
    "200": {
      "description": "Danh s√°ch campaigns",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "campaigns": {
                "type": "array",
                "items": {"$ref": "#/components/schemas/Campaign"}
              },
              "pagination": {
                "type": "object",
                "properties": {
                  "page": {"type": "integer"},
                  "limit": {"type": "integer"},
                  "total": {"type": "integer"},
                  "total_pages": {"type": "integer"}
                }
              }
            }
          }
        }
      }
    }
  }
}
```

### 8.2.3 Barcode Management APIs (t·ª´ System_Feature_Tree_Grok.md 1.2)

**POST /api/v1/barcodes/import**
```json
{
  "summary": "Import barcode t·ª´ CSV",
  "description": "Admin/Group Admin/Customer Account import barcode pool",
  "security": [{"BearerAuth": []}],
  "requestBody": {
    "required": true,
    "content": {
      "multipart/form-data": {
        "schema": {
          "type": "object",
          "properties": {
            "file": {
              "type": "string",
              "format": "binary",
              "description": "CSV file v·ªõi columns: barcode, product_name, expiry_date, value, batch_code"
            },
            "campaign_id": {"type": "string"},
            "batch_name": {"type": "string"},
            "validate_only": {"type": "boolean", "default": false}
          },
          "required": ["file", "batch_name"]
        }
      }
    }
  },
  "responses": {
    "202": {
      "description": "File ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "job_id": {"type": "string", "example": "IMPORT_JOB_001"},
              "status": {"type": "string", "enum": ["processing", "completed", "failed"]},
              "preview": {
                "type": "object",
                "properties": {
                  "total_rows": {"type": "integer"},
                  "valid_rows": {"type": "integer"},
                  "invalid_rows": {"type": "integer"},
                  "sample_data": {"type": "array"}
                }
              },
              "estimated_completion": {"type": "string", "format": "date-time"}
            }
          }
        }
      }
    },
    "400": {"description": "File format kh√¥ng h·ª£p l·ªá ho·∫∑c validation errors"}
  }
}
```

**GET /api/v1/barcodes/import/{job_id}/status**
```json
{
  "summary": "Ki·ªÉm tra tr·∫°ng th√°i import job",
  "parameters": [
    {
      "name": "job_id",
      "in": "path",
      "required": true,
      "schema": {"type": "string"}
    }
  ],
  "responses": {
    "200": {
      "description": "Tr·∫°ng th√°i import job",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "job_id": {"type": "string"},
              "status": {"type": "string", "enum": ["processing", "completed", "failed"]},
              "progress": {"type": "number", "minimum": 0, "maximum": 100},
              "results": {
                "type": "object",
                "properties": {
                  "total_processed": {"type": "integer"},
                  "successful_imports": {"type": "integer"},
                  "failed_imports": {"type": "integer"},
                  "batch_id": {"type": "string"},
                  "errors": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "row": {"type": "integer"},
                        "error": {"type": "string"},
                        "data": {"type": "object"}
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```

### 8.2.4 OTP Verification APIs (t·ª´ System_Feature_Tree_Grok.md 1.4)

**POST /api/v1/otp/send**
```json
{
  "summary": "G·ª≠i OTP verification code",
  "description": "G·ª≠i 6-digit OTP qua SMS ho·∫∑c Email v·ªõi fraud prevention",
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "phone": {"type": "string", "pattern": "^\\+[1-9]\\d{1,14}$", "example": "+84901234567"},
            "email": {"type": "string", "format": "email"},
            "method": {"type": "string", "enum": ["sms", "email"], "default": "sms"},
            "campaign_id": {"type": "string"},
            "recaptcha_token": {"type": "string", "description": "reCAPTCHA v3 token"}
          },
          "anyOf": [
            {"required": ["phone"]},
            {"required": ["email"]}
          ],
          "required": ["campaign_id", "recaptcha_token"]
        }
      }
    }
  },
  "responses": {
    "200": {
      "description": "OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "session_id": {"type": "string"},
              "expires_in": {"type": "integer", "example": 300},
              "attempts_remaining": {"type": "integer", "example": 3},
              "method_used": {"type": "string", "enum": ["sms", "email"]},
              "masked_destination": {"type": "string", "example": "+84***123567"}
            }
          }
        }
      }
    },
    "429": {
      "description": "Rate limit exceeded - qu√° nhi·ªÅu OTP requests",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "error": {"type": "string", "example": "rate_limit_exceeded"},
              "retry_after": {"type": "integer", "description": "Seconds until next attempt allowed"},
              "daily_limit": {"type": "integer", "example": 10}
            }
          }
        }
      }
    },
    "400": {"description": "Invalid input ho·∫∑c fraud detection triggered"}
  }
}
```

**POST /api/v1/otp/verify**
```json
{
  "summary": "X√°c th·ª±c OTP code",
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "session_id": {"type": "string"},
            "otp_code": {"type": "string", "pattern": "^[0-9]{6}$"},
            "phone": {"type": "string"},
            "email": {"type": "string", "format": "email"},
            "campaign_id": {"type": "string"}
          },
          "required": ["session_id", "otp_code", "campaign_id"]
        }
      }
    }
  },
  "responses": {
    "200": {
      "description": "OTP x√°c th·ª±c th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "verified": {"type": "boolean", "example": true},
              "user_token": {"type": "string", "description": "Token ƒë·ªÉ claim barcode"},
              "expires_in": {"type": "integer", "example": 1800},
              "next_step": {"type": "string", "example": "barcode_assignment"}
            }
          }
        }
      }
    },
    "400": {
      "description": "OTP kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "error": {"type": "string", "example": "invalid_otp"},
              "attempts_remaining": {"type": "integer"},
              "can_resend": {"type": "boolean"}
            }
          }
        }
      }
    }
  }
}
```

### 8.2.5 Barcode Assignment APIs (t·ª´ System_Feature_Tree_Grok.md 1.6)

**POST /api/v1/barcodes/assign**
```json
{
  "summary": "G√°n barcode cho user ƒë√£ verified",
  "description": "T·ª± ƒë·ªông g√°n barcode t·ª´ pool available sau OTP verification",
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "user_token": {"type": "string", "description": "Token t·ª´ OTP verification"},
            "campaign_id": {"type": "string"},
            "user_preferences": {
              "type": "object",
              "properties": {
                "product_categories": {"type": "array", "items": {"type": "string"}},
                "dietary_restrictions": {"type": "array", "items": {"type": "string"}},
                "location_preference": {"type": "string"}
              }
            },
            "delivery_method": {"type": "string", "enum": ["sms", "email", "wallet"], "default": "sms"}
          },
          "required": ["user_token", "campaign_id"]
        }
      }
    }
  },
  "responses": {
    "201": {
      "description": "Barcode assigned th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "barcode_id": {"type": "string"},
              "barcode_value": {"type": "string"},
              "product_name": {"type": "string"},
              "expires_at": {"type": "string", "format": "date-time"},
              "qr_code_url": {"type": "string", "format": "uri"},
              "wallet_pass": {
                "type": "object",
                "properties": {
                  "apple_wallet_url": {"type": "string", "format": "uri"},
                  "google_pay_url": {"type": "string", "format": "uri"}
                }
              },
              "redemption_locations": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "location_id": {"type": "string"},
                    "name": {"type": "string"},
                    "address": {"type": "string"},
                    "distance_km": {"type": "number"}
                  }
                }
              },
              "user_portal_url": {"type": "string", "format": "uri"}
            }
          }
        }
      }
    },
    "400": {"description": "User token invalid ho·∫∑c campaign kh√¥ng active"},
    "409": {"description": "User ƒë√£ nh·∫≠n barcode cho campaign n√†y"},
    "503": {"description": "Kh√¥ng c√≤n barcode available trong pool"}
  }
}
```

### 8.2.6 POS Redemption APIs (t·ª´ System_Feature_Tree_Grok.md 1.5)

**POST /api/v1/pos/scan**
```json
{
  "summary": "Scan barcode t·∫°i POS",
  "description": "Serving Account scan barcode ƒë·ªÉ validate tr∆∞·ªõc khi redeem",
  "security": [{"BearerAuth": ["pos_access"]}],
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "barcode_value": {"type": "string"},
            "location_id": {"type": "string"},
            "staff_id": {"type": "string"},
            "scan_timestamp": {"type": "string", "format": "date-time"}
          },
          "required": ["barcode_value", "location_id", "staff_id"]
        }
      }
    }
  },
  "responses": {
    "200": {
      "description": "Barcode h·ª£p l·ªá v√† ready ƒë·ªÉ redeem",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "valid": {"type": "boolean", "example": true},
              "barcode_info": {
                "type": "object",
                "properties": {
                  "barcode_id": {"type": "string"},
                  "product_name": {"type": "string"},
                  "campaign_name": {"type": "string"},
                  "expires_at": {"type": "string", "format": "date-time"},
                  "assigned_user": {"type": "string", "description": "Masked user info"}
                }
              },
              "redemption_token": {"type": "string", "description": "Token ƒë·ªÉ complete redemption"},
              "expires_in": {"type": "integer", "example": 300}
            }
          }
        }
      }
    },
    "400": {"description": "Barcode kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng"},
    "403": {"description": "Location kh√¥ng ƒë∆∞·ª£c ph√©p redeem barcode n√†y"},
    "410": {"description": "Barcode ƒë√£ h·∫øt h·∫°n"}
  }
}
```

**POST /api/v1/pos/redeem**
```json
{
  "summary": "Ho√†n t·∫•t redemption process",
  "security": [{"BearerAuth": ["pos_access"]}],
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "redemption_token": {"type": "string"},
            "location_id": {"type": "string"},
            "staff_id": {"type": "string"},
            "notes": {"type": "string", "maxLength": 500}
          },
          "required": ["redemption_token", "location_id", "staff_id"]
        }
      }
    }
  },
  "responses": {
    "200": {
      "description": "Redemption th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "redeemed": {"type": "boolean", "example": true},
              "redemption_id": {"type": "string"},
              "barcode_id": {"type": "string"},
              "redeemed_at": {"type": "string", "format": "date-time"},
              "receipt_data": {
                "type": "object",
                "properties": {
                  "product_name": {"type": "string"},
                  "location_name": {"type": "string"},
                  "staff_name": {"type": "string"},
                  "campaign_name": {"type": "string"}
                }
              }
            }
          }
        }
      }
    },
    "400": {"description": "Redemption token invalid ho·∫∑c expired"},
    "409": {"description": "Barcode ƒë√£ ƒë∆∞·ª£c redeem"}
  }
}
```

### 8.2.7 Analytics APIs (t·ª´ System_Feature_Tree_Grok.md 1.6)

**GET /api/v1/analytics/funnel**
```json
{
  "summary": "Funnel conversion metrics",
  "description": "Realtime funnel tracking: Scan ‚Üí Submit ‚Üí Verify ‚Üí Issue ‚Üí Redeem",
  "security": [{"BearerAuth": []}],
  "parameters": [
    {
      "name": "campaign_id",
      "in": "query",
      "schema": {"type": "string"}
    },
    {
      "name": "start_date",
      "in": "query",
      "schema": {"type": "string", "format": "date"}
    },
    {
      "name": "end_date",
      "in": "query", 
      "schema": {"type": "string", "format": "date"}
    },
    {
      "name": "group_by",
      "in": "query",
      "schema": {"type": "string", "enum": ["day", "hour", "location", "ads_format"]}
    }
  ],
  "responses": {
    "200": {
      "description": "Funnel metrics data",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "funnel_data": {
                "type": "object",
                "properties": {
                  "scans": {"type": "integer"},
                  "form_submissions": {"type": "integer"},
                  "otp_verifications": {"type": "integer"},
                  "barcode_assignments": {"type": "integer"},
                  "redemptions": {"type": "integer"}
                }
              },
              "conversion_rates": {
                "type": "object",
                "properties": {
                  "scan_to_form": {"type": "number", "example": 0.85},
                  "form_to_verify": {"type": "number", "example": 0.92},
                  "verify_to_assign": {"type": "number", "example": 0.98},
                  "assign_to_redeem": {"type": "number", "example": 0.73},
                  "overall_conversion": {"type": "number", "example": 0.52}
                }
              },
              "trends": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "date": {"type": "string", "format": "date"},
                    "scans": {"type": "integer"},
                    "conversions": {"type": "integer"},
                    "rate": {"type": "number"}
                  }
                }
              },
              "cost_metrics": {
                "type": "object",
                "properties": {
                  "cost_per_scan": {"type": "number"},
                  "cost_per_verified_lead": {"type": "number"},
                  "cost_per_redemption": {"type": "number"},
                  "total_spend": {"type": "number"},
                  "roi_estimate": {"type": "number"}
                }
              }
            }
          }
        }
      }
    }
  }
}
```

**POST /api/v1/analytics/export**
```json
{
  "summary": "Export analytics data",
  "description": "Xu·∫•t d·ªØ li·ªáu CSV/Excel cho analysis n√¢ng cao",
  "security": [{"BearerAuth": []}],
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "export_type": {"type": "string", "enum": ["users", "events", "funnel", "campaigns"]},
            "format": {"type": "string", "enum": ["csv", "excel", "json"], "default": "csv"},
            "filters": {
              "type": "object",
              "properties": {
                "campaign_ids": {"type": "array", "items": {"type": "string"}},
                "start_date": {"type": "string", "format": "date"},
                "end_date": {"type": "string", "format": "date"},
                "status": {"type": "string"},
                "location_ids": {"type": "array", "items": {"type": "string"}}
              }
            },
            "columns": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Columns to include in export"
            },
            "include_pii": {"type": "boolean", "default": false, "description": "Requires admin role"}
          },
          "required": ["export_type"]
        }
      }
    }
  },
  "responses": {
    "202": {
      "description": "Export job ƒë∆∞·ª£c t·∫°o",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "job_id": {"type": "string"},
              "status": {"type": "string", "enum": ["queued", "processing", "completed", "failed"]},
              "estimated_completion": {"type": "string", "format": "date-time"},
              "estimated_size": {"type": "string", "example": "2.5MB"}
            }
          }
        }
      }
    }
  }
}
```

---

## 8.3 User Portal APIs (t·ª´ System_Feature_Tree_Grok.md 1.9)

### 8.3.1 User Portal Authentication

**POST /api/v1/portal/auth**
```json
{
  "summary": "ƒêƒÉng nh·∫≠p User Portal b·∫±ng phone/email",
  "description": "Passwordless authentication cho end users",
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "identifier": {"type": "string", "description": "Phone number or email"},
            "otp_code": {"type": "string", "pattern": "^[0-9]{6}$"},
            "session_id": {"type": "string", "description": "From OTP request"}
          },
          "required": ["identifier", "otp_code", "session_id"]
        }
      }
    }
  },
  "responses": {
    "200": {
      "description": "Login th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "access_token": {"type": "string"},
              "user_id": {"type": "string"},
              "profile": {
                "type": "object",
                "properties": {
                  "first_name": {"type": "string"},
                  "total_campaigns": {"type": "integer"},
                  "total_redemptions": {"type": "integer"},
                  "engagement_score": {"type": "integer"}
                }
              }
            }
          }
        }
      }
    }
  }
}
```

### 8.3.2 User Dashboard APIs

**GET /api/v1/portal/dashboard**
```json
{
  "summary": "Dashboard data cho User Portal",
  "security": [{"PortalAuth": []}],
  "responses": {
    "200": {
      "description": "User dashboard data",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "user_stats": {
                "type": "object",
                "properties": {
                  "total_barcodes_received": {"type": "integer"},
                  "total_redeemed": {"type": "integer"},
                  "pending_redemption": {"type": "integer"},
                  "expired_unused": {"type": "integer"},
                  "redemption_rate": {"type": "number"}
                }
              },
              "recent_activity": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "activity_type": {"type": "string", "enum": ["barcode_received", "redeemed", "expired"]},
                    "product_name": {"type": "string"},
                    "campaign_name": {"type": "string"},
                    "date": {"type": "string", "format": "date-time"},
                    "location_name": {"type": "string"}
                  }
                }
              },
              "available_campaigns": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "campaign_id": {"type": "string"},
                    "name": {"type": "string"},
                    "description": {"type": "string"},
                    "product_image": {"type": "string", "format": "uri"},
                    "ends_at": {"type": "string", "format": "date-time"},
                    "locations_nearby": {"type": "integer"}
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```

**GET /api/v1/portal/barcodes**
```json
{
  "summary": "Danh s√°ch barcodes c·ªßa user",
  "security": [{"PortalAuth": []}],
  "parameters": [
    {
      "name": "status",
      "in": "query",
      "schema": {"type": "string", "enum": ["available", "redeemed", "expired"]}
    },
    {
      "name": "page",
      "in": "query",
      "schema": {"type": "integer", "default": 1}
    }
  ],
  "responses": {
    "200": {
      "description": "User barcodes list",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "barcodes": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "barcode_id": {"type": "string"},
                    "barcode_value": {"type": "string"},
                    "product_name": {"type": "string"},
                    "campaign_name": {"type": "string"},
                    "status": {"type": "string"},
                    "assigned_at": {"type": "string", "format": "date-time"},
                    "expires_at": {"type": "string", "format": "date-time"},
                    "redeemed_at": {"type": "string", "format": "date-time"},
                    "redeemed_location": {"type": "string"},
                    "qr_code_url": {"type": "string", "format": "uri"},
                    "wallet_passes": {
                      "type": "object",
                      "properties": {
                        "apple_wallet": {"type": "string", "format": "uri"},
                        "google_pay": {"type": "string", "format": "uri"}
                      }
                    }
                  }
                }
              },
              "pagination": {"$ref": "#/components/schemas/Pagination"}
            }
          }
        }
      }
    }
  }
}
```

### 8.3.3 Support v√† Feedback APIs

**POST /api/v1/portal/tickets**
```json
{
  "summary": "T·∫°o support ticket",
  "security": [{"PortalAuth": []}],
  "requestBody": {
    "required": true,
    "content": {
      "multipart/form-data": {
        "schema": {
          "type": "object",
          "properties": {
            "subject": {"type": "string", "maxLength": 200},
            "description": {"type": "string", "maxLength": 2000},
            "category": {"type": "string", "enum": ["barcode_issue", "redemption_problem", "account_question", "other"]},
            "barcode_id": {"type": "string", "description": "Optional - if related to specific barcode"},
            "priority": {"type": "string", "enum": ["low", "medium", "high"], "default": "medium"},
            "attachments": {
              "type": "array",
              "items": {"type": "string", "format": "binary"},
              "maxItems": 3
            }
          },
          "required": ["subject", "description", "category"]
        }
      }
    }
  },
  "responses": {
    "201": {
      "description": "Ticket created th√†nh c√¥ng",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "ticket_id": {"type": "string"},
              "status": {"type": "string", "enum": ["open", "in_progress", "resolved", "closed"]},
              "created_at": {"type": "string", "format": "date-time"},
              "estimated_response_time": {"type": "string", "example": "24 hours"}
            }
          }
        }
      }
    }
  }
}
```

---

## 8.4 Third-Party Integration APIs

### 8.4.1 CRM Integration (t·ª´ System_Feature_Tree_Grok.md 1.7)

**HubSpot Integration Webhook:**
```json
{
  "webhook_url": "/api/v1/integrations/hubspot/webhook",
  "method": "POST",
  "description": "Nh·∫≠n webhook t·ª´ HubSpot v·ªÅ contact updates",
  "headers": {
    "X-HubSpot-Signature": "sha256=signature",
    "Content-Type": "application/json"
  },
  "payload_example": {
    "subscriptionType": "contact.propertyChange",
    "eventId": 123456789,
    "portalId": 12345,
    "appId": 54321,
    "occurredAt": 1625097600000,
    "subscriptionId": 987654,
    "attemptNumber": 0,
    "objectId": 12345,
    "changeSource": "CRM_UI",
    "propertyName": "email",
    "propertyValue": "new-email@example.com"
  },
  "response": {
    "status_code": 200,
    "body": {
      "received": true,
      "processed_at": "2025-10-17T14:30:00Z"
    }
  }
}
```

**Outbound CRM Sync API:**
```json
{
  "endpoint": "POST /api/v1/integrations/crm/sync",
  "summary": "ƒê·ªìng b·ªô user data v·ªõi CRM system",
  "security": [{"BearerAuth": ["crm_integration"]}],
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "crm_provider": {"type": "string", "enum": ["hubspot", "salesforce", "pipedrive"]},
            "sync_type": {"type": "string", "enum": ["full", "incremental", "specific_users"]},
            "user_ids": {"type": "array", "items": {"type": "string"}},
            "data_mapping": {
              "type": "object",
              "properties": {
                "email_field": {"type": "string", "default": "email"},
                "phone_field": {"type": "string", "default": "phone"},
                "custom_fields": {"type": "object"}
              }
            },
            "consent_only": {"type": "boolean", "default": true}
          },
          "required": ["crm_provider", "sync_type"]
        }
      }
    }
  },
  "responses": {
    "202": {
      "description": "Sync job ƒë∆∞·ª£c t·∫°o",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "sync_job_id": {"type": "string"},
              "status": {"type": "string", "enum": ["queued", "processing", "completed", "failed"]},
              "estimated_records": {"type": "integer"},
              "started_at": {"type": "string", "format": "date-time"}
            }
          }
        }
      }
    }
  }
}
```

### 8.4.2 SMS/Email Provider Integration

**Twilio SMS Integration:**
```python
# Internal service - kh√¥ng expose qua public API
class TwilioService:
    def send_otp_sms(self, phone: str, otp_code: str, template: str):
        """
        G·ª≠i OTP SMS qua Twilio
        - Rate limiting: 10 SMS/hour per phone
        - Template: "M√£ x√°c th·ª±c c·ªßa b·∫°n: {otp_code}. C√≥ hi·ªáu l·ª±c trong 5 ph√∫t."
        - Fallback: MessageBird n·∫øu Twilio failed
        """
        pass

    def send_notification_sms(self, phone: str, message: str):
        """
        G·ª≠i notification SMS
        - Redemption reminders
        - New campaign alerts
        - Expiry warnings
        """
        pass
```

**SendGrid Email Integration:**
```python
class EmailService:
    def send_otp_email(self, email: str, otp_code: str, template_id: str):
        """
        G·ª≠i OTP email qua SendGrid
        - Template-based emails
        - Tracking: open rates, click rates
        - Fallback: AWS SES
        """
        pass

    def send_barcode_email(self, email: str, barcode_data: dict):
        """
        G·ª≠i barcode qua email v·ªõi PDF attachment
        - PDF generation v·ªõi QR code
        - Apple Wallet pass attachment
        - Redemption instructions
        """
        pass
```

### 8.4.3 Payment Integration (Future)

**Stripe Integration cho Subscription:**
```json
{
  "endpoint": "POST /api/v1/billing/subscribe",
  "summary": "T·∫°o subscription cho brand",
  "security": [{"BearerAuth": ["billing_admin"]}],
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "properties": {
            "tenant_id": {"type": "string"},
            "plan_id": {"type": "string", "enum": ["starter", "professional", "enterprise"]},
            "billing_period": {"type": "string", "enum": ["monthly", "yearly"]},
            "payment_method_id": {"type": "string"},
            "tax_id": {"type": "string"},
            "billing_address": {
              "type": "object",
              "properties": {
                "line1": {"type": "string"},
                "city": {"type": "string"},
                "country": {"type": "string"},
                "postal_code": {"type": "string"}
              }
            }
          },
          "required": ["tenant_id", "plan_id", "payment_method_id"]
        }
      }
    }
  },
  "responses": {
    "201": {
      "description": "Subscription created",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "subscription_id": {"type": "string"},
              "status": {"type": "string", "enum": ["active", "trialing", "past_due"]},
              "current_period_start": {"type": "string", "format": "date-time"},
              "current_period_end": {"type": "string", "format": "date-time"},
              "next_billing_date": {"type": "string", "format": "date-time"},
              "amount": {"type": "number"},
              "currency": {"type": "string", "example": "VND"}
            }
          }
        }
      }
    }
  }
}
```

---

## 8.5 API Security v√† Error Handling

### 8.5.1 Authentication & Authorization

**JWT Token Structure:**
```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT",
    "kid": "key_id_2025"
  },
  "payload": {
    "sub": "USER_2025_001",
    "iss": "https://api.productsampling.com",
    "aud": "product-sampling-platform",
    "exp": 1729171200,
    "iat": 1729167600,
    "role": "customer_account",
    "tenant_id": "brand_001",
    "group_id": "group_001",
    "permissions": [
      "campaign.create",
      "campaign.read:own",
      "barcode.import:own",
      "analytics.read:own"
    ],
    "scope": "api_access"
  }
}
```

**Permission Middleware:**
```python
def require_permission(permission: str, scope: str = None):
    """
    Decorator ƒë·ªÉ check permissions ƒë·ªông
    Example: @require_permission("campaign.create", "own")
    """
    def decorator(func):
        def wrapper(*args, **kwargs):
            # Extract JWT token
            # Validate permissions array
            # Check scope restrictions
            # Allow/deny request
            pass
        return wrapper
    return decorator
```

### 8.5.2 Rate Limiting Strategy (t·ª´ System_Feature_Tree_Grok.md y√™u c·∫ßu k·ªπ thu·∫≠t)

**Rate Limit Headers:**
```
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 999
X-RateLimit-Reset: 1729171200
X-RateLimit-Window: 3600
X-RateLimit-Scope: tenant
```

**Rate Limiting Rules:**
```yaml
rate_limits:
  default:
    requests_per_hour: 1000
    burst_limit: 100
  
  endpoints:
    "/api/v1/otp/send":
      requests_per_hour: 10
      per_identifier: phone_number
    
    "/api/v1/barcodes/import":
      requests_per_hour: 5
      file_size_limit: "100MB"
    
    "/api/v1/analytics/export":
      requests_per_hour: 3
      concurrent_limit: 1
  
  by_role:
    admin: 5000
    customer_account: 1000
    serving_account: 500
    user_role: 100
```

### 8.5.3 Error Response Standards

**Standard Error Schema:**
```json
{
  "components": {
    "schemas": {
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "object",
            "properties": {
              "code": {"type": "string", "example": "VALIDATION_FAILED"},
              "message": {"type": "string", "example": "D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá"},
              "details": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "field": {"type": "string"},
                    "error_code": {"type": "string"},
                    "message": {"type": "string"}
                  }
                }
              },
              "request_id": {"type": "string", "example": "REQ_2025_001234"},
              "timestamp": {"type": "string", "format": "date-time"}
            }
          }
        }
      }
    }
  }
}
```

**HTTP Status Codes Usage:**
```yaml
status_codes:
  200: "OK - Request th√†nh c√¥ng"
  201: "Created - Resource ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng"
  202: "Accepted - Request ƒë∆∞·ª£c accept cho background processing"
  400: "Bad Request - Invalid input data"
  401: "Unauthorized - Authentication required"
  403: "Forbidden - Insufficient permissions"
  404: "Not Found - Resource kh√¥ng t·ªìn t·∫°i"
  409: "Conflict - Resource conflict (duplicate, constraint violation)"
  422: "Unprocessable Entity - Business logic validation failed"
  429: "Too Many Requests - Rate limit exceeded"
  500: "Internal Server Error - Server error"
  503: "Service Unavailable - Temporary service unavailable"
```

### 8.5.4 Request/Response Logging

**Audit Log Structure:**
```json
{
  "request_id": "REQ_2025_001234",
  "timestamp": "2025-10-17T14:30:00Z",
  "method": "POST",
  "endpoint": "/api/v1/campaigns",
  "user_id": "USER_2025_001",
  "tenant_id": "brand_001",
  "ip_address_hash": "sha256_hash",
  "user_agent": "Mozilla/5.0...",
  "request_size": 2048,
  "response_status": 201,
  "response_size": 512,
  "processing_time_ms": 150,
  "errors": [],
  "sensitive_data_accessed": false,
  "compliance_flags": ["gdpr_relevant"]
}
```

---

## 8.6 API Documentation v√† Testing

### 8.6.1 OpenAPI 3.0 Specification

**API Documentation Structure:**
```yaml
openapi: 3.0.3
info:
  title: Product Sampling Platform API
  description: |
    API cho h·ªá th·ªëng Product Sampling Platform
    
    ## Authentication
    S·ª≠ d·ª•ng Bearer Token (JWT) trong header:
    ```
    Authorization: Bearer <jwt_token>
    ```
    
    ## Rate Limiting
    - Default: 1000 requests/hour
    - OTP endpoints: 10 requests/hour
    - Export endpoints: 3 requests/hour
    
    ## Error Handling
    T·∫•t c·∫£ errors tr·∫£ v·ªÅ format chu·∫©n v·ªõi error code v√† message.
    
  version: 1.0.0
  contact:
    name: API Support
    email: api-support@productsampling.com
  license:
    name: Proprietary
    
servers:
  - url: https://api.productsampling.com/api/v1
    description: Production server
  - url: https://staging-api.productsampling.com/api/v1  
    description: Staging server

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    
  schemas:
    # Standard schemas ƒë∆∞·ª£c define ·ªü ƒë√¢y
    Campaign: 
      type: object
      # ... schema definition
      
    Barcode:
      type: object
      # ... schema definition
```

### 8.6.2 API Testing Strategy

**Unit Tests cho API Endpoints:**
```python
import pytest
from fastapi.testclient import TestClient
from app import app

client = TestClient(app)

class TestCampaignAPI:
    def setup_method(self):
        """Setup test data tr∆∞·ªõc m·ªói test"""
        self.admin_token = self.get_admin_token()
        self.test_campaign_data = {
            "name": "Test Campaign",
            "start_date": "2025-11-01T00:00:00Z",
            "end_date": "2025-11-30T23:59:59Z",
            "location_ids": ["TEST_LOC_001"]
        }
    
    def test_create_campaign_success(self):
        """Test t·∫°o campaign th√†nh c√¥ng"""
        response = client.post(
            "/api/v1/campaigns",
            json=self.test_campaign_data,
            headers={"Authorization": f"Bearer {self.admin_token}"}
        )
        assert response.status_code == 201
        data = response.json()
        assert "campaign_id" in data
        assert data["name"] == self.test_campaign_data["name"]
    
    def test_create_campaign_invalid_dates(self):
        """Test validation l·ªói khi end_date < start_date"""
        invalid_data = self.test_campaign_data.copy()
        invalid_data["end_date"] = "2025-10-01T00:00:00Z"  # Before start_date
        
        response = client.post(
            "/api/v1/campaigns",
            json=invalid_data,
            headers={"Authorization": f"Bearer {self.admin_token}"}
        )
        assert response.status_code == 400
        assert "end_date must be after start_date" in response.json()["error"]["message"]
    
    def test_get_campaigns_with_pagination(self):
        """Test pagination cho campaigns list"""
        response = client.get(
            "/api/v1/campaigns?page=1&limit=10",
            headers={"Authorization": f"Bearer {self.admin_token}"}
        )
        assert response.status_code == 200
        data = response.json()
        assert "campaigns" in data
        assert "pagination" in data
        assert data["pagination"]["page"] == 1
        assert data["pagination"]["limit"] == 10
```

**Integration Tests:**
```python
class TestCampaignWorkflow:
    """Test end-to-end workflow cho campaign"""
    
    def test_complete_campaign_workflow(self):
        """Test full workflow: Create ‚Üí Import Barcodes ‚Üí QR Scan ‚Üí OTP ‚Üí Assign ‚Üí Redeem"""
        
        # Step 1: T·∫°o campaign
        campaign_response = client.post("/api/v1/campaigns", json=campaign_data)
        campaign_id = campaign_response.json()["campaign_id"]
        
        # Step 2: Import barcodes
        barcode_file = self.create_test_barcode_csv()
        import_response = client.post(
            "/api/v1/barcodes/import",
            files={"file": barcode_file},
            data={"campaign_id": campaign_id}
        )
        assert import_response.status_code == 202
        
        # Step 3: Simulate user scan QR
        # Step 4: OTP verification
        # Step 5: Barcode assignment
        # Step 6: POS redemption
        # Assert final state
```

### 8.6.3 Performance Testing

**Load Testing Script:**
```python
import asyncio
import aiohttp
import time
from concurrent.futures import ThreadPoolExecutor

class APILoadTester:
    def __init__(self, base_url: str, concurrent_users: int = 100):
        self.base_url = base_url
        self.concurrent_users = concurrent_users
        self.results = []
    
    async def test_otp_send_endpoint(self):
        """Load test cho OTP send - critical endpoint"""
        async with aiohttp.ClientSession() as session:
            tasks = []
            for i in range(self.concurrent_users):
                task = self.send_otp_request(session, f"+8490123{i:04d}")
                tasks.append(task)
            
            start_time = time.time()
            responses = await asyncio.gather(*tasks, return_exceptions=True)
            end_time = time.time()
            
            # Analyze results
            success_count = sum(1 for r in responses if isinstance(r, dict) and r.get("status") == 200)
            total_time = end_time - start_time
            
            print(f"OTP Load Test Results:")
            print(f"Concurrent Users: {self.concurrent_users}")
            print(f"Success Rate: {success_count}/{len(responses)} ({success_count/len(responses)*100:.1f}%)")
            print(f"Total Time: {total_time:.2f}s")
            print(f"Requests/second: {len(responses)/total_time:.1f}")
    
    async def send_otp_request(self, session, phone):
        try:
            async with session.post(
                f"{self.base_url}/api/v1/otp/send",
                json={
                    "phone": phone,
                    "campaign_id": "LOAD_TEST_CAMPAIGN",
                    "recaptcha_token": "test_token"
                }
            ) as response:
                return {"status": response.status, "response_time": response.headers.get("X-Response-Time")}
        except Exception as e:
            return {"error": str(e)}

# Ch·∫°y load test
if __name__ == "__main__":
    tester = APILoadTester("https://staging-api.productsampling.com", concurrent_users=1000)
    asyncio.run(tester.test_otp_send_endpoint())
```

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- System Feature Tree (System_Feature_Tree_Grok.md v4.0) - API requirements, rate limiting, technical specifications
- Access Control Tree (Access_Control_Tree_Grok.md v2.2) - RBAC permissions, security requirements
- Business Requirement Document (01-BRD.md v3.0) - Performance targets, SLA requirements
- Problem Definition (Problem.md v1.0) - Integration requirements, third-party services

**T√¨nh tr·∫°ng**: Part08 ho√†n th√†nh ‚úÖ  
**Ti·∫øp theo**: Part09 - Use Case chi ti·∫øt  
**Ng∆∞·ªùi ƒë√°nh gi√°**: API Architect, Security Engineer, Integration Specialist


# üìã SRS Part09 - Use Case chi ti·∫øt (Detailed Use Cases)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: ƒê·ªôi ph√¢n t√≠ch h·ªá th·ªëng  

---

## 9.1 T·ªïng quan Use Cases

### 9.1.1 Ph√¢n lo·∫°i Use Cases (t·ª´ System_Feature_Tree_Grok.md v4.0)
D·ª±a tr√™n **flow v·∫≠n h√†nh** v√† **user stories** trong c√¢y ch·ª©c nƒÉng, h·ªá th·ªëng c√≥ 8 use cases ch√≠nh:

| UC ID | T√™n Use Case | Actor ch√≠nh | M·ª©c ƒë·ªô ∆∞u ti√™n | Ngu·ªìn tham chi·∫øu |
|-------|--------------|-------------|----------------|------------------|
| UC-001 | T·∫°o v√† qu·∫£n l√Ω chi·∫øn d·ªãch sampling | Admin/Brand Manager | Cao | Feature Tree 1.1 |
| UC-002 | Qu·∫£n l√Ω barcode v√† inventory | Admin/Brand Manager | Cao | Feature Tree 1.2 |
| UC-003 | Kh√°ch h√†ng qu√©t QR v√† ƒëi·ªÅn form | End User | Cao | Feature Tree 1.3 |
| UC-004 | X√°c th·ª±c OTP v√† ch·ªëng gian l·∫≠n | End User/System | Cao | Feature Tree 1.4 |
| UC-005 | C·∫•p ph√°t v√† qu·∫£n l√Ω voucher | System/End User | Cao | Feature Tree 1.5 |
| UC-006 | ƒê·ªïi qu√† t·∫°i ƒëi·ªÉm b√°n | Serving Staff/End User | Cao | Feature Tree 1.5 |
| UC-007 | Ph√¢n t√≠ch v√† b√°o c√°o chi·∫øn d·ªãch | Brand Manager/Admin | Trung b√¨nh | Feature Tree 1.6 |
| UC-008 | Qu·∫£n l√Ω User Portal v√† h·ªó tr·ª£ | End User/Admin | Trung b√¨nh | Feature Tree 1.9 |

### 9.1.2 Actors v√† vai tr√≤ (t·ª´ Access_Control_Tree_Grok.md v2.2)

**Primary Actors:**
- **Admin**: To√†n quy·ªÅn h·ªá th·ªëng, thi·∫øt l·∫≠p global configs
- **Group Admin**: Qu·∫£n l√Ω campaigns trong group scope
- **Customer Account (Brand Manager)**: Qu·∫£n l√Ω campaigns ri√™ng
- **Serving Account**: Staff t·∫°i retail nodes, x·ª≠ l√Ω redemption
- **End User**: Kh√°ch h√†ng cu·ªëi s·ª≠ d·ª•ng User Portal
- **Auditor**: Gi√°m s√°t compliance v√† audit logs

**Secondary Actors:**
- **SMS/Email Providers**: Twilio, SendGrid
- **CRM Systems**: HubSpot, Salesforce
- **POS Systems**: Circle K, GS25, Mini Stop
- **Analytics Systems**: GA4, Meta Pixel

---

## 9.2 UC-001: T·∫°o v√† qu·∫£n l√Ω chi·∫øn d·ªãch sampling

### 9.2.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: Admin/Brand Manager t·∫°o v√† qu·∫£n l√Ω chi·∫øn d·ªãch ph√¢n ph·ªëi m·∫´u s·∫£n ph·∫©m v·ªõi targeting ƒë·ªãa l√Ω, ng√¢n s√°ch v√† tracking UTM.

**Ph·∫°m vi**: Campaign lifecycle t·ª´ t·∫°o ƒë·∫øn ho√†n th√†nh
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)
**Stakeholder**: Brands, Marketing teams

### 9.2.2 Preconditions
- Actor ƒë√£ ƒëƒÉng nh·∫≠p v·ªõi role Admin, Group Admin ho·∫∑c Customer Account
- C√≥ √≠t nh·∫•t 1 location ƒë∆∞·ª£c setup trong h·ªá th·ªëng
- C√≥ barcode pool s·∫µn s√†ng ƒë·ªÉ g√°n (optional cho draft)

### 9.2.3 Main Success Scenario
1. **Actor truy c·∫≠p Campaign Management**
   - ƒêƒÉng nh·∫≠p v√†o dashboard
   - Navigate ƒë·∫øn Campaign Management module
   - System hi·ªÉn th·ªã danh s√°ch campaigns theo ph√¢n quy·ªÅn

2. **T·∫°o campaign m·ªõi**
   - Click "T·∫°o Campaign M·ªõi"
   - ƒêi·ªÅn th√¥ng tin c∆° b·∫£n:
     * T√™n campaign (b·∫Øt bu·ªôc, max 255 chars)
     * M√¥ t·∫£ chi ti·∫øt (optional, max 1000 chars)
     * Ng√†y b·∫Øt ƒë·∫ßu/k·∫øt th√∫c (validate: end > start, future dates)
   - System validate input v√† t·∫°o campaign_id duy nh·∫•t

3. **C·∫•u h√¨nh targeting v√† budget**
   - Ch·ªçn locations t·ª´ dropdown (multi-select)
   - Thi·∫øt l·∫≠p targeting demographics:
     * Age range (13-100)
     * Gender filter (male/female/all)
     * Interests (optional)
   - C√†i ƒë·∫∑t budget limits:
     * Max participants
     * Total budget
     * Cost per verified lead target (‚â§ 0.4 USD)

4. **Setup tracking v√† UTM**
   - C·∫•u h√¨nh UTM parameters:
     * utm_source (e.g., "poster", "flyer")
     * utm_medium (e.g., "qr", "digital")
     * utm_campaign (auto-fill campaign_id)
     * utm_term, utm_content (optional)
   - System generate tracking URLs

5. **G√°n barcode pool (optional)**
   - Select t·ª´ available barcode batches
   - Ho·∫∑c skip ƒë·ªÉ import sau
   - System validate barcode availability

6. **Preview v√† publish**
   - Review t·∫•t c·∫£ settings
   - Generate QR codes cho m·ªói location
   - Status: Draft ‚Üí Active
   - System g·ª≠i notification ƒë·∫øn team

### 9.2.4 Alternative Flows

**A1: Validation errors**
- 2a. N·∫øu validation th·∫•t b·∫°i:
  - System hi·ªÉn th·ªã error messages chi ti·∫øt
  - Highlight fields c√≥ l·ªói
  - Actor s·ª≠a v√† retry
  - Continue t·ª´ step 2

**A2: Insufficient permissions**
- 1a. N·∫øu Customer Account c·ªë t·∫°o Global campaign:
  - System reject v·ªõi 403 Forbidden
  - Show message "B·∫°n ch·ªâ c√≥ th·ªÉ t·∫°o campaigns cho brand ri√™ng"
  - Redirect v·ªÅ dashboard

**A3: No available locations**
- 3a. N·∫øu kh√¥ng c√≥ locations available cho user scope:
  - System hi·ªÉn th·ªã empty state
  - Provide link ƒë·∫øn Location Management
  - Suggest contact Admin ƒë·ªÉ setup locations

### 9.2.5 Exception Flows

**E1: System timeout**
- N·∫øu campaign creation timeout (>30s):
  - System save draft automatically
  - Show "Campaign ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m, b·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c sau"
  - Provide link ƒë·ªÉ resume

**E2: Database constraint violation**
- N·∫øu campaign_id duplicate (rare):
  - System retry v·ªõi new ID generation
  - Log incident cho investigation
  - Continue normal flow

### 9.2.6 Postconditions
- Campaign ƒë∆∞·ª£c t·∫°o v·ªõi status "Active" ho·∫∑c "Draft"
- QR codes ƒë∆∞·ª£c generate cho m·ªói location
- Analytics tracking ƒë∆∞·ª£c setup
- Team notifications ƒë∆∞·ª£c g·ª≠i
- Audit log ghi l·∫°i campaign creation

### 9.2.7 Special Requirements
- **Performance**: Campaign creation ph·∫£i ho√†n th√†nh trong <2 ng√†y (business requirement t·ª´ System_Feature_Tree_Grok.md 1.1)
- **Security**: Multi-tenant isolation theo tenant_id
- **Audit**: Full audit trail cho compliance
- **UTM accuracy**: 100% tracking accuracy requirement

---

## 9.3 UC-002: Qu·∫£n l√Ω barcode v√† inventory

### 9.3.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: Admin/Brand Manager import, qu·∫£n l√Ω v√† ƒë·ªëi so√°t barcode/voucher v·ªõi single-use validation v√† lifecycle tracking.

**Ph·∫°m vi**: Barcode lifecycle t·ª´ import ƒë·∫øn reconciliation
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)
**Stakeholder**: Brands, Operations team

### 9.3.2 Preconditions
- Actor c√≥ quy·ªÅn barcode.import theo scope (t·ª´ Access_Control_Tree_Grok.md 2.2)
- CSV file tu√¢n th·ªß format: barcode, product_name, expiry_date, value, batch_code
- File size ‚â§ 100MB, encoding UTF-8

### 9.3.3 Main Success Scenario
1. **Truy c·∫≠p Barcode Management**
   - Navigate ƒë·∫øn Barcode Management module
   - System hi·ªÉn th·ªã overview: total codes, assigned, redeemed, expired

2. **Chu·∫©n b·ªã import file**
   - Download CSV template n·∫øu c·∫ßn
   - Chu·∫©n b·ªã file v·ªõi columns b·∫Øt bu·ªôc:
     * barcode (8-50 chars, alphanumeric)
     * product_name (max 255 chars)
     * expiry_date (ISO date format, future dates only)
     * value (decimal, optional)
     * batch_code (tracking purposes)

3. **Upload v√† validate file**
   - Click "Import Barcodes"
   - Select campaign ƒë·ªÉ g√°n (optional)
   - Upload CSV file
   - System validate:
     * File format v√† encoding
     * Column headers ƒë√∫ng
     * Data types v√† constraints
     * Barcode uniqueness (global unique)

4. **Preview v√† confirm import**
   - System hi·ªÉn th·ªã preview:
     * Total rows: X
     * Valid rows: Y
     * Invalid rows: Z (v·ªõi error details)
   - Review sample data (first 10 rows)
   - Option: "Validate Only" ho·∫∑c "Import"

5. **Process import job**
   - System t·∫°o background job
   - Return job_id cho tracking
   - Process t·ª´ng row v·ªõi error handling
   - Update progress real-time

6. **Verify import results**
   - Check job status via job_id
   - Review import summary:
     * Successful imports: X
     * Failed imports: Y v·ªõi error details
     * Batch_id ƒë∆∞·ª£c t·∫°o
   - Download error report n·∫øu c√≥

### 9.3.4 Alternative Flows

**A1: File validation errors**
- 3a. N·∫øu file format kh√¥ng h·ª£p l·ªá:
  - System show detailed error messages
  - Highlight specific issues (missing columns, wrong encoding, etc.)
  - Provide corrected template download
  - Actor fix file v√† retry

**A2: Duplicate barcodes detected**
- 3b. N·∫øu c√≥ duplicate barcodes trong file ho·∫∑c v·ªõi existing data:
  - System list t·∫•t c·∫£ duplicates
  - Options: Skip duplicates, Replace existing, Cancel import
  - Actor ch·ªçn strategy v√† continue

**A3: Large file processing**
- 4a. N·∫øu file >10K rows:
  - System suggest batch processing
  - Option: Split file th√†nh smaller batches
  - Process t·ª´ng batch sequentially

### 9.3.5 Exception Flows

**E1: Import job failure**
- N·∫øu background job failed:
  - System retry automatically (max 3 times)
  - Log detailed error cho debugging
  - Notify Actor v·ªÅ failure v·ªõi error summary
  - Option: Download partial results n·∫øu c√≥

**E2: Database timeout**
- N·∫øu large batch insert timeout:
  - System switch sang chunked processing
  - Continue t·ª´ last successful chunk
  - Show progress v·ªõi estimated completion time

### 9.3.6 Barcode Lifecycle Management

**Tr·∫°ng th√°i lifecycle (t·ª´ System_Feature_Tree_Grok.md 1.2):**
```
Available ‚Üí Assigned ‚Üí Redeemed
    ‚Üì           ‚Üì         ‚Üì
  Expired    Expired   [Final]
    ‚Üì           ‚Üì
 Revoked    Revoked
```

**State transition rules:**
- Available ‚Üí Assigned: Khi user verify OTP
- Assigned ‚Üí Redeemed: Khi scan t·∫°i POS
- Any ‚Üí Expired: Khi qua expiry_date
- Any ‚Üí Revoked: Manual admin action (fraud cases)

### 9.3.7 Reconciliation Process

**Daily reconciliation workflow:**
1. **System auto-check expiry**
   - Cron job ch·∫°y daily 2AM
   - Update status Available/Assigned ‚Üí Expired n·∫øu qua expiry_date
   - Generate expiry report

2. **Manual reconciliation**
   - Admin import redemption logs t·ª´ external systems
   - Cross-reference v·ªõi internal redemption data
   - Identify discrepancies
   - Generate reconciliation report

3. **Inventory accuracy check**
   - Compare database counts v·ªõi physical inventory
   - Flag discrepancies >5% cho investigation
   - Update inventory adjustments n·∫øu c·∫ßn

### 9.3.8 Postconditions
- Barcodes imported v·ªõi status "Available"
- Batch record created v·ªõi tracking info
- Inventory counts updated
- Import job log saved v·ªõi full audit trail
- Notifications sent cho relevant stakeholders

### 9.3.9 Special Requirements
- **Performance**: Import <10MB file trong <30 gi√¢y
- **Accuracy**: 100% barcode uniqueness enforcement
- **Inventory**: >95% accuracy requirement
- **Audit**: Immutable audit trail cho compliance

---

## 9.4 UC-003: Kh√°ch h√†ng qu√©t QR v√† ƒëi·ªÅn form

### 9.4.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: End user qu√©t QR code t·ª´ ads format, truy c·∫≠p landing page v√† ƒëi·ªÅn form thu th·∫≠p d·ªØ li·ªáu v·ªõi quiz preferences.

**Ph·∫°m vi**: User journey t·ª´ QR scan ƒë·∫øn form submission
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)  
**Stakeholder**: End users, Brands

### 9.4.2 Preconditions
- Campaign ƒëang active (status = "active")
- QR code h·ª£p l·ªá v√† ch∆∞a expired
- User c√≥ smartphone/device v·ªõi camera
- Landing page accessible (99.9% uptime requirement)

### 9.4.3 Main Success Scenario

1. **Qu√©t QR code**
   - User th·∫•y ads format (poster, flyer, digital banner) t·∫°i location
   - M·ªü camera app ho·∫∑c QR scanner
   - Qu√©t QR code tr√™n ads
   - System redirect ƒë·∫øn landing page v·ªõi campaign_id, location_id, ads_format_id trong URL

2. **Load landing page**
   - System load landing page responsive (<2 gi√¢y tr√™n mobile 3G)
   - Hi·ªÉn th·ªã campaign info:
     * Product image v√† description
     * Brand information
     * Value proposition
     * Terms & conditions link
   - Track analytics event: "qr_scan"

3. **ƒêi·ªÅn form th√¥ng tin c∆° b·∫£n**
   - Form v·ªõi fields b·∫Øt bu·ªôc:
     * H·ªç t√™n (validation: kh√¥ng ch·ª©a s·ªë)
     * Email (validation: format email h·ª£p l·ªá)
     * S·ªë ƒëi·ªán tho·∫°i (validation: VN format +84...)
   - Fields optional:
     * Tu·ªïi (dropdown: <18, 18-24, 25-34, 35-44, 45-54, 55+)
     * Gi·ªõi t√≠nh (radio: Nam/N·ªØ/Kh√°c)
     * Th√†nh ph·ªë (dropdown: major cities)

4. **Tham gia quiz preferences**
   - System hi·ªÉn th·ªã 5-10 c√¢u h·ªèi multiple choice:
     * "B·∫°n th∆∞·ªùng mua s·∫Øm ·ªü ƒë√¢u?" (Online/Store/Both)
     * "Lo·∫°i s·∫£n ph·∫©m y√™u th√≠ch?" (Food/Beauty/Tech/Fashion)
     * "Frequency of trying new products?" (Weekly/Monthly/Rarely)
     * "Preferred communication channel?" (SMS/Email/Social)
   - Each answer c√≥ scoring ƒë·ªÉ build user profile

5. **Ch·∫•p nh·∫≠n terms v√† consent**
   - Checkboxes b·∫Øt bu·ªôc:
     * "T√¥i ƒë·ªìng √Ω v·ªõi Terms & Conditions"
     * "T√¥i ƒë·ªìng √Ω x·ª≠ l√Ω d·ªØ li·ªáu c√° nh√¢n theo GDPR/PDPA"
   - Checkboxes optional:
     * "Nh·∫≠n th√¥ng tin marketing qua email"
     * "Nh·∫≠n th√¥ng tin marketing qua SMS"
     * "Chia s·∫ª data v·ªõi partners"

6. **Submit form v·ªõi reCAPTCHA**
   - System validate t·∫•t c·∫£ required fields
   - reCAPTCHA v3 validation (score >0.5)
   - Track analytics event: "form_submit"
   - Show loading spinner

7. **X·ª≠ l√Ω submission**
   - System hash PII data (phone, email)
   - Encrypt sensitive fields (name, preferences)
   - Store trong database v·ªõi consent flags
   - Generate session_id cho OTP step
   - Redirect ƒë·∫øn OTP verification page

### 9.4.4 Alternative Flows

**A1: Form validation errors**
- 6a. N·∫øu c√≥ validation errors:
  - Highlight fields c√≥ l·ªói v·ªõi error messages
  - Scroll ƒë·∫øn field ƒë·∫ßu ti√™n c√≥ l·ªói
  - Keep existing data trong form
  - User fix errors v√† re-submit

**A2: Campaign inactive/expired**
- 1a. N·∫øu campaign kh√¥ng active:
  - Show message "Campaign ƒë√£ k·∫øt th√∫c"
  - Provide link ƒë·∫øn other active campaigns
  - Track event: "campaign_expired_access"

**A3: Location restriction**
- 1b. N·∫øu user location kh√¥ng match campaign targeting:
  - Show message "Campaign kh√¥ng available t·∫°i khu v·ª±c n√†y"
  - Suggest nearby locations n·∫øu c√≥
  - Option: Continue anyway v·ªõi warning

**A4: reCAPTCHA failed**
- 6b. N·∫øu reCAPTCHA score <0.5:
  - Show traditional CAPTCHA challenge
  - User solve CAPTCHA
  - Re-validate v√† continue

### 9.4.5 Exception Flows

**E1: Network connectivity issues**
- N·∫øu form submit failed do network:
  - Auto-save form data locally (localStorage)
  - Show retry button
  - Auto-retry khi connection restored
  - Prevent data loss

**E2: Server overload**
- N·∫øu server response >10 gi√¢y:
  - Show "High traffic, please wait" message
  - Implement queue system
  - Provide estimated wait time
  - Option: Get notified when ready

### 9.4.6 User Experience Requirements

**Performance targets (t·ª´ System_Feature_Tree_Grok.md 1.3):**
- Landing page load: <2 gi√¢y tr√™n mobile 3G
- Form completion time: <30 gi√¢y average
- Form completion rate: >90%
- Data quality score: >95%

**Responsive design:**
- Mobile-first PWA design
- Touch-friendly inputs
- Auto-complete enabled
- Keyboard optimization
- Accessibility WCAG 2.1 AA compliant

**Progressive disclosure:**
- Show form steps progressively
- Progress indicator (Step 1/3)
- Save progress locally
- Clear next step instructions

### 9.4.7 Data Collection Strategy

**Profile scoring algorithm:**
```python
def calculate_profile_score(quiz_responses):
    score = 0
    
    # Shopping frequency (0-20 points)
    if quiz_responses.get('shopping_frequency') == 'weekly':
        score += 20
    elif quiz_responses.get('shopping_frequency') == 'monthly':
        score += 10
    
    # Product trial willingness (0-25 points)
    if quiz_responses.get('try_new_products') == 'always':
        score += 25
    elif quiz_responses.get('try_new_products') == 'sometimes':
        score += 15
    
    # Brand loyalty (0-15 points)
    if quiz_responses.get('brand_loyalty') == 'low':
        score += 15  # More likely to try new brands
    
    # Communication preference (0-10 points)
    if quiz_responses.get('communication') in ['email', 'sms']:
        score += 10
    
    return min(score, 100)  # Cap at 100
```

### 9.4.8 Analytics Tracking

**Events tracked:**
```javascript
// GA4 event tracking
gtag('event', 'qr_scan', {
  campaign_id: 'CAMP_2025_001',
  location_id: 'HCM_CIRCLE_K_001',
  ads_format_id: 'POSTER_A4_001',
  user_agent: navigator.userAgent,
  timestamp: new Date().toISOString()
});

gtag('event', 'form_start', {
  campaign_id: 'CAMP_2025_001',
  form_version: 'v1.2'
});

gtag('event', 'form_submit', {
  campaign_id: 'CAMP_2025_001', 
  completion_time: 45, // seconds
  quiz_completed: true,
  consent_marketing: true
});
```

### 9.4.9 Postconditions
- User profile created v·ªõi encrypted PII
- Quiz responses scored v√† stored
- Consent preferences recorded
- Analytics events tracked
- Session prepared cho OTP verification
- User redirected ƒë·∫øn OTP page

### 9.4.10 Special Requirements
- **GDPR/PDPA Compliance**: Explicit consent collection
- **Data Quality**: >95% valid data requirement
- **Fraud Prevention**: reCAPTCHA v√† device fingerprinting
- **Accessibility**: Support screen readers v√† keyboard navigation

---

## 9.5 UC-004: X√°c th·ª±c OTP v√† ch·ªëng gian l·∫≠n

### 9.5.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: System g·ª≠i v√† verify OTP code ƒë·ªÉ x√°c th·ª±c user th·∫≠t, k·∫øt h·ª£p v·ªõi fraud detection ƒë·ªÉ ch·ªëng spam v√† bot attacks.

**Ph·∫°m vi**: OTP generation, delivery, verification v√† fraud prevention
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng quan tr·ªçng (critical)
**Stakeholder**: End users, Security team

### 9.5.2 Preconditions
- User ƒë√£ complete form submission (UC-003)
- Phone/email ƒë√£ ƒë∆∞·ª£c validate format
- Session_id h·ª£p l·ªá t·ª´ form submission
- SMS/Email providers (Twilio/SendGrid) online

### 9.5.3 Main Success Scenario

1. **Generate v√† g·ª≠i OTP**
   - System receive OTP request v·ªõi session_id
   - Validate session (kh√¥ng expired, ch∆∞a verified)
   - Generate 6-digit random code
   - Store trong Redis v·ªõi TTL 5 ph√∫t
   - Determine delivery method (SMS priority, email fallback)

2. **Fraud detection pre-check**
   - Check rate limiting rules:
     * Max 10 OTP requests/24h per phone number
     * Max 3 requests/hour per session
     * Max 100 requests/hour per IP
   - Device fingerprinting analysis
   - Disposable email detection
   - VPN/proxy detection

3. **Deliver OTP message**
   - SMS via Twilio: "M√£ x√°c th·ª±c c·ªßa b·∫°n: {code}. C√≥ hi·ªáu l·ª±c trong 5 ph√∫t."
   - Email template v·ªõi branding v√† instructions
   - Track delivery status (sent/delivered/failed)
   - Start 5-minute countdown timer

4. **User nh·∫≠p OTP code**
   - User receive SMS/email
   - Enter 6-digit code trong form
   - System validate format (numeric, 6 digits)
   - Submit verification request

5. **Verify OTP code**
   - Validate session_id v√† OTP code
   - Check expiration (5 ph√∫t window)
   - Compare v·ªõi stored code trong Redis
   - Track attempt count (max 3 attempts)

6. **Successful verification**
   - Mark session as verified
   - Generate user_token cho barcode assignment
   - Clear OTP t·ª´ Redis
   - Track analytics: "otp_verified"
   - Redirect ƒë·∫øn barcode assignment page

### 9.5.4 Alternative Flows

**A1: Invalid OTP code**
- 5a. N·∫øu OTP code sai:
  - Increment attempt counter
  - Show error: "M√£ OTP kh√¥ng ƒë√∫ng"
  - Display attempts remaining (3-current_attempts)
  - If attempts < 3: Allow retry
  - If attempts = 3: Block session, require new OTP

**A2: Expired OTP**
- 5b. N·∫øu OTP ƒë√£ expired (>5 ph√∫t):
  - Show error: "M√£ OTP ƒë√£ h·∫øt h·∫°n"
  - Clear expired code t·ª´ Redis
  - Show "G·ª≠i l·∫°i OTP" button
  - User click ƒë·ªÉ request new OTP

**A3: Rate limit exceeded**
- 1a. N·∫øu v∆∞·ª£t rate limit:
  - Show error: "B·∫°n ƒë√£ y√™u c·∫ßu qu√° nhi·ªÅu OTP. Vui l√≤ng th·ª≠ l·∫°i sau X ph√∫t"
  - Display countdown timer
  - Block new requests until cooldown
  - Log suspicious activity

**A4: SMS delivery failed**
- 3a. N·∫øu SMS failed (network issue, invalid number):
  - Auto-fallback sang email delivery
  - Update delivery method trong session
  - Show message: "SMS kh√¥ng th·ªÉ g·ª≠i, ƒë√£ g·ª≠i qua email"
  - Continue normal flow

**A5: Disposable email detected**
- 2a. N·∫øu detect disposable email:
  - Require phone verification thay v√¨ email
  - Show message: "Vui l√≤ng s·ª≠ d·ª•ng email th∆∞·ªùng xuy√™n"
  - Option: Update email address

### 9.5.5 Exception Flows

**E1: All delivery methods failed**
- N·∫øu c·∫£ SMS v√† email ƒë·ªÅu failed:
  - Log critical error cho investigation
  - Show fallback message: "H·ªá th·ªëng ƒëang b·∫£o tr√¨, vui l√≤ng th·ª≠ l·∫°i sau"
  - Queue retry job cho later processing
  - Notify operations team

**E2: Redis unavailable**
- N·∫øu Redis cache down:
  - Fallback sang database storage
  - Continue OTP flow v·ªõi slightly higher latency
  - Alert DevOps team ƒë·ªÉ fix Redis

### 9.5.6 Fraud Detection Rules

**Velocity checks:**
```python
class FraudDetection:
    def check_otp_velocity(self, phone_number, ip_address):
        rules = [
            # Phone-based limits
            ("phone_hourly", phone_number, 3, 3600),
            ("phone_daily", phone_number, 10, 86400),
            
            # IP-based limits  
            ("ip_hourly", ip_address, 100, 3600),
            ("ip_daily", ip_address, 1000, 86400),
        ]
        
        for rule_name, identifier, limit, window in rules:
            count = redis.get(f"rate_limit:{rule_name}:{identifier}") or 0
            if int(count) >= limit:
                return False, f"Rate limit exceeded for {rule_name}"
        
        return True, None
    
    def check_suspicious_patterns(self, request_data):
        suspicion_score = 0
        
        # Check device fingerprint
        if self.is_known_bot_signature(request_data.user_agent):
            suspicion_score += 50
        
        # Check request timing patterns
        if self.detect_automated_timing(request_data.session_id):
            suspicion_score += 30
        
        # Check geolocation inconsistency
        if self.detect_geo_impossible_travel(request_data.ip_address):
            suspicion_score += 40
        
        return suspicion_score > 70  # Threshold for blocking
```

**Device fingerprinting:**
```javascript
// Client-side fingerprinting
function generateDeviceFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Device fingerprint', 2, 2);
    
    const fingerprint = {
        screen: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        platform: navigator.platform,
        canvas_hash: btoa(canvas.toDataURL()),
        user_agent_hash: btoa(navigator.userAgent).substring(0, 32)
    };
    
    return btoa(JSON.stringify(fingerprint));
}
```

### 9.5.7 Performance Requirements

**Delivery SLA (t·ª´ System_Feature_Tree_Grok.md 1.4):**
- OTP delivery time: <30 gi√¢y
- Verification success rate: >95%
- Fraud detection accuracy: >90%
- System response time: <3 gi√¢y

**Scalability:**
- Support 20,000 OTP requests/ph√∫t during peak
- Redis TTL management cho memory efficiency
- Auto-scaling SMS/email provider capacity

### 9.5.8 Security Measures

**OTP generation security:**
```python
import secrets
import hashlib

def generate_secure_otp():
    # Use cryptographically secure random
    code = secrets.randbelow(1000000)
    return f"{code:06d}"  # Pad with leading zeros

def hash_otp_for_storage(otp_code, session_id):
    # Hash OTP before storing in Redis
    combined = f"{otp_code}:{session_id}"
    return hashlib.sha256(combined.encode()).hexdigest()
```

**Anti-enumeration measures:**
- Constant-time comparison cho OTP validation
- No difference trong response time between valid/invalid codes
- Rate limiting applies even for valid attempts
- Log all verification attempts cho fraud analysis

### 9.5.9 Monitoring v√† Alerting

**Key metrics to monitor:**
```yaml
otp_metrics:
  delivery_rate:
    sms_success_rate: ">95%"
    email_success_rate: ">98%"
    delivery_time_p95: "<30s"
  
  verification_rate:
    first_attempt_success: ">85%"
    overall_success_rate: ">95%"
    
  fraud_detection:
    blocked_attempts_ratio: "<5%"
    false_positive_rate: "<1%"
    
  system_health:
    redis_availability: ">99.9%"
    provider_uptime: ">99.5%"
```

**Alerting rules:**
- SMS delivery rate <90% ‚Üí Alert SMS team
- Fraud detection spike >10% ‚Üí Alert security team
- OTP delivery time >60s ‚Üí Alert infrastructure team

### 9.5.10 Postconditions
- User successfully verified v·ªõi valid phone/email
- Session marked as verified trong database
- User_token generated cho next step
- Fraud score calculated v√† stored
- Analytics events logged
- Rate limiting counters updated

### 9.5.11 Special Requirements
- **Zero false positives** cho legitimate users
- **Fraud rate <5%** requirement
- **GDPR compliance** cho data retention
- **Telco compliance** cho SMS regulations

---

## 9.6 UC-005: C·∫•p ph√°t v√† qu·∫£n l√Ω voucher

### 9.6.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: System t·ª± ƒë·ªông g√°n barcode t·ª´ available pool cho user ƒë√£ verified, v·ªõi personalization d·ª±a tr√™n preferences v√† support mobile wallet integration.

**Ph·∫°m vi**: Barcode assignment t·ª´ pool ƒë·∫øn user delivery
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)
**Stakeholder**: End users, Brands

### 9.6.2 Preconditions
- User ƒë√£ verify OTP th√†nh c√¥ng (UC-004)
- User_token h·ª£p l·ªá v√† ch∆∞a expired
- Campaign c√≥ available barcodes trong pool
- Barcode pool ch∆∞a exhausted
- Mobile wallet services (Apple Wallet/Google Pay) available

### 9.6.3 Main Success Scenario

1. **Receive barcode assignment request**
   - User redirect t·ª´ OTP verification v·ªõi user_token
   - System validate user_token (signature, expiration)
   - Extract campaign_id, user_preferences t·ª´ token
   - Check campaign status (still active, not expired)

2. **Select optimal barcode t·ª´ pool**
   - Query available barcodes trong campaign pool
   - Apply personalization logic:
     * Match product variant v·ªõi user preferences
     * Consider location proximity cho redemption
     * Check expiry dates (prioritize shorter expiry)
     * Apply any business rules (VIP users, etc.)

3. **Atomic barcode assignment**
   - Begin database transaction
   - Lock selected barcode row
   - Update status: Available ‚Üí Assigned
   - Store assignment metadata:
     * assigned_to_user_hash (SHA-256 c·ªßa phone/email)
     * assigned_at timestamp
     * assignment_campaign_id
     * user_preferences_snapshot
   - Commit transaction

4. **Generate delivery assets**
   - Create QR code image (PNG, 300x300px)
   - Generate PDF voucher v·ªõi branding
   - Create Apple Wallet pass (.pkpass file)
   - Generate Google Pay pass URL
   - Prepare redemption instructions

5. **Deliver barcode ƒë·∫øn user**
   - Primary method: Display trong browser v·ªõi QR code
   - Secondary: SMS v·ªõi download link
   - Optional: Email v·ªõi PDF attachment
   - Mobile wallet: Show "Add to Wallet" buttons
   - Link ƒë·∫øn User Portal cho future access

6. **Update analytics v√† notifications**
   - Track event: "barcode_assigned"
   - Update campaign metrics (assigned_codes count)
   - Send success notification ƒë·∫øn user
   - Queue background jobs (CRM sync, analytics processing)

### 9.6.4 Alternative Flows

**A1: No available barcodes**
- 2a. N·∫øu campaign pool exhausted:
  - Check other campaigns t·ª´ same brand
  - Show waitlist signup option
  - Offer alternative products/campaigns
  - Notify brand v·ªÅ inventory shortage

**A2: Personalization engine kh√¥ng t√¨m ƒë∆∞·ª£c match**
- 2b. N·∫øu kh√¥ng c√≥ barcode match user preferences:
  - Fall back sang random assignment t·ª´ available pool
  - Log mismatch cho future optimization
  - Continue normal flow

**A3: User ƒë√£ receive barcode cho campaign n√†y**
- 1a. N·∫øu detect duplicate assignment:
  - Check existing assignment status
  - If still valid: Redirect ƒë·∫øn existing barcode display
  - If expired: Allow new assignment
  - If redeemed: Show completion message

**A4: Mobile wallet generation failed**
- 4a. N·∫øu Apple Wallet/Google Pay API failed:
  - Continue v·ªõi QR code v√† PDF
  - Show message: "Mobile wallet t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng"
  - Provide manual add instructions

### 9.6.5 Exception Flows

**E1: Database transaction failed**
- N·∫øu assignment transaction failed:
  - Rollback transaction
  - Log error details cho investigation
  - Retry v·ªõi different barcode (up to 3 times)
  - If all retries failed: Show error page v·ªõi support contact

**E2: QR code generation service down**
- N·∫øu QR generation failed:
  - Fall back sang text-based barcode display
  - Queue QR generation job cho later processing
  - Email QR code khi ready

### 9.6.6 Personalization Algorithm

**Barcode selection logic:**
```python
class BarcodePersonalization:
    def select_optimal_barcode(self, user_preferences, available_barcodes):
        scored_barcodes = []
        
        for barcode in available_barcodes:
            score = 0
            
            # Product category matching (0-40 points)
            if barcode.product_category in user_preferences.get('categories', []):
                score += 40
            
            # Location proximity (0-20 points)
            user_location = user_preferences.get('city')
            if barcode.preferred_locations and user_location:
                if user_location in barcode.preferred_locations:
                    score += 20
            
            # Expiry urgency (0-15 points)
            days_to_expiry = (barcode.expires_at - datetime.now()).days
            if days_to_expiry <= 30:
                score += 15  # Prioritize soon-to-expire items
            elif days_to_expiry <= 60:
                score += 10
            
            # Dietary restrictions (0-25 points)
            user_restrictions = user_preferences.get('dietary_restrictions', [])
            if not any(restriction in barcode.ingredients for restriction in user_restrictions):
                score += 25
            
            scored_barcodes.append((barcode, score))
        
        # Sort by score descending, return top match
        scored_barcodes.sort(key=lambda x: x[1], reverse=True)
        return scored_barcodes[0][0] if scored_barcodes else None
```

### 9.6.7 Mobile Wallet Integration

**Apple Wallet Pass Generation:**
```python
import passbook

def create_apple_wallet_pass(barcode_data, user_info):
    # Create pass structure
    pass_info = {
        'passTypeIdentifier': 'pass.com.productsampling.voucher',
        'serialNumber': barcode_data.barcode_id,
        'teamIdentifier': 'TEAM_ID',
        'organizationName': barcode_data.brand_name,
        'description': f'Voucher cho {barcode_data.product_name}',
        'formatVersion': 1,
        'backgroundColor': 'rgb(60, 165, 255)',
        'foregroundColor': 'rgb(255, 255, 255)',
        'barcode': {
            'format': 'PKBarcodeFormatQR',
            'message': barcode_data.barcode_value,
            'messageEncoding': 'iso-8859-1'
        },
        'generic': {
            'primaryFields': [{
                'key': 'product',
                'label': 'S·∫£n ph·∫©m',
                'value': barcode_data.product_name
            }],
            'secondaryFields': [{
                'key': 'expires',
                'label': 'H·∫øt h·∫°n',
                'value': barcode_data.expires_at.strftime('%d/%m/%Y')
            }],
            'auxiliaryFields': [{
                'key': 'instructions',
                'label': 'H∆∞·ªõng d·∫´n',
                'value': 'Qu√©t m√£ t·∫°i c·ª≠a h√†ng ƒë·ªÉ nh·∫≠n qu√†'
            }]
        },
        'locations': [
            {
                'latitude': location.latitude,
                'longitude': location.longitude,
                'relevantText': f'ƒê·ªïi qu√† t·∫°i {location.name}'
            } for location in barcode_data.redemption_locations
        ]
    }
    
    # Generate signed .pkpass file
    pass_file = passbook.Pass(pass_info, key='private_key.pem', cert='certificate.pem')
    return pass_file.create()
```

**Google Pay Integration:**
```python
def create_google_pay_pass(barcode_data):
    pass_object = {
        'kind': 'walletobjects#genericObject',
        'id': f'voucher_{barcode_data.barcode_id}',
        'classId': 'ISSUER_ID.voucher_class',
        'genericType': 'GENERIC_TYPE_UNSPECIFIED',
        'hexBackgroundColor': '#3CA5FF',
        'logo': {
            'sourceUri': {
                'uri': 'https://brand.com/logo.png'
            }
        },
        'cardTitle': {
            'defaultValue': {
                'language': 'vi',
                'value': barcode_data.product_name
            }
        },
        'subheader': {
            'defaultValue': {
                'language': 'vi', 
                'value': 'Voucher d√πng th·ª≠'
            }
        },
        'header': {
            'defaultValue': {
                'language': 'vi',
                'value': barcode_data.brand_name
            }
        },
        'barcode': {
            'type': 'QR_CODE',
            'value': barcode_data.barcode_value
        },
        'heroImage': {
            'sourceUri': {
                'uri': barcode_data.product_image_url
            }
        }
    }
    
    return generate_google_pay_url(pass_object)
```

### 9.6.8 User Portal Integration

**Redirect ƒë·∫øn User Portal:**
```javascript
// After successful barcode assignment
function redirectToUserPortal(barcode_data) {
    const portal_url = `https://portal.productsampling.com/dashboard`;
    const params = new URLSearchParams({
        barcode_id: barcode_data.barcode_id,
        first_time: 'true',
        source: 'assignment'
    });
    
    // Store barcode info trong localStorage cho offline access
    localStorage.setItem('latest_barcode', JSON.stringify({
        barcode_id: barcode_data.barcode_id,
        product_name: barcode_data.product_name,
        expires_at: barcode_data.expires_at,
        qr_code_url: barcode_data.qr_code_url
    }));
    
    window.location.href = `${portal_url}?${params.toString()}`;
}
```

### 9.6.9 Performance Requirements

**Assignment SLA (t·ª´ System_Feature_Tree_Grok.md 1.5):**
- Assignment time: <2 gi√¢y post-verification
- QR generation: <5 gi√¢y
- Mobile wallet generation: <10 gi√¢y
- 100% barcode uniqueness guarantee

**Concurrency handling:**
- Handle 1000 simultaneous assignments
- Optimistic locking cho barcode selection
- Retry logic cho race conditions
- Queue overflow protection

### 9.6.10 Analytics v√† Tracking

**Assignment metrics:**
```python
def track_assignment_analytics(barcode_data, user_data, assignment_context):
    analytics_event = {
        'event_type': 'barcode_assigned',
        'timestamp': datetime.now().isoformat(),
        'campaign_id': barcode_data.campaign_id,
        'barcode_id': barcode_data.barcode_id,
        'user_id_hash': hashlib.sha256(user_data.phone.encode()).hexdigest(),
        'assignment_method': assignment_context.method,  # 'automatic', 'manual', 'waitlist'
        'personalization_score': assignment_context.personalization_score,
        'time_from_verification': assignment_context.verification_delay_seconds,
        'delivery_methods': assignment_context.delivery_methods,  # ['qr', 'sms', 'email', 'wallet']
        'location_context': {
            'user_city': user_data.city,
            'nearest_redemption_location': barcode_data.nearest_location,
            'distance_km': barcode_data.distance_to_nearest
        }
    }
    
    # Send to analytics pipeline
    send_to_analytics_pipeline(analytics_event)
    
    # Update campaign metrics
    update_campaign_metrics(barcode_data.campaign_id, {
        'total_assignments': '+1',
        'assignments_today': '+1',
        'personalization_success_rate': calculate_personalization_success_rate()
    })
```

### 9.6.11 Postconditions
- Barcode status updated: Available ‚Üí Assigned
- User receives barcode qua multiple channels
- Assignment logged trong audit trail
- Campaign metrics updated
- User Portal session initialized
- Mobile wallet passes generated (if requested)
- Analytics events tracked
- CRM sync queued

### 9.6.12 Special Requirements
- **Atomicity**: Zero double-assignment guarantee
- **Personalization**: >80% user satisfaction v·ªõi matches
- **Mobile-first**: PWA-optimized delivery experience
- **Offline support**: QR codes work without internet

---

## 9.7 UC-006: ƒê·ªïi qu√† t·∫°i ƒëi·ªÉm b√°n

### 9.7.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: Serving Account (staff) t·∫°i retail location scan barcode c·ªßa customer ƒë·ªÉ validate v√† complete redemption process v·ªõi offline capability.

**Ph·∫°m vi**: POS redemption t·ª´ scan ƒë·∫øn completion
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)
**Stakeholder**: Store staff, End users, Retail partners

### 9.7.2 Preconditions
- Serving Account ƒë√£ login v·ªõi POS access permissions
- Barcode status = "Assigned" v√† ch∆∞a expired
- Staff c√≥ device v·ªõi camera ho·∫∑c barcode scanner
- Location c√≥ POS integration setup
- Customer present t·∫°i store v·ªõi barcode

### 9.7.3 Main Success Scenario

1. **Staff chu·∫©n b·ªã redemption**
   - Login v√†o POS tool ho·∫∑c web interface
   - Select location (auto-detect ho·∫∑c manual)
   - Verify staff_id v√† shift information
   - Load redemption interface

2. **Scan customer barcode**
   - Customer show barcode (QR code, Apple Wallet, printed voucher)
   - Staff scan b·∫±ng camera app ho·∫∑c barcode scanner
   - System capture barcode_value v√† timestamp
   - Validate barcode format (alphanumeric, length)

3. **Validate barcode eligibility**
   - System lookup barcode trong database
   - Check barcode status (must be "Assigned")
   - Verify expiry date (ch∆∞a expired)
   - Confirm location permissions (store c√≥ th·ªÉ redeem n√†y kh√¥ng)
   - Check business hours restrictions

4. **Display redemption preview**
   - Show product information:
     * Product name v√† description
     * Brand information
     * Campaign name
     * Assigned user (masked): "+84***123456"
     * Expiry date
   - Show redemption confirmation screen
   - Provide "Confirm Redemption" button

5. **Complete redemption process**
   - Staff confirm redemption
   - System begin atomic transaction:
     * Update barcode status: Assigned ‚Üí Redeemed
     * Record redemption details (timestamp, location, staff)
     * Update campaign statistics
     * Generate receipt/confirmation
   - Commit transaction

6. **Provide confirmation**
   - Show success message v·ªõi receipt number
   - Display redemption summary
   - Option: Print receipt (if printer available)
   - Update staff dashboard statistics
   - Send confirmation ƒë·∫øn customer (if contact available)

### 9.7.4 Alternative Flows

**A1: Invalid barcode**
- 3a. N·∫øu barcode kh√¥ng t·ªìn t·∫°i:
  - Show error: "M√£ barcode kh√¥ng h·ª£p l·ªá"
  - Suggest re-scan ho·∫∑c manual entry
  - Option: Report counterfeit barcode
  - Log suspicious activity

**A2: Already redeemed barcode**
- 3b. N·∫øu barcode ƒë√£ redeemed:
  - Show error: "M√£ n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng"
  - Display previous redemption info:
    * Redeemed date/time
    * Location name
    * Staff who processed
  - Option: Contact support n·∫øu customer khi·∫øu n·∫°i

**A3: Expired barcode**
- 3c. N·∫øu barcode ƒë√£ expired:
  - Show error: "M√£ ƒë√£ h·∫øt h·∫°n v√†o [date]"
  - Check if expiry extension possible
  - Contact manager approval n·∫øu c·∫ßn
  - Document exception n·∫øu approved

**A4: Location restriction**
- 3d. N·∫øu barcode kh√¥ng th·ªÉ redeem t·∫°i location n√†y:
  - Show error: "M√£ n√†y ch·ªâ c√≥ th·ªÉ ƒë·ªïi t·∫°i: [location_list]"
  - Provide directions ƒë·∫øn valid locations
  - Option: Manager override v·ªõi reason

**A5: Network connectivity issues**
- N·∫øu device offline:
  - Switch sang offline mode
  - Store redemption locally (IndexedDB)
  - Show "Offline - will sync when connected"
  - Process redemption based on local cache
  - Auto-sync khi connection restored

### 9.7.5 Exception Flows

**E1: Database unavailable**
- N·∫øu central database down:
  - Fall back sang local verification
  - Use cached valid barcode list
  - Mark redemption as "pending_sync"
  - Queue for reconciliation later

**E2: Barcode scanner malfunction**
- N·∫øu camera/scanner kh√¥ng work:
  - Allow manual barcode entry
  - Implement extra validation (checksum)
  - Log manual entries cho audit
  - Alert IT support v·ªÅ hardware issue

### 9.7.6 Offline Capability

**Local storage strategy:**
```javascript
// IndexedDB schema cho offline redemptions
const offlineSchema = {
  stores: ['redemptions', 'valid_barcodes', 'sync_queue'],
  redemptions: {
    keyPath: 'redemption_id',
    indexes: ['barcode_value', 'timestamp', 'sync_status']
  },
  valid_barcodes: {
    keyPath: 'barcode_value', 
    indexes: ['campaign_id', 'expires_at', 'status']
  }
};

// Offline redemption process
class OfflineRedemption {
  async processRedemption(barcode_value, staff_id, location_id) {
    // Check local valid barcode cache
    const barcode = await this.lookupLocalBarcode(barcode_value);
    if (!barcode || barcode.status !== 'assigned') {
      throw new Error('Invalid barcode or already used');
    }
    
    // Create offline redemption record
    const redemption = {
      redemption_id: this.generateOfflineId(),
      barcode_value: barcode_value,
      staff_id: staff_id,
      location_id: location_id,
      timestamp: new Date().toISOString(),
      sync_status: 'pending',
      offline_processed: true
    };
    
    // Store locally
    await this.storeOfflineRedemption(redemption);
    
    // Update local barcode status
    await this.updateLocalBarcodeStatus(barcode_value, 'redeemed');
    
    return redemption;
  }
  
  async syncWhenOnline() {
    const pending = await this.getPendingRedemptions();
    for (const redemption of pending) {
      try {
        await this.syncRedemptionToServer(redemption);
        await this.markAsSynced(redemption.redemption_id);
      } catch (error) {
        // Handle sync conflicts
        await this.handleSyncConflict(redemption, error);
      }
    }
  }
}
```

### 9.7.7 POS Integration Variants

**Web-based POS tool:**
- Responsive web app works on tablets/phones
- Barcode scanning via camera API
- Works v·ªõi or without dedicated scanner hardware
- Real-time sync v·ªõi central database

**API integration v·ªõi existing POS systems:**
```python
# Circle K POS Integration
class CircleKPOSAdapter:
    def __init__(self, api_endpoint, api_key):
        self.endpoint = api_endpoint
        self.api_key = api_key
    
    def validate_redemption(self, barcode, store_id):
        # Call Circle K validation API
        response = requests.post(f"{self.endpoint}/validate", {
            'barcode': barcode,
            'store_id': store_id,
            'api_key': self.api_key
        })
        return response.json()
    
    def complete_redemption(self, barcode, transaction_id):
        # Mark as redeemed trong Circle K system
        response = requests.post(f"{self.endpoint}/redeem", {
            'barcode': barcode,
            'transaction_id': transaction_id,
            'api_key': self.api_key
        })
        return response.json()

# GS25 POS Integration  
class GS25POSAdapter:
    def process_redemption(self, barcode_data):
        # Different API structure for GS25
        # Handle format differences v√† error codes
        pass
```

### 9.7.8 Fraud Prevention

**Redemption validation rules:**
```python
class RedemptionValidator:
    def validate_redemption(self, barcode, location, staff, timestamp):
        checks = []
        
        # Time-based validation
        if self.is_outside_business_hours(location, timestamp):
            checks.append("Redemption outside business hours")
        
        # Location validation
        if not self.is_valid_location_for_barcode(barcode, location):
            checks.append("Invalid location for this barcode")
        
        # Staff validation
        if not self.is_staff_authorized(staff, location):
            checks.append("Staff not authorized for this location")
        
        # Velocity checks
        if self.detect_rapid_redemptions(staff, timestamp):
            checks.append("Suspicious redemption velocity")
        
        # Geographic impossibility
        if self.detect_impossible_travel(barcode.last_activity, location, timestamp):
            checks.append("Impossible travel between activities")
        
        return len(checks) == 0, checks
```

### 9.7.9 Receipt v√† Confirmation

**Receipt template:**
```
=================================
    [BRAND LOGO]
=================================
VOUCHER REDEMPTION RECEIPT

Product: [PRODUCT_NAME]
Campaign: [CAMPAIGN_NAME]
Barcode: [BARCODE_VALUE]

Redeemed at: [LOCATION_NAME]
Address: [LOCATION_ADDRESS]
Date: [DATE] [TIME]
Staff: [STAFF_NAME]

Receipt #: [RECEIPT_NUMBER]

Thank you for participating!
Visit: portal.productsampling.com
for more offers.
=================================
```

**Digital confirmation:**
```python
def send_redemption_confirmation(redemption_data):
    # SMS confirmation
    if redemption_data.user_phone:
        message = f"B·∫°n ƒë√£ ƒë·ªïi th√†nh c√¥ng {redemption_data.product_name} t·∫°i {redemption_data.location_name}. C·∫£m ∆°n b·∫°n ƒë√£ tham gia!"
        send_sms(redemption_data.user_phone, message)
    
    # Email confirmation v·ªõi receipt
    if redemption_data.user_email:
        send_email_receipt(redemption_data.user_email, redemption_data)
    
    # User Portal notification
    create_portal_notification(redemption_data.user_id, {
        'type': 'redemption_success',
        'product_name': redemption_data.product_name,
        'location': redemption_data.location_name,
        'timestamp': redemption_data.timestamp
    })
```

### 9.7.10 Performance Requirements

**Redemption SLA (t·ª´ System_Feature_Tree_Grok.md 1.5):**
- Scan validation: <3 gi√¢y
- Redemption completion: <5 gi√¢y total
- Offline sync: 24-hour capability
- Success rate: >98%

**Concurrent redemptions:**
- Support 100 simultaneous redemptions per location
- Handle peak times (lunch hours, weekends)
- Queue management cho high traffic

### 9.7.11 Analytics v√† Reporting

**Real-time redemption tracking:**
```python
def track_redemption_analytics(redemption_data):
    analytics_event = {
        'event_type': 'redemption_completed',
        'timestamp': redemption_data.timestamp,
        'campaign_id': redemption_data.campaign_id,
        'location_id': redemption_data.location_id,
        'staff_id': redemption_data.staff_id,
        'processing_time_seconds': redemption_data.processing_time,
        'redemption_method': redemption_data.method,  # 'scan', 'manual_entry'
        'offline_processed': redemption_data.offline,
        'time_from_assignment_hours': redemption_data.assignment_delay,
        'day_of_week': redemption_data.timestamp.strftime('%A'),
        'hour_of_day': redemption_data.timestamp.hour
    }
    
    # Update real-time dashboards
    update_location_dashboard(redemption_data.location_id, analytics_event)
    update_campaign_dashboard(redemption_data.campaign_id, analytics_event)
    
    # Send to data warehouse
    send_to_analytics_pipeline(analytics_event)
```

### 9.7.12 Postconditions
- Barcode status updated: Assigned ‚Üí Redeemed
- Redemption record created v·ªõi audit trail
- Campaign statistics updated
- Customer confirmation sent
- Receipt generated
- Staff dashboard updated
- Analytics events tracked
- Inventory adjustments (if applicable)

### 9.7.13 Special Requirements
- **Offline capability**: 24-hour operation without internet
- **Audit compliance**: Immutable redemption logs
- **Real-time sync**: <5 minute delay cho online operations
- **Multi-location support**: Staff c√≥ th·ªÉ work t·∫°i multiple stores

---
---

## 9.8 UC-007: Ph√¢n t√≠ch v√† b√°o c√°o chi·∫øn d·ªãch

### 9.8.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: Brand Manager/Admin xem funnel analytics, ROI metrics v√† export data ƒë·ªÉ ƒë√°nh gi√° hi·ªáu qu·∫£ campaign v√† t·ªëi ∆∞u chi·∫øn l∆∞·ª£c.

**Ph·∫°m vi**: Analytics dashboard t·ª´ real-time metrics ƒë·∫øn export reports
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng quan tr·ªçng (important)
**Stakeholder**: Brand managers, Marketing teams, Executives

### 9.8.2 Preconditions
- User c√≥ quy·ªÅn analytics theo scope (Own campaigns ho·∫∑c Group/Global)
- Campaign ƒë√£ c√≥ data (√≠t nh·∫•t v√†i events ƒë∆∞·ª£c track)
- Analytics pipeline ƒëang ho·∫°t ƒë·ªông
- Dashboard service online v·ªõi <3s response time requirement

### 9.8.3 Main Success Scenario

1. **Truy c·∫≠p Analytics Dashboard**
   - Login v√† navigate ƒë·∫øn Analytics module
   - System hi·ªÉn th·ªã campaign list theo permissions
   - Select campaign ho·∫∑c view aggregated data
   - Choose date range (default: last 30 days)

2. **Xem Funnel Analytics**
   - System load real-time funnel data:
     * QR Scans: S·ªë l∆∞·ª£ng QR ƒë∆∞·ª£c scan
     * Form Submissions: Users ƒëi·ªÅn form
     * OTP Verifications: Successful verifications
     * Barcode Assignments: Vouchers ƒë∆∞·ª£c c·∫•p
     * Redemptions: Actual product pickups
   - Display conversion rates gi·ªØa c√°c steps
   - Show drop-off points v√† bottlenecks

3. **Ph√¢n t√≠ch ROI Metrics**
   - Cost metrics:
     * Total campaign cost
     * Cost per scan
     * Cost per verified lead (target: <0.4 USD)
     * Cost per redemption
   - Revenue impact:
     * Estimated revenue from redemptions
     * Customer lifetime value uplift
     * ROI percentage
   - Efficiency metrics:
     * Campaign reach vs target
     * Redemption rate by location
     * Time to redemption distribution

4. **Geographic v√† Demographic Analysis**
   - Location performance:
     * Top performing locations
     * Geographic heat map
     * Urban vs suburban performance
   - User demographics:
     * Age group breakdown
     * Gender distribution
     * User preferences trends
   - Time-based analysis:
     * Peak activity hours
     * Day of week patterns
     * Seasonal trends

5. **Interactive Dashboard Features**
   - Drill-down capabilities:
     * Click location ƒë·ªÉ xem chi ti·∫øt
     * Filter theo demographics
     * Compare multiple campaigns
   - Real-time updates (refresh every 5 minutes)
   - Custom date range selection
   - Save favorite views

6. **Export v√† Reporting**
   - Quick export options:
     * CSV cho raw data
     * Excel v·ªõi charts
     * PDF executive summary
   - Scheduled reports:
     * Daily/weekly/monthly automation
     * Email delivery ƒë·∫øn stakeholders
   - API access cho custom integrations

### 9.8.4 Alternative Flows

**A1: Insufficient data**
- 2a. N·∫øu campaign ch∆∞a c√≥ sufficient data:
  - Show message: "Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã analytics"
  - Provide estimated time cho meaningful data
  - Show preliminary metrics n·∫øu c√≥
  - Link ƒë·∫øn campaign promotion tips

**A2: Data processing delay**
- 2b. N·∫øu analytics pipeline delayed:
  - Show last update timestamp
  - Display cached data v·ªõi warning
  - Provide refresh button
  - Estimate real-time data availability

**A3: Export job queue full**
- 6a. N·∫øu export system overloaded:
  - Show queue position v√† estimated wait time
  - Option: Priority export (for premium users)
  - Email notification khi ready
  - Download link expiry information

### 9.8.5 Exception Flows

**E1: Analytics service down**
- N·∫øu analytics service unavailable:
  - Show cached dashboard data
  - Display service status message
  - Provide basic metrics t·ª´ primary database
  - Alert operations team

**E2: Large dataset timeout**
- N·∫øu query timeout cho large campaigns:
  - Suggest narrower date range
  - Offer sampled data analysis
  - Background processing option
  - Pre-aggregated report suggestions

### 9.8.6 Dashboard Components

**Funnel Visualization:**
```javascript
// Funnel chart configuration
const funnelConfig = {
  data: {
    scans: 10000,
    form_submissions: 8500, // 85% conversion
    otp_verifications: 8075, // 95% conversion  
    barcode_assignments: 7912,# üìã SRS Part09 - Use Case chi ti·∫øt (Detailed Use Cases)
**H·ªá th·ªëng Product Sampling Platform**

**Phi√™n b·∫£n**: 1.0  
**Ng√†y**: 2025-10-17  
**T√°c gi·∫£**: ƒê·ªôi ph√¢n t√≠ch h·ªá th·ªëng  

---

## 9.1 T·ªïng quan Use Cases

### 9.1.1 Ph√¢n lo·∫°i Use Cases (t·ª´ System_Feature_Tree_Grok.md v4.0)
D·ª±a tr√™n **flow v·∫≠n h√†nh** v√† **user stories** trong c√¢y ch·ª©c nƒÉng, h·ªá th·ªëng c√≥ 8 use cases ch√≠nh:

| UC ID | T√™n Use Case | Actor ch√≠nh | M·ª©c ƒë·ªô ∆∞u ti√™n | Ngu·ªìn tham chi·∫øu |
|-------|--------------|-------------|----------------|------------------|
| UC-001 | T·∫°o v√† qu·∫£n l√Ω chi·∫øn d·ªãch sampling | Admin/Brand Manager | Cao | Feature Tree 1.1 |
| UC-002 | Qu·∫£n l√Ω barcode v√† inventory | Admin/Brand Manager | Cao | Feature Tree 1.2 |
| UC-003 | Kh√°ch h√†ng qu√©t QR v√† ƒëi·ªÅn form | End User | Cao | Feature Tree 1.3 |
| UC-004 | X√°c th·ª±c OTP v√† ch·ªëng gian l·∫≠n | End User/System | Cao | Feature Tree 1.4 |
| UC-005 | C·∫•p ph√°t v√† qu·∫£n l√Ω voucher | System/End User | Cao | Feature Tree 1.5 |
| UC-006 | ƒê·ªïi qu√† t·∫°i ƒëi·ªÉm b√°n | Serving Staff/End User | Cao | Feature Tree 1.5 |
| UC-007 | Ph√¢n t√≠ch v√† b√°o c√°o chi·∫øn d·ªãch | Brand Manager/Admin | Trung b√¨nh | Feature Tree 1.6 |
| UC-008 | Qu·∫£n l√Ω User Portal v√† h·ªó tr·ª£ | End User/Admin | Trung b√¨nh | Feature Tree 1.9 |

### 9.1.2 Actors v√† vai tr√≤ (t·ª´ Access_Control_Tree_Grok.md v2.2)

**Primary Actors:**
- **Admin**: To√†n quy·ªÅn h·ªá th·ªëng, thi·∫øt l·∫≠p global configs
- **Group Admin**: Qu·∫£n l√Ω campaigns trong group scope
- **Customer Account (Brand Manager)**: Qu·∫£n l√Ω campaigns ri√™ng
- **Serving Account**: Staff t·∫°i retail nodes, x·ª≠ l√Ω redemption
- **End User**: Kh√°ch h√†ng cu·ªëi s·ª≠ d·ª•ng User Portal
- **Auditor**: Gi√°m s√°t compliance v√† audit logs

**Secondary Actors:**
- **SMS/Email Providers**: Twilio, SendGrid
- **CRM Systems**: HubSpot, Salesforce
- **POS Systems**: Circle K, GS25, Mini Stop
- **Analytics Systems**: GA4, Meta Pixel

---

## 9.2 UC-001: T·∫°o v√† qu·∫£n l√Ω chi·∫øn d·ªãch sampling

### 9.2.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: Admin/Brand Manager t·∫°o v√† qu·∫£n l√Ω chi·∫øn d·ªãch ph√¢n ph·ªëi m·∫´u s·∫£n ph·∫©m v·ªõi targeting ƒë·ªãa l√Ω, ng√¢n s√°ch v√† tracking UTM.

**Ph·∫°m vi**: Campaign lifecycle t·ª´ t·∫°o ƒë·∫øn ho√†n th√†nh
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)
**Stakeholder**: Brands, Marketing teams

### 9.2.2 Preconditions
- Actor ƒë√£ ƒëƒÉng nh·∫≠p v·ªõi role Admin, Group Admin ho·∫∑c Customer Account
- C√≥ √≠t nh·∫•t 1 location ƒë∆∞·ª£c setup trong h·ªá th·ªëng
- C√≥ barcode pool s·∫µn s√†ng ƒë·ªÉ g√°n (optional cho draft)

### 9.2.3 Main Success Scenario
1. **Actor truy c·∫≠p Campaign Management**
   - ƒêƒÉng nh·∫≠p v√†o dashboard
   - Navigate ƒë·∫øn Campaign Management module
   - System hi·ªÉn th·ªã danh s√°ch campaigns theo ph√¢n quy·ªÅn

2. **T·∫°o campaign m·ªõi**
   - Click "T·∫°o Campaign M·ªõi"
   - ƒêi·ªÅn th√¥ng tin c∆° b·∫£n:
     * T√™n campaign (b·∫Øt bu·ªôc, max 255 chars)
     * M√¥ t·∫£ chi ti·∫øt (optional, max 1000 chars)
     * Ng√†y b·∫Øt ƒë·∫ßu/k·∫øt th√∫c (validate: end > start, future dates)
   - System validate input v√† t·∫°o campaign_id duy nh·∫•t

3. **C·∫•u h√¨nh targeting v√† budget**
   - Ch·ªçn locations t·ª´ dropdown (multi-select)
   - Thi·∫øt l·∫≠p targeting demographics:
     * Age range (13-100)
     * Gender filter (male/female/all)
     * Interests (optional)
   - C√†i ƒë·∫∑t budget limits:
     * Max participants
     * Total budget
     * Cost per verified lead target (‚â§ 0.4 USD)

4. **Setup tracking v√† UTM**
   - C·∫•u h√¨nh UTM parameters:
     * utm_source (e.g., "poster", "flyer")
     * utm_medium (e.g., "qr", "digital")
     * utm_campaign (auto-fill campaign_id)
     * utm_term, utm_content (optional)
   - System generate tracking URLs

5. **G√°n barcode pool (optional)**
   - Select t·ª´ available barcode batches
   - Ho·∫∑c skip ƒë·ªÉ import sau
   - System validate barcode availability

6. **Preview v√† publish**
   - Review t·∫•t c·∫£ settings
   - Generate QR codes cho m·ªói location
   - Status: Draft ‚Üí Active
   - System g·ª≠i notification ƒë·∫øn team

### 9.2.4 Alternative Flows

**A1: Validation errors**
- 2a. N·∫øu validation th·∫•t b·∫°i:
  - System hi·ªÉn th·ªã error messages chi ti·∫øt
  - Highlight fields c√≥ l·ªói
  - Actor s·ª≠a v√† retry
  - Continue t·ª´ step 2

**A2: Insufficient permissions**
- 1a. N·∫øu Customer Account c·ªë t·∫°o Global campaign:
  - System reject v·ªõi 403 Forbidden
  - Show message "B·∫°n ch·ªâ c√≥ th·ªÉ t·∫°o campaigns cho brand ri√™ng"
  - Redirect v·ªÅ dashboard

**A3: No available locations**
- 3a. N·∫øu kh√¥ng c√≥ locations available cho user scope:
  - System hi·ªÉn th·ªã empty state
  - Provide link ƒë·∫øn Location Management
  - Suggest contact Admin ƒë·ªÉ setup locations

### 9.2.5 Exception Flows

**E1: System timeout**
- N·∫øu campaign creation timeout (>30s):
  - System save draft automatically
  - Show "Campaign ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m, b·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c sau"
  - Provide link ƒë·ªÉ resume

**E2: Database constraint violation**
- N·∫øu campaign_id duplicate (rare):
  - System retry v·ªõi new ID generation
  - Log incident cho investigation
  - Continue normal flow

### 9.2.6 Postconditions
- Campaign ƒë∆∞·ª£c t·∫°o v·ªõi status "Active" ho·∫∑c "Draft"
- QR codes ƒë∆∞·ª£c generate cho m·ªói location
- Analytics tracking ƒë∆∞·ª£c setup
- Team notifications ƒë∆∞·ª£c g·ª≠i
- Audit log ghi l·∫°i campaign creation

### 9.2.7 Special Requirements
- **Performance**: Campaign creation ph·∫£i ho√†n th√†nh trong <2 ng√†y (business requirement t·ª´ System_Feature_Tree_Grok.md 1.1)
- **Security**: Multi-tenant isolation theo tenant_id
- **Audit**: Full audit trail cho compliance
- **UTM accuracy**: 100% tracking accuracy requirement

---

## 9.3 UC-002: Qu·∫£n l√Ω barcode v√† inventory

### 9.3.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: Admin/Brand Manager import, qu·∫£n l√Ω v√† ƒë·ªëi so√°t barcode/voucher v·ªõi single-use validation v√† lifecycle tracking.

**Ph·∫°m vi**: Barcode lifecycle t·ª´ import ƒë·∫øn reconciliation
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)
**Stakeholder**: Brands, Operations team

### 9.3.2 Preconditions
- Actor c√≥ quy·ªÅn barcode.import theo scope (t·ª´ Access_Control_Tree_Grok.md 2.2)
- CSV file tu√¢n th·ªß format: barcode, product_name, expiry_date, value, batch_code
- File size ‚â§ 100MB, encoding UTF-8

### 9.3.3 Main Success Scenario
1. **Truy c·∫≠p Barcode Management**
   - Navigate ƒë·∫øn Barcode Management module
   - System hi·ªÉn th·ªã overview: total codes, assigned, redeemed, expired

2. **Chu·∫©n b·ªã import file**
   - Download CSV template n·∫øu c·∫ßn
   - Chu·∫©n b·ªã file v·ªõi columns b·∫Øt bu·ªôc:
     * barcode (8-50 chars, alphanumeric)
     * product_name (max 255 chars)
     * expiry_date (ISO date format, future dates only)
     * value (decimal, optional)
     * batch_code (tracking purposes)

3. **Upload v√† validate file**
   - Click "Import Barcodes"
   - Select campaign ƒë·ªÉ g√°n (optional)
   - Upload CSV file
   - System validate:
     * File format v√† encoding
     * Column headers ƒë√∫ng
     * Data types v√† constraints
     * Barcode uniqueness (global unique)

4. **Preview v√† confirm import**
   - System hi·ªÉn th·ªã preview:
     * Total rows: X
     * Valid rows: Y
     * Invalid rows: Z (v·ªõi error details)
   - Review sample data (first 10 rows)
   - Option: "Validate Only" ho·∫∑c "Import"

5. **Process import job**
   - System t·∫°o background job
   - Return job_id cho tracking
   - Process t·ª´ng row v·ªõi error handling
   - Update progress real-time

6. **Verify import results**
   - Check job status via job_id
   - Review import summary:
     * Successful imports: X
     * Failed imports: Y v·ªõi error details
     * Batch_id ƒë∆∞·ª£c t·∫°o
   - Download error report n·∫øu c√≥

### 9.3.4 Alternative Flows

**A1: File validation errors**
- 3a. N·∫øu file format kh√¥ng h·ª£p l·ªá:
  - System show detailed error messages
  - Highlight specific issues (missing columns, wrong encoding, etc.)
  - Provide corrected template download
  - Actor fix file v√† retry

**A2: Duplicate barcodes detected**
- 3b. N·∫øu c√≥ duplicate barcodes trong file ho·∫∑c v·ªõi existing data:
  - System list t·∫•t c·∫£ duplicates
  - Options: Skip duplicates, Replace existing, Cancel import
  - Actor ch·ªçn strategy v√† continue

**A3: Large file processing**
- 4a. N·∫øu file >10K rows:
  - System suggest batch processing
  - Option: Split file th√†nh smaller batches
  - Process t·ª´ng batch sequentially

### 9.3.5 Exception Flows

**E1: Import job failure**
- N·∫øu background job failed:
  - System retry automatically (max 3 times)
  - Log detailed error cho debugging
  - Notify Actor v·ªÅ failure v·ªõi error summary
  - Option: Download partial results n·∫øu c√≥

**E2: Database timeout**
- N·∫øu large batch insert timeout:
  - System switch sang chunked processing
  - Continue t·ª´ last successful chunk
  - Show progress v·ªõi estimated completion time

### 9.3.6 Barcode Lifecycle Management

**Tr·∫°ng th√°i lifecycle (t·ª´ System_Feature_Tree_Grok.md 1.2):**
```
Available ‚Üí Assigned ‚Üí Redeemed
    ‚Üì           ‚Üì         ‚Üì
  Expired    Expired   [Final]
    ‚Üì           ‚Üì
 Revoked    Revoked
```

**State transition rules:**
- Available ‚Üí Assigned: Khi user verify OTP
- Assigned ‚Üí Redeemed: Khi scan t·∫°i POS
- Any ‚Üí Expired: Khi qua expiry_date
- Any ‚Üí Revoked: Manual admin action (fraud cases)

### 9.3.7 Reconciliation Process

**Daily reconciliation workflow:**
1. **System auto-check expiry**
   - Cron job ch·∫°y daily 2AM
   - Update status Available/Assigned ‚Üí Expired n·∫øu qua expiry_date
   - Generate expiry report

2. **Manual reconciliation**
   - Admin import redemption logs t·ª´ external systems
   - Cross-reference v·ªõi internal redemption data
   - Identify discrepancies
   - Generate reconciliation report

3. **Inventory accuracy check**
   - Compare database counts v·ªõi physical inventory
   - Flag discrepancies >5% cho investigation
   - Update inventory adjustments n·∫øu c·∫ßn

### 9.3.8 Postconditions
- Barcodes imported v·ªõi status "Available"
- Batch record created v·ªõi tracking info
- Inventory counts updated
- Import job log saved v·ªõi full audit trail
- Notifications sent cho relevant stakeholders

### 9.3.9 Special Requirements
- **Performance**: Import <10MB file trong <30 gi√¢y
- **Accuracy**: 100% barcode uniqueness enforcement
- **Inventory**: >95% accuracy requirement
- **Audit**: Immutable audit trail cho compliance

---

## 9.4 UC-003: Kh√°ch h√†ng qu√©t QR v√† ƒëi·ªÅn form

### 9.4.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: End user qu√©t QR code t·ª´ ads format, truy c·∫≠p landing page v√† ƒëi·ªÅn form thu th·∫≠p d·ªØ li·ªáu v·ªõi quiz preferences.

**Ph·∫°m vi**: User journey t·ª´ QR scan ƒë·∫øn form submission
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)  
**Stakeholder**: End users, Brands

### 9.4.2 Preconditions
- Campaign ƒëang active (status = "active")
- QR code h·ª£p l·ªá v√† ch∆∞a expired
- User c√≥ smartphone/device v·ªõi camera
- Landing page accessible (99.9% uptime requirement)

### 9.4.3 Main Success Scenario

1. **Qu√©t QR code**
   - User th·∫•y ads format (poster, flyer, digital banner) t·∫°i location
   - M·ªü camera app ho·∫∑c QR scanner
   - Qu√©t QR code tr√™n ads
   - System redirect ƒë·∫øn landing page v·ªõi campaign_id, location_id, ads_format_id trong URL

2. **Load landing page**
   - System load landing page responsive (<2 gi√¢y tr√™n mobile 3G)
   - Hi·ªÉn th·ªã campaign info:
     * Product image v√† description
     * Brand information
     * Value proposition
     * Terms & conditions link
   - Track analytics event: "qr_scan"

3. **ƒêi·ªÅn form th√¥ng tin c∆° b·∫£n**
   - Form v·ªõi fields b·∫Øt bu·ªôc:
     * H·ªç t√™n (validation: kh√¥ng ch·ª©a s·ªë)
     * Email (validation: format email h·ª£p l·ªá)
     * S·ªë ƒëi·ªán tho·∫°i (validation: VN format +84...)
   - Fields optional:
     * Tu·ªïi (dropdown: <18, 18-24, 25-34, 35-44, 45-54, 55+)
     * Gi·ªõi t√≠nh (radio: Nam/N·ªØ/Kh√°c)
     * Th√†nh ph·ªë (dropdown: major cities)

4. **Tham gia quiz preferences**
   - System hi·ªÉn th·ªã 5-10 c√¢u h·ªèi multiple choice:
     * "B·∫°n th∆∞·ªùng mua s·∫Øm ·ªü ƒë√¢u?" (Online/Store/Both)
     * "Lo·∫°i s·∫£n ph·∫©m y√™u th√≠ch?" (Food/Beauty/Tech/Fashion)
     * "Frequency of trying new products?" (Weekly/Monthly/Rarely)
     * "Preferred communication channel?" (SMS/Email/Social)
   - Each answer c√≥ scoring ƒë·ªÉ build user profile

5. **Ch·∫•p nh·∫≠n terms v√† consent**
   - Checkboxes b·∫Øt bu·ªôc:
     * "T√¥i ƒë·ªìng √Ω v·ªõi Terms & Conditions"
     * "T√¥i ƒë·ªìng √Ω x·ª≠ l√Ω d·ªØ li·ªáu c√° nh√¢n theo GDPR/PDPA"
   - Checkboxes optional:
     * "Nh·∫≠n th√¥ng tin marketing qua email"
     * "Nh·∫≠n th√¥ng tin marketing qua SMS"
     * "Chia s·∫ª data v·ªõi partners"

6. **Submit form v·ªõi reCAPTCHA**
   - System validate t·∫•t c·∫£ required fields
   - reCAPTCHA v3 validation (score >0.5)
   - Track analytics event: "form_submit"
   - Show loading spinner

7. **X·ª≠ l√Ω submission**
   - System hash PII data (phone, email)
   - Encrypt sensitive fields (name, preferences)
   - Store trong database v·ªõi consent flags
   - Generate session_id cho OTP step
   - Redirect ƒë·∫øn OTP verification page

### 9.4.4 Alternative Flows

**A1: Form validation errors**
- 6a. N·∫øu c√≥ validation errors:
  - Highlight fields c√≥ l·ªói v·ªõi error messages
  - Scroll ƒë·∫øn field ƒë·∫ßu ti√™n c√≥ l·ªói
  - Keep existing data trong form
  - User fix errors v√† re-submit

**A2: Campaign inactive/expired**
- 1a. N·∫øu campaign kh√¥ng active:
  - Show message "Campaign ƒë√£ k·∫øt th√∫c"
  - Provide link ƒë·∫øn other active campaigns
  - Track event: "campaign_expired_access"

**A3: Location restriction**
- 1b. N·∫øu user location kh√¥ng match campaign targeting:
  - Show message "Campaign kh√¥ng available t·∫°i khu v·ª±c n√†y"
  - Suggest nearby locations n·∫øu c√≥
  - Option: Continue anyway v·ªõi warning

**A4: reCAPTCHA failed**
- 6b. N·∫øu reCAPTCHA score <0.5:
  - Show traditional CAPTCHA challenge
  - User solve CAPTCHA
  - Re-validate v√† continue

### 9.4.5 Exception Flows

**E1: Network connectivity issues**
- N·∫øu form submit failed do network:
  - Auto-save form data locally (localStorage)
  - Show retry button
  - Auto-retry khi connection restored
  - Prevent data loss

**E2: Server overload**
- N·∫øu server response >10 gi√¢y:
  - Show "High traffic, please wait" message
  - Implement queue system
  - Provide estimated wait time
  - Option: Get notified when ready

### 9.4.6 User Experience Requirements

**Performance targets (t·ª´ System_Feature_Tree_Grok.md 1.3):**
- Landing page load: <2 gi√¢y tr√™n mobile 3G
- Form completion time: <30 gi√¢y average
- Form completion rate: >90%
- Data quality score: >95%

**Responsive design:**
- Mobile-first PWA design
- Touch-friendly inputs
- Auto-complete enabled
- Keyboard optimization
- Accessibility WCAG 2.1 AA compliant

**Progressive disclosure:**
- Show form steps progressively
- Progress indicator (Step 1/3)
- Save progress locally
- Clear next step instructions

### 9.4.7 Data Collection Strategy

**Profile scoring algorithm:**
```python
def calculate_profile_score(quiz_responses):
    score = 0
    
    # Shopping frequency (0-20 points)
    if quiz_responses.get('shopping_frequency') == 'weekly':
        score += 20
    elif quiz_responses.get('shopping_frequency') == 'monthly':
        score += 10
    
    # Product trial willingness (0-25 points)
    if quiz_responses.get('try_new_products') == 'always':
        score += 25
    elif quiz_responses.get('try_new_products') == 'sometimes':
        score += 15
    
    # Brand loyalty (0-15 points)
    if quiz_responses.get('brand_loyalty') == 'low':
        score += 15  # More likely to try new brands
    
    # Communication preference (0-10 points)
    if quiz_responses.get('communication') in ['email', 'sms']:
        score += 10
    
    return min(score, 100)  # Cap at 100
```

### 9.4.8 Analytics Tracking

**Events tracked:**
```javascript
// GA4 event tracking
gtag('event', 'qr_scan', {
  campaign_id: 'CAMP_2025_001',
  location_id: 'HCM_CIRCLE_K_001',
  ads_format_id: 'POSTER_A4_001',
  user_agent: navigator.userAgent,
  timestamp: new Date().toISOString()
});

gtag('event', 'form_start', {
  campaign_id: 'CAMP_2025_001',
  form_version: 'v1.2'
});

gtag('event', 'form_submit', {
  campaign_id: 'CAMP_2025_001', 
  completion_time: 45, // seconds
  quiz_completed: true,
  consent_marketing: true
});
```

### 9.4.9 Postconditions
- User profile created v·ªõi encrypted PII
- Quiz responses scored v√† stored
- Consent preferences recorded
- Analytics events tracked
- Session prepared cho OTP verification
- User redirected ƒë·∫øn OTP page

### 9.4.10 Special Requirements
- **GDPR/PDPA Compliance**: Explicit consent collection
- **Data Quality**: >95% valid data requirement
- **Fraud Prevention**: reCAPTCHA v√† device fingerprinting
- **Accessibility**: Support screen readers v√† keyboard navigation

---

## 9.5 UC-004: X√°c th·ª±c OTP v√† ch·ªëng gian l·∫≠n

### 9.5.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: System g·ª≠i v√† verify OTP code ƒë·ªÉ x√°c th·ª±c user th·∫≠t, k·∫øt h·ª£p v·ªõi fraud detection ƒë·ªÉ ch·ªëng spam v√† bot attacks.

**Ph·∫°m vi**: OTP generation, delivery, verification v√† fraud prevention
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng quan tr·ªçng (critical)
**Stakeholder**: End users, Security team

### 9.5.2 Preconditions
- User ƒë√£ complete form submission (UC-003)
- Phone/email ƒë√£ ƒë∆∞·ª£c validate format
- Session_id h·ª£p l·ªá t·ª´ form submission
- SMS/Email providers (Twilio/SendGrid) online

### 9.5.3 Main Success Scenario

1. **Generate v√† g·ª≠i OTP**
   - System receive OTP request v·ªõi session_id
   - Validate session (kh√¥ng expired, ch∆∞a verified)
   - Generate 6-digit random code
   - Store trong Redis v·ªõi TTL 5 ph√∫t
   - Determine delivery method (SMS priority, email fallback)

2. **Fraud detection pre-check**
   - Check rate limiting rules:
     * Max 10 OTP requests/24h per phone number
     * Max 3 requests/hour per session
     * Max 100 requests/hour per IP
   - Device fingerprinting analysis
   - Disposable email detection
   - VPN/proxy detection

3. **Deliver OTP message**
   - SMS via Twilio: "M√£ x√°c th·ª±c c·ªßa b·∫°n: {code}. C√≥ hi·ªáu l·ª±c trong 5 ph√∫t."
   - Email template v·ªõi branding v√† instructions
   - Track delivery status (sent/delivered/failed)
   - Start 5-minute countdown timer

4. **User nh·∫≠p OTP code**
   - User receive SMS/email
   - Enter 6-digit code trong form
   - System validate format (numeric, 6 digits)
   - Submit verification request

5. **Verify OTP code**
   - Validate session_id v√† OTP code
   - Check expiration (5 ph√∫t window)
   - Compare v·ªõi stored code trong Redis
   - Track attempt count (max 3 attempts)

6. **Successful verification**
   - Mark session as verified
   - Generate user_token cho barcode assignment
   - Clear OTP t·ª´ Redis
   - Track analytics: "otp_verified"
   - Redirect ƒë·∫øn barcode assignment page

### 9.5.4 Alternative Flows

**A1: Invalid OTP code**
- 5a. N·∫øu OTP code sai:
  - Increment attempt counter
  - Show error: "M√£ OTP kh√¥ng ƒë√∫ng"
  - Display attempts remaining (3-current_attempts)
  - If attempts < 3: Allow retry
  - If attempts = 3: Block session, require new OTP

**A2: Expired OTP**
- 5b. N·∫øu OTP ƒë√£ expired (>5 ph√∫t):
  - Show error: "M√£ OTP ƒë√£ h·∫øt h·∫°n"
  - Clear expired code t·ª´ Redis
  - Show "G·ª≠i l·∫°i OTP" button
  - User click ƒë·ªÉ request new OTP

**A3: Rate limit exceeded**
- 1a. N·∫øu v∆∞·ª£t rate limit:
  - Show error: "B·∫°n ƒë√£ y√™u c·∫ßu qu√° nhi·ªÅu OTP. Vui l√≤ng th·ª≠ l·∫°i sau X ph√∫t"
  - Display countdown timer
  - Block new requests until cooldown
  - Log suspicious activity

**A4: SMS delivery failed**
- 3a. N·∫øu SMS failed (network issue, invalid number):
  - Auto-fallback sang email delivery
  - Update delivery method trong session
  - Show message: "SMS kh√¥ng th·ªÉ g·ª≠i, ƒë√£ g·ª≠i qua email"
  - Continue normal flow

**A5: Disposable email detected**
- 2a. N·∫øu detect disposable email:
  - Require phone verification thay v√¨ email
  - Show message: "Vui l√≤ng s·ª≠ d·ª•ng email th∆∞·ªùng xuy√™n"
  - Option: Update email address

### 9.5.5 Exception Flows

**E1: All delivery methods failed**
- N·∫øu c·∫£ SMS v√† email ƒë·ªÅu failed:
  - Log critical error cho investigation
  - Show fallback message: "H·ªá th·ªëng ƒëang b·∫£o tr√¨, vui l√≤ng th·ª≠ l·∫°i sau"
  - Queue retry job cho later processing
  - Notify operations team

**E2: Redis unavailable**
- N·∫øu Redis cache down:
  - Fallback sang database storage
  - Continue OTP flow v·ªõi slightly higher latency
  - Alert DevOps team ƒë·ªÉ fix Redis

### 9.5.6 Fraud Detection Rules

**Velocity checks:**
```python
class FraudDetection:
    def check_otp_velocity(self, phone_number, ip_address):
        rules = [
            # Phone-based limits
            ("phone_hourly", phone_number, 3, 3600),
            ("phone_daily", phone_number, 10, 86400),
            
            # IP-based limits  
            ("ip_hourly", ip_address, 100, 3600),
            ("ip_daily", ip_address, 1000, 86400),
        ]
        
        for rule_name, identifier, limit, window in rules:
            count = redis.get(f"rate_limit:{rule_name}:{identifier}") or 0
            if int(count) >= limit:
                return False, f"Rate limit exceeded for {rule_name}"
        
        return True, None
    
    def check_suspicious_patterns(self, request_data):
        suspicion_score = 0
        
        # Check device fingerprint
        if self.is_known_bot_signature(request_data.user_agent):
            suspicion_score += 50
        
        # Check request timing patterns
        if self.detect_automated_timing(request_data.session_id):
            suspicion_score += 30
        
        # Check geolocation inconsistency
        if self.detect_geo_impossible_travel(request_data.ip_address):
            suspicion_score += 40
        
        return suspicion_score > 70  # Threshold for blocking
```

**Device fingerprinting:**
```javascript
// Client-side fingerprinting
function generateDeviceFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Device fingerprint', 2, 2);
    
    const fingerprint = {
        screen: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        platform: navigator.platform,
        canvas_hash: btoa(canvas.toDataURL()),
        user_agent_hash: btoa(navigator.userAgent).substring(0, 32)
    };
    
    return btoa(JSON.stringify(fingerprint));
}
```

### 9.5.7 Performance Requirements

**Delivery SLA (t·ª´ System_Feature_Tree_Grok.md 1.4):**
- OTP delivery time: <30 gi√¢y
- Verification success rate: >95%
- Fraud detection accuracy: >90%
- System response time: <3 gi√¢y

**Scalability:**
- Support 20,000 OTP requests/ph√∫t during peak
- Redis TTL management cho memory efficiency
- Auto-scaling SMS/email provider capacity

### 9.5.8 Security Measures

**OTP generation security:**
```python
import secrets
import hashlib

def generate_secure_otp():
    # Use cryptographically secure random
    code = secrets.randbelow(1000000)
    return f"{code:06d}"  # Pad with leading zeros

def hash_otp_for_storage(otp_code, session_id):
    # Hash OTP before storing in Redis
    combined = f"{otp_code}:{session_id}"
    return hashlib.sha256(combined.encode()).hexdigest()
```

**Anti-enumeration measures:**
- Constant-time comparison cho OTP validation
- No difference trong response time between valid/invalid codes
- Rate limiting applies even for valid attempts
- Log all verification attempts cho fraud analysis

### 9.5.9 Monitoring v√† Alerting

**Key metrics to monitor:**
```yaml
otp_metrics:
  delivery_rate:
    sms_success_rate: ">95%"
    email_success_rate: ">98%"
    delivery_time_p95: "<30s"
  
  verification_rate:
    first_attempt_success: ">85%"
    overall_success_rate: ">95%"
    
  fraud_detection:
    blocked_attempts_ratio: "<5%"
    false_positive_rate: "<1%"
    
  system_health:
    redis_availability: ">99.9%"
    provider_uptime: ">99.5%"
```

**Alerting rules:**
- SMS delivery rate <90% ‚Üí Alert SMS team
- Fraud detection spike >10% ‚Üí Alert security team
- OTP delivery time >60s ‚Üí Alert infrastructure team

### 9.5.10 Postconditions
- User successfully verified v·ªõi valid phone/email
- Session marked as verified trong database
- User_token generated cho next step
- Fraud score calculated v√† stored
- Analytics events logged
- Rate limiting counters updated

### 9.5.11 Special Requirements
- **Zero false positives** cho legitimate users
- **Fraud rate <5%** requirement
- **GDPR compliance** cho data retention
- **Telco compliance** cho SMS regulations

---

## 9.6 UC-005: C·∫•p ph√°t v√† qu·∫£n l√Ω voucher

### 9.6.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: System t·ª± ƒë·ªông g√°n barcode t·ª´ available pool cho user ƒë√£ verified, v·ªõi personalization d·ª±a tr√™n preferences v√† support mobile wallet integration.

**Ph·∫°m vi**: Barcode assignment t·ª´ pool ƒë·∫øn user delivery
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)
**Stakeholder**: End users, Brands

### 9.6.2 Preconditions
- User ƒë√£ verify OTP th√†nh c√¥ng (UC-004)
- User_token h·ª£p l·ªá v√† ch∆∞a expired
- Campaign c√≥ available barcodes trong pool
- Barcode pool ch∆∞a exhausted
- Mobile wallet services (Apple Wallet/Google Pay) available

### 9.6.3 Main Success Scenario

1. **Receive barcode assignment request**
   - User redirect t·ª´ OTP verification v·ªõi user_token
   - System validate user_token (signature, expiration)
   - Extract campaign_id, user_preferences t·ª´ token
   - Check campaign status (still active, not expired)

2. **Select optimal barcode t·ª´ pool**
   - Query available barcodes trong campaign pool
   - Apply personalization logic:
     * Match product variant v·ªõi user preferences
     * Consider location proximity cho redemption
     * Check expiry dates (prioritize shorter expiry)
     * Apply any business rules (VIP users, etc.)

3. **Atomic barcode assignment**
   - Begin database transaction
   - Lock selected barcode row
   - Update status: Available ‚Üí Assigned
   - Store assignment metadata:
     * assigned_to_user_hash (SHA-256 c·ªßa phone/email)
     * assigned_at timestamp
     * assignment_campaign_id
     * user_preferences_snapshot
   - Commit transaction

4. **Generate delivery assets**
   - Create QR code image (PNG, 300x300px)
   - Generate PDF voucher v·ªõi branding
   - Create Apple Wallet pass (.pkpass file)
   - Generate Google Pay pass URL
   - Prepare redemption instructions

5. **Deliver barcode ƒë·∫øn user**
   - Primary method: Display trong browser v·ªõi QR code
   - Secondary: SMS v·ªõi download link
   - Optional: Email v·ªõi PDF attachment
   - Mobile wallet: Show "Add to Wallet" buttons
   - Link ƒë·∫øn User Portal cho future access

6. **Update analytics v√† notifications**
   - Track event: "barcode_assigned"
   - Update campaign metrics (assigned_codes count)
   - Send success notification ƒë·∫øn user
   - Queue background jobs (CRM sync, analytics processing)

### 9.6.4 Alternative Flows

**A1: No available barcodes**
- 2a. N·∫øu campaign pool exhausted:
  - Check other campaigns t·ª´ same brand
  - Show waitlist signup option
  - Offer alternative products/campaigns
  - Notify brand v·ªÅ inventory shortage

**A2: Personalization engine kh√¥ng t√¨m ƒë∆∞·ª£c match**
- 2b. N·∫øu kh√¥ng c√≥ barcode match user preferences:
  - Fall back sang random assignment t·ª´ available pool
  - Log mismatch cho future optimization
  - Continue normal flow

**A3: User ƒë√£ receive barcode cho campaign n√†y**
- 1a. N·∫øu detect duplicate assignment:
  - Check existing assignment status
  - If still valid: Redirect ƒë·∫øn existing barcode display
  - If expired: Allow new assignment
  - If redeemed: Show completion message

**A4: Mobile wallet generation failed**
- 4a. N·∫øu Apple Wallet/Google Pay API failed:
  - Continue v·ªõi QR code v√† PDF
  - Show message: "Mobile wallet t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng"
  - Provide manual add instructions

### 9.6.5 Exception Flows

**E1: Database transaction failed**
- N·∫øu assignment transaction failed:
  - Rollback transaction
  - Log error details cho investigation
  - Retry v·ªõi different barcode (up to 3 times)
  - If all retries failed: Show error page v·ªõi support contact

**E2: QR code generation service down**
- N·∫øu QR generation failed:
  - Fall back sang text-based barcode display
  - Queue QR generation job cho later processing
  - Email QR code khi ready

### 9.6.6 Personalization Algorithm

**Barcode selection logic:**
```python
class BarcodePersonalization:
    def select_optimal_barcode(self, user_preferences, available_barcodes):
        scored_barcodes = []
        
        for barcode in available_barcodes:
            score = 0
            
            # Product category matching (0-40 points)
            if barcode.product_category in user_preferences.get('categories', []):
                score += 40
            
            # Location proximity (0-20 points)
            user_location = user_preferences.get('city')
            if barcode.preferred_locations and user_location:
                if user_location in barcode.preferred_locations:
                    score += 20
            
            # Expiry urgency (0-15 points)
            days_to_expiry = (barcode.expires_at - datetime.now()).days
            if days_to_expiry <= 30:
                score += 15  # Prioritize soon-to-expire items
            elif days_to_expiry <= 60:
                score += 10
            
            # Dietary restrictions (0-25 points)
            user_restrictions = user_preferences.get('dietary_restrictions', [])
            if not any(restriction in barcode.ingredients for restriction in user_restrictions):
                score += 25
            
            scored_barcodes.append((barcode, score))
        
        # Sort by score descending, return top match
        scored_barcodes.sort(key=lambda x: x[1], reverse=True)
        return scored_barcodes[0][0] if scored_barcodes else None
```

### 9.6.7 Mobile Wallet Integration

**Apple Wallet Pass Generation:**
```python
import passbook

def create_apple_wallet_pass(barcode_data, user_info):
    # Create pass structure
    pass_info = {
        'passTypeIdentifier': 'pass.com.productsampling.voucher',
        'serialNumber': barcode_data.barcode_id,
        'teamIdentifier': 'TEAM_ID',
        'organizationName': barcode_data.brand_name,
        'description': f'Voucher cho {barcode_data.product_name}',
        'formatVersion': 1,
        'backgroundColor': 'rgb(60, 165, 255)',
        'foregroundColor': 'rgb(255, 255, 255)',
        'barcode': {
            'format': 'PKBarcodeFormatQR',
            'message': barcode_data.barcode_value,
            'messageEncoding': 'iso-8859-1'
        },
        'generic': {
            'primaryFields': [{
                'key': 'product',
                'label': 'S·∫£n ph·∫©m',
                'value': barcode_data.product_name
            }],
            'secondaryFields': [{
                'key': 'expires',
                'label': 'H·∫øt h·∫°n',
                'value': barcode_data.expires_at.strftime('%d/%m/%Y')
            }],
            'auxiliaryFields': [{
                'key': 'instructions',
                'label': 'H∆∞·ªõng d·∫´n',
                'value': 'Qu√©t m√£ t·∫°i c·ª≠a h√†ng ƒë·ªÉ nh·∫≠n qu√†'
            }]
        },
        'locations': [
            {
                'latitude': location.latitude,
                'longitude': location.longitude,
                'relevantText': f'ƒê·ªïi qu√† t·∫°i {location.name}'
            } for location in barcode_data.redemption_locations
        ]
    }
    
    # Generate signed .pkpass file
    pass_file = passbook.Pass(pass_info, key='private_key.pem', cert='certificate.pem')
    return pass_file.create()
```

**Google Pay Integration:**
```python
def create_google_pay_pass(barcode_data):
    pass_object = {
        'kind': 'walletobjects#genericObject',
        'id': f'voucher_{barcode_data.barcode_id}',
        'classId': 'ISSUER_ID.voucher_class',
        'genericType': 'GENERIC_TYPE_UNSPECIFIED',
        'hexBackgroundColor': '#3CA5FF',
        'logo': {
            'sourceUri': {
                'uri': 'https://brand.com/logo.png'
            }
        },
        'cardTitle': {
            'defaultValue': {
                'language': 'vi',
                'value': barcode_data.product_name
            }
        },
        'subheader': {
            'defaultValue': {
                'language': 'vi', 
                'value': 'Voucher d√πng th·ª≠'
            }
        },
        'header': {
            'defaultValue': {
                'language': 'vi',
                'value': barcode_data.brand_name
            }
        },
        'barcode': {
            'type': 'QR_CODE',
            'value': barcode_data.barcode_value
        },
        'heroImage': {
            'sourceUri': {
                'uri': barcode_data.product_image_url
            }
        }
    }
    
    return generate_google_pay_url(pass_object)
```

### 9.6.8 User Portal Integration

**Redirect ƒë·∫øn User Portal:**
```javascript
// After successful barcode assignment
function redirectToUserPortal(barcode_data) {
    const portal_url = `https://portal.productsampling.com/dashboard`;
    const params = new URLSearchParams({
        barcode_id: barcode_data.barcode_id,
        first_time: 'true',
        source: 'assignment'
    });
    
    // Store barcode info trong localStorage cho offline access
    localStorage.setItem('latest_barcode', JSON.stringify({
        barcode_id: barcode_data.barcode_id,
        product_name: barcode_data.product_name,
        expires_at: barcode_data.expires_at,
        qr_code_url: barcode_data.qr_code_url
    }));
    
    window.location.href = `${portal_url}?${params.toString()}`;
}
```

### 9.6.9 Performance Requirements

**Assignment SLA (t·ª´ System_Feature_Tree_Grok.md 1.5):**
- Assignment time: <2 gi√¢y post-verification
- QR generation: <5 gi√¢y
- Mobile wallet generation: <10 gi√¢y
- 100% barcode uniqueness guarantee

**Concurrency handling:**
- Handle 1000 simultaneous assignments
- Optimistic locking cho barcode selection
- Retry logic cho race conditions
- Queue overflow protection

### 9.6.10 Analytics v√† Tracking

**Assignment metrics:**
```python
def track_assignment_analytics(barcode_data, user_data, assignment_context):
    analytics_event = {
        'event_type': 'barcode_assigned',
        'timestamp': datetime.now().isoformat(),
        'campaign_id': barcode_data.campaign_id,
        'barcode_id': barcode_data.barcode_id,
        'user_id_hash': hashlib.sha256(user_data.phone.encode()).hexdigest(),
        'assignment_method': assignment_context.method,  # 'automatic', 'manual', 'waitlist'
        'personalization_score': assignment_context.personalization_score,
        'time_from_verification': assignment_context.verification_delay_seconds,
        'delivery_methods': assignment_context.delivery_methods,  # ['qr', 'sms', 'email', 'wallet']
        'location_context': {
            'user_city': user_data.city,
            'nearest_redemption_location': barcode_data.nearest_location,
            'distance_km': barcode_data.distance_to_nearest
        }
    }
    
    # Send to analytics pipeline
    send_to_analytics_pipeline(analytics_event)
    
    # Update campaign metrics
    update_campaign_metrics(barcode_data.campaign_id, {
        'total_assignments': '+1',
        'assignments_today': '+1',
        'personalization_success_rate': calculate_personalization_success_rate()
    })
```

### 9.6.11 Postconditions
- Barcode status updated: Available ‚Üí Assigned
- User receives barcode qua multiple channels
- Assignment logged trong audit trail
- Campaign metrics updated
- User Portal session initialized
- Mobile wallet passes generated (if requested)
- Analytics events tracked
- CRM sync queued

### 9.6.12 Special Requirements
- **Atomicity**: Zero double-assignment guarantee
- **Personalization**: >80% user satisfaction v·ªõi matches
- **Mobile-first**: PWA-optimized delivery experience
- **Offline support**: QR codes work without internet

---

## 9.7 UC-006: ƒê·ªïi qu√† t·∫°i ƒëi·ªÉm b√°n

### 9.7.1 M√¥ t·∫£ Use Case
**M·ª•c ti√™u**: Serving Account (staff) t·∫°i retail location scan barcode c·ªßa customer ƒë·ªÉ validate v√† complete redemption process v·ªõi offline capability.

**Ph·∫°m vi**: POS redemption t·ª´ scan ƒë·∫øn completion
**M·ª©c ƒë·ªô**: Ch·ª©c nƒÉng ch√≠nh (primary)
**Stakeholder**: Store staff, End users, Retail partners

### 9.7.2 Preconditions
- Serving Account ƒë√£ login v·ªõi POS access permissions
- Barcode status = "Assigned" v√† ch∆∞a expired
- Staff c√≥ device v·ªõi camera ho·∫∑c barcode scanner
- Location c√≥ POS integration setup
- Customer present t·∫°i store v·ªõi barcode

### 9.7.3 Main Success Scenario

1. **Staff chu·∫©n b·ªã redemption**
   - Login v√†o POS tool ho·∫∑c web interface
   - Select location (auto-detect ho·∫∑c manual)
   - Verify staff_id v√† shift information
   - Load redemption interface

2. **Scan customer barcode**
   - Customer show barcode (QR code, Apple Wallet, printed voucher)
   - Staff scan b·∫±ng camera app ho·∫∑c barcode scanner
   - System capture barcode_value v√† timestamp
   - Validate barcode format (alphanumeric, length)

3. **Validate barcode eligibility**
   - System lookup barcode trong database
   - Check barcode status (must be "Assigned")
   - Verify expiry date (ch∆∞a expired)
   - Confirm location permissions (store c√≥ th·ªÉ redeem n√†y kh√¥ng)
   - Check business hours restrictions

4. **Display redemption preview**
   - Show product information:
     * Product name v√† description
     * Brand information
     * Campaign name
     * Assigned user (masked): "+84***123456"
     * Expiry date
   - Show redemption confirmation screen
   - Provide "Confirm Redemption" button

5. **Complete redemption process**
   - Staff confirm redemption
   - System begin atomic transaction:
     * Update barcode status: Assigned ‚Üí Redeemed
     * Record redemption details (timestamp, location, staff)
     * Update campaign statistics
     * Generate receipt/confirmation
   - Commit transaction

6. **Provide confirmation**
   - Show success message v·ªõi receipt number
   - Display redemption summary
   - Option: Print receipt (if printer available)
   - Update staff dashboard statistics
   - Send confirmation ƒë·∫øn customer (if contact available)

### 9.7.4 Alternative Flows

**A1: Invalid barcode**
- 3a. N·∫øu barcode kh√¥ng t·ªìn t·∫°i:
  - Show error: "M√£ barcode kh√¥ng h·ª£p l·ªá"
  - Suggest re-scan ho·∫∑c manual entry
  - Option: Report counterfeit barcode
  - Log suspicious activity

**A2: Already redeemed barcode**
- 3b. N·∫øu barcode ƒë√£ redeemed:
  - Show error: "M√£ n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng"
  - Display previous redemption info:
    * Redeemed date/time
    * Location name
    * Staff who processed
  - Option: Contact support n·∫øu customer khi·∫øu n·∫°i

**A3: Expired barcode**
- 3c. N·∫øu barcode ƒë√£ expired:
  - Show error: "M√£ ƒë√£ h·∫øt h·∫°n v√†o [date]"
  - Check if expiry extension possible
  - Contact manager approval n·∫øu c·∫ßn
  - Document exception n·∫øu approved

**A4: Location restriction**
- 3d. N·∫øu barcode kh√¥ng th·ªÉ redeem t·∫°i location n√†y:
  - Show error: "M√£ n√†y ch·ªâ c√≥ th·ªÉ ƒë·ªïi t·∫°i: [location_list]"
  - Provide directions ƒë·∫øn valid locations
  - Option: Manager override v·ªõi reason

**A5: Network connectivity issues**
- N·∫øu device offline:
  - Switch sang offline mode
  - Store redemption locally (IndexedDB)
  - Show "Offline - will sync when connected"
  - Process redemption based on local cache
  - Auto-sync khi connection restored

### 9.7.5 Exception Flows

**E1: Database unavailable**
- N·∫øu central database down:
  - Fall back sang local verification
  - Use cached valid barcode list
  - Mark redemption as "pending_sync"
  - Queue for reconciliation later

**E2: Barcode scanner malfunction**
- N·∫øu camera/scanner kh√¥ng work:
  - Allow manual barcode entry
  - Implement extra validation (checksum)
  - Log manual entries cho audit
  - Alert IT support v·ªÅ hardware issue

### 9.7.6 Offline Capability

**Local storage strategy:**
```javascript
// IndexedDB schema cho offline redemptions
const offlineSchema = {
  stores: ['redemptions', 'valid_barcodes', 'sync_queue'],
  redemptions: {
    keyPath: 'redemption_id',
    indexes: ['barcode_value', 'timestamp', 'sync_status']
  },
  valid_barcodes: {
    keyPath: 'barcode_value', 
    indexes: ['campaign_id', 'expires_at', 'status']
  }
};

// Offline redemption process
class OfflineRedemption {
  async processRedemption(barcode_value, staff_id, location_id) {
    // Check local valid barcode cache
    const barcode = await this.lookupLocalBarcode(barcode_value);
    if (!barcode || barcode.status !== 'assigned') {
      throw new Error('Invalid barcode or already used');
    }
    
    // Create offline redemption record
    const redemption = {
      redemption_id: this.generateOfflineId(),
      barcode_value: barcode_value,
      staff_id: staff_id,
      location_id: location_id,
      timestamp: new Date().toISOString(),
      sync_status: 'pending',
      offline_processed: true
    };
    
    // Store locally
    await this.storeOfflineRedemption(redemption);
    
    // Update local barcode status
    await this.updateLocalBarcodeStatus(barcode_value, 'redeemed');
    
    return redemption;
  }
  
  async syncWhenOnline() {
    const pending = await this.getPendingRedemptions();
    for (const redemption of pending) {
      try {
        await this.syncRedemptionToServer(redemption);
        await this.markAsSynced(redemption.redemption_id);
      } catch (error) {
        // Handle sync conflicts
        await this.handleSyncConflict(redemption, error);
      }
    }
  }
}
```

### 9.7.7 POS Integration Variants

**Web-based POS tool:**
- Responsive web app works on tablets/phones
- Barcode scanning via camera API
- Works v·ªõi or without dedicated scanner hardware
- Real-time sync v·ªõi central database

**API integration v·ªõi existing POS systems:**
```python
# Circle K POS Integration
class CircleKPOSAdapter:
    def __init__(self, api_endpoint, api_key):
        self.endpoint = api_endpoint
        self.api_key = api_key
    
    def validate_redemption(self, barcode, store_id):
        # Call Circle K validation API
        response = requests.post(f"{self.endpoint}/validate", {
            'barcode': barcode,
            'store_id': store_id,
            'api_key': self.api_key
        })
        return response.json()
    
    def complete_redemption(self, barcode, transaction_id):
        # Mark as redeemed trong Circle K system
        response = requests.post(f"{self.endpoint}/redeem", {
            'barcode': barcode,
            'transaction_id': transaction_id,
            'api_key': self.api_key
        })
        return response.json()

# GS25 POS Integration  
class GS25POSAdapter:
    def process_redemption(self, barcode_data):
        # Different API structure for GS25
        # Handle format differences v√† error codes
        pass
```

### 9.7.8 Fraud Prevention

**Redemption validation rules:**
```python
class RedemptionValidator:
    def validate_redemption(self, barcode, location, staff, timestamp):
        checks = []
        
        # Time-based validation
        if self.is_outside_business_hours(location, timestamp):
            checks.append("Redemption outside business hours")
        
        # Location validation
        if not self.is_valid_location_for_barcode(barcode, location):
            checks.append("Invalid location for this barcode")
        
        # Staff validation
        if not self.is_staff_authorized(staff, location):
            checks.append("Staff not authorized for this location")
        
        # Velocity checks
        if self.detect_rapid_redemptions(staff, timestamp):
            checks.append("Suspicious redemption velocity")
        
        # Geographic impossibility
        if self.detect_impossible_travel(barcode.last_activity, location, timestamp):
            checks.append("Impossible travel between activities")
        
        return len(checks) == 0, checks
```

### 9.7.9 Receipt v√† Confirmation

**Receipt template:**
```
=================================
    [BRAND LOGO]
=================================
VOUCHER REDEMPTION RECEIPT

Product: [PRODUCT_NAME]
Campaign: [CAMPAIGN_NAME]
Barcode: [BARCODE_VALUE]

Redeemed at: [LOCATION_NAME]
Address: [LOCATION_ADDRESS]
Date: [DATE] [TIME]
Staff: [STAFF_NAME]

Receipt #: [RECEIPT_NUMBER]

Thank you for participating!
Visit: portal.productsampling.com
for more offers.
=================================
```

**Digital confirmation:**
```python
def send_redemption_confirmation(redemption_data):
    # SMS confirmation
    if redemption_data.user_phone:
        message = f"B·∫°n ƒë√£ ƒë·ªïi th√†nh c√¥ng {redemption_data.product_name} t·∫°i {redemption_data.location_name}. C·∫£m ∆°n b·∫°n ƒë√£ tham gia!"
        send_sms(redemption_data.user_phone, message)
    
    # Email confirmation v·ªõi receipt
    if redemption_data.user_email:
        send_email_receipt(redemption_data.user_email, redemption_data)
    
    # User Portal notification
    create_portal_notification(redemption_data.user_id, {
        'type': 'redemption_success',
        'product_name': redemption_data.product_name,
        'location': redemption_data.location_name,
        'timestamp': redemption_data.timestamp
    })
```

### 9.7.10 Performance Requirements

**Redemption SLA (t·ª´ System_Feature_Tree_Grok.md 1.5):**
- Scan validation: <3 gi√¢y
- Redemption completion: <5 gi√¢y total
- Offline sync: 24-hour capability
- Success rate: >98%

**Concurrent redemptions:**
- Support 100 simultaneous redemptions per location
- Handle peak times (lunch hours, weekends)
- Queue management cho high traffic

### 9.7.11 Analytics v√† Reporting

**Real-time redemption tracking:**
```python
def track_redemption_analytics(redemption_data):
    analytics_event = {
        'event_type': 'redemption_completed',
        'timestamp': redemption_data.timestamp,
        'campaign_id': redemption_data.campaign_id,
        'location_id': redemption_data.location_id,
        'staff_id': redemption_data.staff_id,
        'processing_time_seconds': redemption_data.processing_time,
        'redemption_method': redemption_data.method,  # 'scan', 'manual_entry'
        'offline_processed': redemption_data.offline,
        'time_from_assignment_hours': redemption_data.assignment_delay,
        'day_of_week': redemption_data.timestamp.strftime('%A'),
        'hour_of_day': redemption_data.timestamp.hour
    }
    
    # Update real-time dashboards
    update_location_dashboard(redemption_data.location_id, analytics_event)
    update_campaign_dashboard(redemption_data.campaign_id, analytics_event)
    
    # Send to data warehouse
    send_to_analytics_pipeline(analytics_event)
```

### 9.7.12 Postconditions
- Barcode status updated: Assigned ‚Üí Redeemed
- Redemption record created v·ªõi audit trail
- Campaign statistics updated
- Customer confirmation sent
- Receipt generated
- Staff dashboard updated
- Analytics events tracked
- Inventory adjustments (if applicable)

### 9.7.13 Special Requirements
- **Offline capability**: 24-hour operation without internet
- **Audit compliance**: Immutable redemption logs
- **Real-time sync**: <5 minute delay cho online operations
- **Multi-location support**: Staff c√≥ th·ªÉ work t·∫°i multiple stores

---

**Ngu·ªìn tham kh·∫£o ch√≠nh:**
- System Feature Tree (System_Feature_Tree_Grok.md v4.0) - User stories, flow v·∫≠n h√†nh, KPI requirements
- Access Control Tree (Access_Control_Tree_Grok.md v2.2) - Role permissions, security requirements  
- Business Requirement Document (01-BRD.md v3.0) - Performance targets, SLA requirements
- Problem Definition (Problem.md v1.0) - Business context, technical constraints

**T√¨nh tr·∫°ng**: Part09 ƒëang ho√†n th√†nh ‚úÖ (UC-001 ƒë·∫øn UC-006 complete)  
**Ti·∫øp theo**: UC-007 v√† UC-008  
**Ng∆∞·ªùi ƒë√°nh gi√°**: Business Analyst, UX Designer, QA Lead
